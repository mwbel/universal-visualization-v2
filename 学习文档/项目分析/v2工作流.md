
  8ï¸âƒ£ å·¥ä½œæµæ€»ç»“

  å®Œæ•´çš„8ä¸ªé˜¶æ®µï¼š

  1. ç”¨æˆ·è¾“å…¥ â†’ æ–‡æœ¬éªŒè¯ + å‰ç«¯çŠ¶æ€ç®¡ç†
  2. APIæ¥æ”¶ â†’ PydanticéªŒè¯ + ä»»åŠ¡IDç”Ÿæˆ +
  åå°è°ƒåº¦
  3. æ™ºèƒ½åˆ†ç±» â†’ å…³é”®è¯åŒ¹é… â†’ å­¦ç§‘è¯†åˆ«
  4. Agentåˆ†å‘ â†’ è·å–å¯¹åº”å­¦ç§‘Agent
  5. éœ€æ±‚è§£æ â†’ ç»“æ„åŒ–éœ€æ±‚åˆ†æ
  6. æ¨¡æ¿åŒ¹é… â†’ å¤šçº§åŒ¹é…æœºåˆ¶ + åå¤‡æ¨¡æ¿
  7. å¯è§†åŒ–ç”Ÿæˆ â†’ æ•°æ®ç”Ÿæˆ + æ¨¡æ¿æ¸²æŸ“ +
  HTMLè¾“å‡º
  8. ç»“æœè¿”å› â†’ çŠ¶æ€è½®è¯¢ + å‰ç«¯å±•ç¤º

  å…³é”®è®¾è®¡ç‰¹ç‚¹ï¼š

  - å¼‚æ­¥å¤„ç†: FastAPI BackgroundTasksé¿å…é˜»å¡
  - æ™ºèƒ½è·¯ç”±: è‡ªåŠ¨å­¦ç§‘è¯†åˆ«å’ŒAgenté€‰æ‹©
  - åå¤‡æœºåˆ¶: å¤šé‡åå¤‡ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§
  - çŠ¶æ€ç®¡ç†: å†…å­˜çŠ¶æ€è·Ÿè¸ª + è½®è¯¢æœºåˆ¶
  - æ¨¡æ¿å¼•æ“: Jinja2æ¸²æŸ“ + é”™è¯¯å¤„ç†

  è¿™å°±æ˜¯ä¸‡ç‰©å¯è§†åŒ–çš„å®Œæ•´å·¥ä½œæµï¼æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ¸…
  æ™°çš„èŒè´£åˆ†å·¥å’Œé”™è¯¯å¤„ç†æœºåˆ¶ã€‚


===
ğŸ“‹ ä¸‡ç‰©å¯è§†åŒ–å®Œæ•´å·¥ä½œæµè¯¦è§£

  åŸºäºä»£ç åˆ†æï¼Œæˆ‘æ¥ä¸ºä½ è¯¦ç»†è§£æä¸‡ç‰©å¯è§†åŒ–çš„å®Œ
  æ•´å·¥ä½œæµç¨‹ï¼š

  ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹å›¾

  ç”¨æˆ·è¾“å…¥ â†’ å‰ç«¯å¤„ç† â†’ APIç½‘å…³ â†’ æ™ºèƒ½è·¯ç”± â†’
  Agentå¤„ç† â†’ æ¨¡æ¿åŒ¹é… â†’ å¯è§†åŒ–ç”Ÿæˆ â†’ ç»“æœè¿”å›
     â†“         â†“        â†“        â†“        â†“
       â†“          â†“          â†“
    æ–‡æœ¬è¾“å…¥   JSéªŒè¯   FastAPI   å­¦ç§‘åˆ†ç±»
  éœ€æ±‚è§£æ   æ¨¡æ¿æœç´¢   HTMLæ¸²æŸ“   å‰ç«¯å±•ç¤º

  1ï¸âƒ£ å‰ç«¯è¾“å…¥å¤„ç†é˜¶æ®µ

  ä½ç½®: frontend-v2/js/app.js:301-349

  // ç”¨æˆ·è¾“å…¥å¤„ç†
  async generateVisualization() {
      const prompt =
  Elements.visualizationInput?.value.trim();

      // 1. è¾“å…¥éªŒè¯
      if (!prompt) {
          this.showMessage('è¯·è¾“å…¥å¯è§†åŒ–æè¿°',
  'warning');
          return;
      }

      // 2. çŠ¶æ€ç®¡ç†
      AppState.isGenerating = true;
      this.showLoading();

      // 3. APIè°ƒç”¨
      const response = await
  window.APIService?.generateVisualization({
          prompt: prompt,
          template_id:
  AppState.selectedTemplate,  // å¯é€‰æŒ‡å®šæ¨¡æ¿
          user_preferences:
  AppState.preferences
      });

      // 4. è½®è¯¢çŠ¶æ€
      await this.pollGenerationStatus(response.
  generation_id, prompt);
  }

  å…³é”®ç‚¹ï¼š
  - è¾“å…¥é•¿åº¦é™åˆ¶ï¼š5000å­—ç¬¦
  - æ”¯æŒå¯é€‰æ¨¡æ¿æŒ‡å®š
  - å¼‚æ­¥è½®è¯¢æœºåˆ¶è·å–ç»“æœ

  2ï¸âƒ£ APIç½‘å…³æ¥æ”¶é˜¶æ®µ

  ä½ç½®: backend-v2/main.py:115-156

  @app.post("/api/v2/generate")
  async def universal_generate(request: 
  UniversalVisualizationRequest, 
  background_tasks: BackgroundTasks):
      # 1. ç”Ÿæˆå”¯ä¸€ä»»åŠ¡ID
      generation_id = str(uuid.uuid4())

      # 2. åˆå§‹åŒ–çŠ¶æ€
      state.active_generations[generation_id] =
   {
          "status": "initializing",
          "created_at":
  datetime.datetime.now(),
          "prompt": request.prompt,
          "progress": 0
      }

      # 3. åå°ä»»åŠ¡è°ƒåº¦ï¼ˆå…³é”®ï¼ï¼‰
      background_tasks.add_task(
          process_visualization_generation,
          generation_id,
          request.prompt,
          request.user_preferences or {},
          request.template_id,  # 
  ç”¨æˆ·æŒ‡å®šçš„æ¨¡æ¿ID
          request.parameters or {}
      )

      # 4. ç«‹å³è¿”å›ä»»åŠ¡ID
      return GenerationResponse(generation_id=g
  eneration_id, status="processing")

  å…³é”®ç‚¹ï¼š
  - ä½¿ç”¨FastAPIçš„BackgroundTaskså®ç°å¼‚æ­¥å¤„ç†
  - ç«‹å³è¿”å›generation_idï¼Œä¸é˜»å¡å‰ç«¯
  - å†…å­˜çŠ¶æ€ç®¡ç†ï¼ˆAppStateï¼‰

  3ï¸âƒ£ æ™ºèƒ½è·¯ç”±åˆ†å‘é˜¶æ®µ

  ä½ç½®:
  backend-v2/agents/router_manager.py:220-295

  async def route_request(self, prompt: str, 
  user_preferences: Dict = None):
      # 1. å­¦ç§‘æ™ºèƒ½åˆ†ç±»
      subject = await
  self.subject_classifier.classify(prompt)
      print(f"ğŸ“š è¯†åˆ«å­¦ç§‘: {subject}")

      # 2. è·å–å¯¹åº”Agent
      agent = self.agents.get(subject)
      if not agent:
          agent = self.agents["mathematics"]  #
   åå¤‡æœºåˆ¶

      # 3. éœ€æ±‚è§£æ
      requirement = await
  agent.parse_requirement(prompt)

      # 4. æ¨¡æ¿åŒ¹é…
      template = await
  agent.match_template(requirement)
      if not template:
          template = {"id": "default", "name":
  "é»˜è®¤æ¨¡æ¿"}  # åå¤‡æ¨¡æ¿

      # 5. é…ç½®ç”Ÿæˆ
      config = await
  agent.generate_config(requirement, template,
  user_preferences)

      # 6. å¯è§†åŒ–ç”Ÿæˆ
      html_content = await
  agent.generate_visualization(config)

      return {
          "subject": subject,
          "html_content": html_content,
          "template": template,
          "config": config
      }

  å…³é”®ç‚¹ï¼š
  - æ™ºèƒ½å­¦ç§‘åˆ†ç±»ï¼šåŸºäºå…³é”®è¯åŒ¹é…
  - Agentç³»ç»Ÿï¼šæ¯ä¸ªå­¦ç§‘æœ‰ä¸“é—¨çš„Agent
  - åŒé‡åå¤‡æœºåˆ¶ï¼šå­¦ç§‘åå¤‡+æ¨¡æ¿åå¤‡

  4ï¸âƒ£ å­¦ç§‘åˆ†ç±»è¯¦ç»†æœºåˆ¶

  ä½ç½®:
  backend-v2/agents/router_manager.py:130-174

  class SubjectClassifier:
      def __init__(self):
          self.subject_keywords = {
              "mathematics": ["å‡½æ•°", "å›¾åƒ",
  "æ–¹ç¨‹", "å‡ ä½•", "ä»£æ•°", "æ¦‚ç‡", "ç»Ÿè®¡",
  "å¾®ç§¯åˆ†"],
              "astronomy": ["å¤©ä½“", "æ˜Ÿçƒ",
  "è½¨é“", "æ˜Ÿç³»", "å®‡å®™", "è¡Œæ˜Ÿ", "æ’æ˜Ÿ",
  "é»‘æ´"],
              "physics": ["åŠ›å­¦", "è¿åŠ¨",
  "èƒ½é‡", "æ³¢åŠ¨", "å…‰å­¦", "ç”µç£", "é‡å­",
  "ç›¸å¯¹è®º"]
          }

      async def classify(self, prompt: str) -> 
  str:
          scores = {}
          for subject, keywords in
  self.subject_keywords.items():
              score = sum(1 for keyword in
  keywords if keyword in prompt)
              scores[subject] = score

          # è¿”å›å¾—åˆ†æœ€é«˜çš„å­¦ç§‘
          best_subject = max(scores.items(),
  key=lambda x: x[1])
          return best_subject[0] if
  best_subject[1] > 0 else "general"

  ç¤ºä¾‹ï¼š
  - è¾“å…¥ï¼š"ç”»ä¸€ä¸ªç®€å•çš„æ­£å¼¦å‡½æ•°å›¾åƒ"
  - åˆ†æï¼šåŒ¹é…"å‡½æ•°"(mathematics) +
  "å‡½æ•°å›¾åƒ"(mathematics)
  - ç»“æœï¼šmathematics (2åˆ†)

  5ï¸âƒ£ æ¨¡æ¿åŒ¹é…æœºåˆ¶

  ä½ç½®: backend-v2/agents/mathematics_agent.py:
  190-212

  async def match_template(self, requirement: 
  Dict[str, Any]) -> Optional[Dict[str, Any]]:
      concept_type =
  requirement.get("concept_type")

      # 1. ç²¾ç¡®åŒ¹é…
      if concept_type == "normal_distribution":
          return self.templates.get("normal")
      elif concept_type ==
  "binomial_distribution":
          return self.templates.get("binomial")

      # 2. é€šç”¨åŒ¹é…
      elif concept_type == "function_plotting":
          return self.templates.get("function")

      # 3. åå¤‡æ¨¡æ¿
      else:
          return
  self.templates.get("default_math", None)

  æ¨¡æ¿ä¼˜å…ˆçº§ï¼š
  1. ç”¨æˆ·æŒ‡å®šæ¨¡æ¿
  2. Agentç²¾ç¡®åŒ¹é…
  3. å­¦ç§‘é€šç”¨æ¨¡æ¿
  4. ç³»ç»Ÿé»˜è®¤æ¨¡æ¿

  6ï¸âƒ£ å¯è§†åŒ–ç”Ÿæˆé˜¶æ®µ

  ä½ç½®: backend-v2/agents/mathematics_agent.py:
  270-298

  async def generate_visualization(self, 
  config: Dict[str, Any]) -> str:
      try:
          # 1. ä¼˜å…ˆä½¿ç”¨æ¨¡æ¿å¼•æ“
          if hasattr(self, 'template_engine')
  and self.template_engine:
              template_id =
  config.get("template_id", "default")

              # å‡†å¤‡æ¸²æŸ“æ•°æ®
              render_config = {
                  "title": config.get("title",
  "æ•°å­¦å¯è§†åŒ–"),
                  "parameters":
  config.get("parameters", {}),
                  "data": await
  self._generate_math_data(config),
                  "plotly_config": await
  self._generate_plotly_config(...),
                  "timestamp":
  datetime.datetime.now().strftime("%Y-%m-%d 
  %H:%M:%S")
              }

              # æ¨¡æ¿æ¸²æŸ“
              html_content = await self.templat
  e_engine.render_template(template_id,
  render_config)

              if html_content and
  html_content.strip():
                  return html_content

          # 2. å›é€€åˆ°ä¼ ç»Ÿæ–¹å¼
          return await
  self._generate_legacy_visualization(config)

      except Exception as e:
          raise
  VisualizationError(f"å¯è§†åŒ–ç”Ÿæˆå¤±è´¥: 
  {str(e)}")

  7ï¸âƒ£ çŠ¶æ€è½®è¯¢å’Œç»“æœè¿”å›

  å‰ç«¯è½®è¯¢: frontend-v2/js/app.js:400-450

  async pollGenerationStatus(generationId, 
  prompt) {
      const maxAttempts = 30;
      let attempts = 0;

      while (attempts < maxAttempts) {
          try {
              const status = await window.APISe
  rvice?.getGenerationStatus(generationId);

              if (status.status ===
  'completed') {
                  // è·å–å¯è§†åŒ–ç»“æœ
                  const htmlResponse = await
  window.APIService?.getVisualization(status.ht
  ml_url);

  this.displayVisualization(htmlResponse);
                  return;
              } else if (status.status ===
  'failed') {
                  throw new
  Error(status.error);
              }

              // ç»§ç»­è½®è¯¢
              await new Promise(resolve =>
  setTimeout(resolve, 2000));
              attempts++;
          } catch (error) {
              console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:',
  error);
              throw error;
          }
      }
  }

  åç«¯çŠ¶æ€API: backend-v2/main.py:180-200

  @app.get("/api/v2/status/{generation_id}")
  async def 
  get_generation_status(generation_id: str):
      if generation_id not in
  state.active_generations:
          raise HTTPException(status_code=404,
  detail="ç”Ÿæˆä»»åŠ¡æœªæ‰¾åˆ°")

      return
  state.active_generations[generation_id]