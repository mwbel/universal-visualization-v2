# ä¸‡ç‰©å¯è§†åŒ–æ•°æ®æµåˆ†æ

## ğŸ”„ å®Œæ•´æ•°æ®æµç¨‹å›¾

### 1. å‰ç«¯åˆ°åç«¯çš„æ•°æ®æµ

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯(æµè§ˆå™¨)
    participant API as FastAPIåç«¯
    participant Router as è·¯ç”±ç®¡ç†å™¨
    participant Agent as å­¦ç§‘Agent
    participant Template as æ¨¡æ¿å¼•æ“
    participant Storage as çŠ¶æ€å­˜å‚¨

    Note over User,Storage: ğŸ“Š æ•°æ®æµåˆ†æ

    User->>Frontend: 1. è¾“å…¥å¯è§†åŒ–éœ€æ±‚
    Frontend->>Frontend: 2. æ„å»ºè¯·æ±‚æ•°æ®
    Frontend->>API: 3. POST /api/v2/generate

    Note over API,Storage: âš¡ åç«¯å¤„ç†æµç¨‹

    API->>API: 4. ç”Ÿæˆå”¯ä¸€ID
    API->>Storage: 5. è®°å½•åˆå§‹çŠ¶æ€
    API->>Router: 6. åå°ä»»åŠ¡è°ƒåº¦

    Note over Router,Template: ğŸ§  æ™ºèƒ½å¤„ç†æµç¨‹

    Router->>Agent: 7. æ™ºèƒ½å­¦ç§‘è¯†åˆ«
    Agent->>Agent: 8. éœ€æ±‚è§£æ
    Agent->>Template: 9. æ¨¡æ¿åŒ¹é…
    Template->>Template: 10. å¯è§†åŒ–ç”Ÿæˆ
    Template->>Storage: 11. æ›´æ–°çŠ¶æ€

    Note over Storage,User: ğŸ”„ ç»“æœè¿”å›æµç¨‹

    Storage->>API: 12. å®Œæˆé€šçŸ¥
    API->>Frontend: 13. è¿”å›ç”Ÿæˆç»“æœ
    Frontend->>User: 14. æ˜¾ç¤ºå¯è§†åŒ–
```

## ğŸ“Š è¯¦ç»†æ•°æ®å¤„ç†æµç¨‹

### é˜¶æ®µ1ï¼šè¯·æ±‚æ¥æ”¶ (APIå±‚)
```python
# 1. FastAPIæ¥æ”¶è¯·æ±‚
@app.post("/api/v2/generate")
async def universal_generate(request: UniversalVisualizationRequest):
    # 2. æ•°æ®éªŒè¯
    # Pydanticè‡ªåŠ¨éªŒè¯è¯·æ±‚æ•°æ®
    # - prompt: å­—ç¬¦ä¸²ï¼Œ1-5000å­—ç¬¦
    # - template_id: å¯é€‰ï¼Œå­—ç¬¦ä¸²
    # - parameters: å¯é€‰ï¼Œå¯¹è±¡
    # - user_preferences: å¯é€‰ï¼Œå¯¹è±¡

    # 3. ç”Ÿæˆå”¯ä¸€æ ‡è¯†
    generation_id = str(uuid.uuid4())

    # 4. åˆå§‹åŒ–çŠ¶æ€
    state.active_generations[generation_id] = {
        "status": "initializing",
        "prompt": request.prompt,
        "progress": 0
    }

    # 5. å¼‚æ­¥å¤„ç†
    background_tasks.add_task(
        process_visualization_generation,
        generation_id,
        request.prompt,
        ...
    )
```

### é˜¶æ®µ2ï¼šæ™ºèƒ½å¤„ç† (Agentå±‚)
```python
# router_manager.py - æ™ºèƒ½è·¯ç”±ç®¡ç†å™¨
async def process_visualization_generation(
    generation_id: str,
    prompt: str,
    user_preferences: dict,
    template_id: Optional[str],
    parameters: dict
):
    # 1. çŠ¶æ€æ›´æ–°
    state.active_generations[generation_id]["status"] = "processing"

    # 2. å­¦ç§‘åˆ†ç±»åˆ†æ
    # åˆ†æå…³é”®è¯ï¼šå‡½æ•°ã€å›¾åƒã€ç‰©ç†ã€å¤©æ–‡ç­‰
    subject_scores = {
        "mathematics": analyze_math_keywords(prompt),
        "physics": analyze_physics_keywords(prompt),
        "astronomy": analyze_astronomy_keywords(prompt)
    }

    # 3. é€‰æ‹©æœ€é€‚åˆçš„å­¦ç§‘
    selected_subject = max(subject_scores, key=subject_scores.get)

    # 4. è·å–å¯¹åº”çš„Agent
    agent = state.router.get_agent(selected_subject)

    # 5. Agentå¤„ç†
    result = await agent.process_request(
        prompt,
        user_preferences,
        template_id,
        parameters
    )

    # 6. æ›´æ–°æœ€ç»ˆçŠ¶æ€
    state.active_generations[generation_id].update({
        "status": "completed",
        "progress": 100,
        "html_url": f"/api/v2/visualizations/viz_{generation_id[:8]}"
    })
```

### é˜¶æ®µ3ï¼šæ¨¡æ¿å¼•æ“ (Templateå±‚)
```python
# template_engine.py - å¯è§†åŒ–ç”Ÿæˆ
class UnifiedTemplateEngine:
    async def render_template(
        template_id: str,
        context: dict,
        generation_id: str
    ):
        # 1. è·å–æ¨¡æ¿é…ç½®
        template = self.templates[template_id]

        # 2. å‡†å¤‡æ¸²æŸ“æ•°æ®
        render_data = {
            "title": context.get("title", "æœªå‘½åå¯è§†åŒ–"),
            "description": context.get("description", ""),
            "content": self.generate_chart_data(context),
            "generation_id": generation_id
        }

        # 3. Jinja2æ¨¡æ¿æ¸²æŸ“
        html_content = await self.jinja_env.from_string(
            template["html_template"]
        ).render_async(render_data)

        # 4. æ›´æ–°çŠ¶æ€
        state.active_generations[generation_id]["html_content"] = html_content

        return html_content
```

### é˜¶æ®µ4ï¼šç»“æœè¿”å› (å‰ç«¯å±‚)
```javascript
// api-service.js - å‰ç«¯è½®è¯¢æœºåˆ¶
async function pollGenerationStatus(generationId) {
    const maxAttempts = 30;
    let attempts = 0;

    while (attempts < maxAttempts) {
        try {
            // 1. æŸ¥è¯¢çŠ¶æ€
            const response = await fetch(`/api/v2/status/${generationId}`);
            const status = await response.json();

            // 2. å¤„ç†ç»“æœ
            if (status.status === 'completed') {
                console.log('âœ… ç”Ÿæˆå®Œæˆ');

                // 3. è·å–å¯è§†åŒ–å†…å®¹
                const vizResponse = await fetch(status.html_url);
                const htmlContent = await vizResponse.text();

                // 4. æ›´æ–°å‰ç«¯æ˜¾ç¤º
                this.displayVisualization(htmlContent);
                return;
            } else if (status.status === 'failed') {
                console.error('âŒ ç”Ÿæˆå¤±è´¥:', status.error);
                throw new Error(status.error);
            }

            // 5. ç»§ç»­è½®è¯¢
            await new Promise(resolve => setTimeout(resolve, 2000));
            attempts++;
        } catch (error) {
            console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
            throw error;
        }
    }
}
```

## ğŸ—„ï¸ æ•°æ®å­˜å‚¨ç»“æ„

### 1. å†…å­˜ä¸­çš„çŠ¶æ€ç®¡ç†
```python
class AppState:
    def __init__(self):
        # å½“å‰æ´»è·ƒçš„ç”Ÿæˆä»»åŠ¡
        self.active_generations: Dict[str, Dict] = {}

        # æ¨¡æ¿å¼•æ“å®ä¾‹
        self.template_engine = UnifiedTemplateEngine()

        # è·¯ç”±ç®¡ç†å™¨å®ä¾‹
        self.router = VisualizationRouter()

# ç¤ºä¾‹ï¼šæ´»è·ƒç”Ÿæˆä»»åŠ¡çŠ¶æ€
{
    "generation_id_123": {
        "status": "processing",
        "progress": 75,
        "prompt": "æ­£å¼¦å‡½æ•°å›¾åƒ",
        "template_id": "default",
        "created_at": "2024-01-10T10:00:00",
        "html_content": "<html>...</html>"
    }
}
```

### 2. æ¨¡æ¿æ•°æ®ç»“æ„
```json
{
  "id": "normal_distribution",
  "name": "æ­£æ€åˆ†å¸ƒå¯è§†åŒ–",
  "subject": "mathematics",
  "parameters": [
    {
      "name": "mu",
      "type": "number",
      "default": 0,
      "min": -10,
      "max": 10
    }
  ],
  "html_template": "<html>...</html>"
}
```

## ğŸ” é”™è¯¯è¯Šæ–­ï¼šæ‚¨æˆªå›¾ä¸­çš„é—®é¢˜

### ğŸš¨ å¸¸è§é”™è¯¯ç±»å‹åŠè§£å†³æ–¹æ¡ˆ

#### 1. æ¨¡æ¿æ¸²æŸ“é”™è¯¯
**é”™è¯¯è¡¨ç°**: `âŒ æ¨¡æ¿æ¸²æŸ“å¤±è´¥: æ¨¡æ¿ä¸å­˜åœ¨: default`

**åŸå› åˆ†æ**:
- ç³»ç»Ÿæ‰¾ä¸åˆ°æŒ‡å®šçš„æ¨¡æ¿ID
- æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨æˆ–æœªæ­£ç¡®åŠ è½½
- æ¨¡æ¿å¼•æ“åˆå§‹åŒ–é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```python
# æ£€æŸ¥æ¨¡æ¿æ˜¯å¦å·²åŠ è½½
if template_id not in state.template_engine.templates:
    logger.error(f"æ¨¡æ¿ä¸å­˜åœ¨: {template_id}")
    # ä½¿ç”¨é»˜è®¤æ¨¡æ¿æˆ–è¿”å›é”™è¯¯
    template_id = "default"
```

#### 2. æ•°æ®éªŒè¯é”™è¯¯
**é”™è¯¯è¡¨ç°**: `422 Unprocessable Entity`

**åŸå› åˆ†æ**:
- è¯·æ±‚æ•°æ®ä¸ç¬¦åˆPydanticæ¨¡å‹å®šä¹‰
- å¿…éœ€å­—æ®µç¼ºå¤±
- æ•°æ®ç±»å‹æˆ–æ ¼å¼é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```python
class UniversalVisualizationRequest(BaseModel):
    prompt: str = Field(..., min_length=1, max_length=5000)
    # æ·»åŠ è¯¦ç»†éªŒè¯è§„åˆ™
```

#### 3. ç”Ÿæˆè¶…æ—¶é”™è¯¯
**é”™è¯¯è¡¨ç°**: ç”Ÿæˆè¿‡ç¨‹é•¿æ—¶é—´æ— å“åº”

**åŸå› åˆ†æ**:
- åå°ä»»åŠ¡å¤„ç†æ—¶é—´è¿‡é•¿
- ç³»ç»Ÿèµ„æºä¸è¶³
- å¤æ‚çš„æ•°å­¦è®¡ç®—æˆ–å›¾è¡¨ç”Ÿæˆ

**è§£å†³æ–¹æ¡ˆ**:
```python
# æ·»åŠ è¶…æ—¶æœºåˆ¶
@timeout_after(300)  # 5åˆ†é’Ÿè¶…æ—¶
async def process_generation():
    # å¤æ‚å¤„ç†é€»è¾‘
```

#### 4. å†…å­˜ä¸è¶³é”™è¯¯
**é”™è¯¯è¡¨ç°**: `MemoryError` æˆ–ç³»ç»Ÿå¡é¡¿

**åŸå› åˆ†æ**:
- åŒæ—¶å¤„ç†å¤ªå¤šç”Ÿæˆä»»åŠ¡
- å›¾è¡¨æ•°æ®é‡è¿‡å¤§
- å†…å­˜æ³„æ¼

**è§£å†³æ–¹æ¡ˆ**:
```python
# é™åˆ¶å¹¶å‘ä»»åŠ¡æ•°
MAX_CONCURRENT_GENERATIONS = 5

# å®šæœŸæ¸…ç†å®Œæˆçš„ä»»åŠ¡
async def cleanup_completed_tasks():
    pass
```

## ğŸ’¡ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹åç«¯æ—¥å¿—
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f backend-v2/logs/app.log

# æœç´¢ç‰¹å®šé”™è¯¯
grep "error" backend-v2/logs/app.log
```

### 2. ç›‘æ§æ•°æ®æµ
```python
# æ·»åŠ è¯¦ç»†æ—¥å¿—
logger.info(f"ğŸ¯ å¼€å§‹å¤„ç†: {prompt}")
logger.info(f"ğŸ“š è¯†åˆ«å­¦ç§‘: {subject}")
logger.info(f"ğŸ¨ é€‰æ‹©æ¨¡æ¿: {template_id}")
logger.info(f"âœ… ç”Ÿæˆå®Œæˆ: {generation_id}")
```

### 3. å‰ç«¯è°ƒè¯•
```javascript
// æ·»åŠ è¯¦ç»†æ—¥å¿—
console.log('ğŸš€ å‘é€è¯·æ±‚:', request);
console.log('ğŸ“¡ æ”¶åˆ°å“åº”:', response);

// ç›‘æ§è½®è¯¢çŠ¶æ€
console.log(`â³ çŠ¶æ€æ£€æŸ¥ ${attempts + 1}:`, status.status);
```

## ğŸ¯ ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®æµä¼˜åŒ–
- ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
- å®ç°ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å¹¶å‘
- æ·»åŠ è¿›åº¦åé¦ˆæœºåˆ¶

### 2. é”™è¯¯å¤„ç†ä¼˜åŒ–
- å®Œå–„é”™è¯¯åˆ†ç±»å’Œå¤„ç†
- æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- å®ç°è‡ªåŠ¨é‡è¯•æœºåˆ¶

### 3. ç›‘æ§å’Œæ—¥å¿—
- æ·»åŠ æ€§èƒ½ç›‘æ§
- å®Œå–„æ—¥å¿—è®°å½•
- å®ç°å¥åº·æ£€æŸ¥

---

**ç†è§£æ•°æ®æµæ˜¯è°ƒè¯•å¤æ‚ç³»ç»Ÿçš„å…³é”®ï¼** ğŸ¯

é€šè¿‡è¿™ä¸ªåˆ†æï¼Œæ‚¨ç°åœ¨åº”è¯¥èƒ½æ›´å¥½åœ°ç†è§£å¯è§†åŒ–ç”Ÿæˆçš„å·¥ä½œåŸç†ï¼Œå¹¶èƒ½å¤Ÿå¿«é€Ÿå®šä½å’Œè§£å†³æ•°æ®æµé—®é¢˜ã€‚