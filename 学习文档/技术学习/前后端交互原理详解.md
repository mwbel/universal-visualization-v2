# å‰åç«¯äº¤äº’åŸç†è¯¦è§£

## ğŸ”„ é€šä¿¡æµç¨‹æ¦‚è¿°

### 1. HTTPåè®®åŸºç¡€

å‰åç«¯é€šä¿¡åŸºäº**HTTPåè®®**ï¼Œè¿™æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹ï¼š

```mermaid
sequenceDiagram
    participant Browser as æµè§ˆå™¨(å‰ç«¯)
    participant Server as æœåŠ¡å™¨(åç«¯)
    participant Database as æ•°æ®åº“

    Browser->>Server: HTTP Request
    Server->>Database: æŸ¥è¯¢æ•°æ®
    Database->>Server: è¿”å›æ•°æ®
    Server->>Browser: HTTP Response
```

### 2. è¯·æ±‚-å“åº”æ¨¡å¼

#### 2.1 HTTPè¯·æ±‚çš„ç»„æˆ
```http
POST /api/v2/generate HTTP/1.1
Host: localhost:8000
Content-Type: application/json
Content-Length: 123

{
  "prompt": "ç”»ä¸€ä¸ªæ­£å¼¦å‡½æ•°",
  "template_id": "default"
}
```

**è¯·æ±‚åŒ…å«ï¼š**
- **è¯·æ±‚è¡Œ**: æ–¹æ³• + è·¯å¾„ + åè®®ç‰ˆæœ¬
- **è¯·æ±‚å¤´**: å…ƒæ•°æ®ä¿¡æ¯
- **è¯·æ±‚ä½“**: å®é™…æ•°æ®

#### 2.2 HTTPå“åº”çš„ç»„æˆ
```http
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 456

{
  "generation_id": "abc123",
  "status": "processing",
  "message": "ç”Ÿæˆä¸­..."
}
```

**å“åº”åŒ…å«ï¼š**
- **çŠ¶æ€è¡Œ**: åè®®ç‰ˆæœ¬ + çŠ¶æ€ç  + çŠ¶æ€æè¿°
- **å“åº”å¤´**: å…ƒæ•°æ®ä¿¡æ¯
- **å“åº”ä½“**: å®é™…æ•°æ®

## ğŸ“¡ å‰ç«¯å¦‚ä½•è°ƒç”¨åç«¯API

### 1. åŸç”ŸJavaScriptæ–¹æ³•

#### 1.1 ä½¿ç”¨fetch API
```javascript
// GETè¯·æ±‚ç¤ºä¾‹
async function getTemplates() {
    try {
        const response = await fetch('http://localhost:8000/api/v2/templates');

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('æ¨¡æ¿æ•°æ®:', data);
        return data;
    } catch (error) {
        console.error('è·å–æ¨¡æ¿å¤±è´¥:', error);
    }
}

// POSTè¯·æ±‚ç¤ºä¾‹
async function generateVisualization(prompt) {
    try {
        const response = await fetch('http://localhost:8000/api/v2/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prompt: prompt,
                template_id: 'default'
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('ç”Ÿæˆç»“æœ:', data);
        return data;
    } catch (error) {
        console.error('ç”Ÿæˆå¤±è´¥:', error);
    }
}
```

### 2. ä¸‡ç‰©å¯è§†åŒ–é¡¹ç›®çš„APIæœåŠ¡ç±»

#### 2.1 åˆ†æç°æœ‰ä»£ç 
ä»æ‚¨çš„é¡¹ç›®ä¸­å¯ä»¥çœ‹åˆ°ï¼š

```javascript
class APIService {
    constructor() {
        this.baseUrl = '';
        this.timeout = 30000;
        this.retryCount = 3;
    }

    async generateVisualization(request) {
        const url = `${this.baseUrl}/generate`;
        return this.postRequest(url, request);
    }

    async postRequest(url, data) {
        // å®ç°POSTè¯·æ±‚é€»è¾‘
        // åŒ…å«é‡è¯•æœºåˆ¶
        // é”™è¯¯å¤„ç†
    }
}
```

#### 2.2 è®¾è®¡æ¨¡å¼ä¼˜åŠ¿
- **å°è£…æ€§**: éšè—HTTPè¯·æ±‚ç»†èŠ‚
- **å¯å¤ç”¨**: ç»Ÿä¸€çš„è¯·æ±‚å¤„ç†é€»è¾‘
- **å¯ç»´æŠ¤**: é›†ä¸­ç®¡ç†APIé…ç½®
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶

## ğŸ”§ å¼€å‘å·¥å…·ä½¿ç”¨

### 1. æµè§ˆå™¨å¼€å‘è€…å·¥å…·

#### 1.1 ç½‘ç»œé¢æ¿
- **æŸ¥çœ‹HTTPè¯·æ±‚**: F12 â†’ Network
- **åˆ†æè¯·æ±‚/å“åº”**: ç‚¹å‡»å…·ä½“è¯·æ±‚
- **è°ƒè¯•é—®é¢˜**: æŸ¥çœ‹çŠ¶æ€ç ã€å“åº”æ—¶é—´

#### 1.2 æ§åˆ¶å°é¢æ¿
- **æŸ¥çœ‹æ—¥å¿—**: console.logè¾“å‡º
- **è°ƒè¯•JavaScript**: ç›´æ¥æ‰§è¡Œä»£ç 
- **é”™è¯¯ä¿¡æ¯**: æ•è·è¿è¡Œæ—¶é”™è¯¯

### 2. APIæµ‹è¯•å·¥å…·

#### 2.1 curlå‘½ä»¤
```bash
# æµ‹è¯•GETè¯·æ±‚
curl http://localhost:8000/api/v2/templates

# æµ‹è¯•POSTè¯·æ±‚
curl -X POST "http://localhost:8000/api/v2/generate" \
  -H "Content-Type: application/json" \
  -d '{"prompt": "æµ‹è¯•"}'

# åŒ…å«å“åº”å¤´
curl -i http://localhost:8000/api/v2/templates

# åªæ˜¾ç¤ºå“åº”å¤´
curl -I http://localhost:8000/api/v2/templates
```

#### 2.2 Postman/Insomnia
- å›¾å½¢åŒ–APIæµ‹è¯•å·¥å…·
- ä¿å­˜è¯·æ±‚é›†åˆ
- ç¯å¢ƒå˜é‡ç®¡ç†
- è‡ªåŠ¨åŒ–æµ‹è¯•

### 3. ä»£ç è°ƒè¯•æŠ€å·§

#### 3.1 åç«¯è°ƒè¯•
```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

@app.post("/api/v2/generate")
async def generate(request: UniversalVisualizationRequest):
    logger.info(f"æ”¶åˆ°ç”Ÿæˆè¯·æ±‚: {request.prompt}")

    try:
        # ä¸šåŠ¡é€»è¾‘
        result = await process_request(request)
        logger.info(f"ç”ŸæˆæˆåŠŸ: {result.generation_id}")
        return result
    except Exception as e:
        logger.error(f"ç”Ÿæˆå¤±è´¥: {str(e)}")
        raise
```

#### 3.2 å‰ç«¯è°ƒè¯•
```javascript
class APIService {
    async postRequest(url, data) {
        console.log(`ğŸš€ å‘é€è¯·æ±‚: ${url}`, data);

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            console.log(`ğŸ“¡ æ”¶åˆ°å“åº”: ${response.status}`, response);

            if (!response.ok) {
                console.error(`âŒ è¯·æ±‚å¤±è´¥: ${response.status}`);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log(`âœ… è§£ææˆåŠŸ:`, result);
            return result;
        } catch (error) {
            console.error(`âŒ è¯·æ±‚å¼‚å¸¸:`, error);
            throw error;
        }
    }
}
```

## ğŸ”„ å¼‚æ­¥å¤„ç†æœºåˆ¶

### 1. å¼‚æ­¥ä»»åŠ¡æ¨¡å¼

#### 1.1 é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
```javascript
// å‰ç«¯è½®è¯¢æ¨¡å¼
async function pollGenerationStatus(generationId) {
    const maxAttempts = 30; // æœ€å¤šç­‰å¾…30æ¬¡
    let attempts = 0;

    while (attempts < maxAttempts) {
        try {
            const response = await fetch(`/api/v2/status/${generationId}`);
            const status = await response.json();

            console.log(`çŠ¶æ€æ£€æŸ¥ ${attempts + 1}:`, status.status);

            if (status.status === 'completed') {
                console.log('âœ… ç”Ÿæˆå®Œæˆ!');
                return status.html_url;
            } else if (status.status === 'failed') {
                console.error('âŒ ç”Ÿæˆå¤±è´¥:', status.error);
                throw new Error(status.error);
            }

            // ç­‰å¾…2ç§’åå†æ¬¡æ£€æŸ¥
            await new Promise(resolve => setTimeout(resolve, 2000));
            attempts++;
        } catch (error) {
            console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
            throw error;
        }
    }

    throw new Error('ç”Ÿæˆè¶…æ—¶');
}
```

#### 1.2 WebSocketå®æ—¶é€šä¿¡ï¼ˆé«˜çº§ï¼‰
```javascript
// WebSocketè¿æ¥ï¼ˆç”¨äºå®æ—¶æ›´æ–°ï¼‰
const ws = new WebSocket('ws://localhost:8000/ws');

ws.onopen = function(event) {
    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
};

ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    console.log('æ”¶åˆ°å®æ—¶æ›´æ–°:', data);

    if (data.type === 'generation_progress') {
        updateProgress(data.progress);
    }
};
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†
```javascript
// ç»Ÿä¸€é”™è¯¯å¤„ç†
class APIError extends Error {
    constructor(message, status, data) {
        super(message);
        this.name = 'APIError';
        this.status = status;
        this.data = data;
    }
}

async function apiCall(url, options = {}) {
    try {
        const response = await fetch(url, {
            timeout: 30000,
            ...options
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new APIError(
                errorData.detail || `HTTP ${response.status}`,
                response.status,
                errorData
            );
        }

        return await response.json();
    } catch (error) {
        if (error instanceof APIError) {
            throw error;
        }

        // ç½‘ç»œé”™è¯¯ç­‰
        throw new APIError('ç½‘ç»œè¿æ¥å¤±è´¥', 0, { originalError: error.message });
    }
}
```

### 2. è¯·æ±‚é‡è¯•æœºåˆ¶
```javascript
async function retryRequest(url, options = {}, maxRetries = 3) {
    let lastError;

    for (let i = 0; i <= maxRetries; i++) {
        try {
            return await apiCall(url, options);
        } catch (error) {
            lastError = error;

            if (i < maxRetries) {
                console.warn(`è¯·æ±‚å¤±è´¥ï¼Œ${2 ** i}ç§’åé‡è¯• (${i + 1}/${maxRetries})`);
                await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
            }
        }
    }

    throw lastError;
}
```

### 3. æ•°æ®ç¼“å­˜
```javascript
class CachedAPIService {
    constructor() {
        this.cache = new Map();
        this.cacheTimeout = 5 * 60 * 1000; // 5åˆ†é’Ÿ
    }

    async getTemplates() {
        const cacheKey = 'templates';
        const cached = this.cache.get(cacheKey);

        if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
            console.log('ğŸ“¦ ä½¿ç”¨ç¼“å­˜æ•°æ®');
            return cached.data;
        }

        console.log('ğŸŒ è¯·æ±‚æ–°æ•°æ®');
        const data = await apiCall('/api/v2/templates');

        this.cache.set(cacheKey, {
            data,
            timestamp: Date.now()
        });

        return data;
    }
}
```

## ğŸ’¡ å­¦ä¹ è¦ç‚¹æ€»ç»“

### 1. æ ¸å¿ƒæ¦‚å¿µ
- **HTTPåè®®**: è¯·æ±‚-å“åº”æ¨¡å¼
- **RESTful API**: èµ„æºå¯¼å‘çš„è®¾è®¡
- **JSONæ ¼å¼**: è½»é‡çº§æ•°æ®äº¤æ¢æ ¼å¼
- **å¼‚æ­¥å¤„ç†**: éé˜»å¡çš„æ“ä½œæ¨¡å¼

### 2. å®è·µæŠ€èƒ½
- **fetch API**: ç°ä»£æµè§ˆå™¨è¯·æ±‚æ–¹æ³•
- **é”™è¯¯å¤„ç†**: ä¼˜é›…çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **è°ƒè¯•å·¥å…·**: å¼€å‘è€…å·¥å…·çš„ä½¿ç”¨
- **æ€§èƒ½ä¼˜åŒ–**: ç¼“å­˜å’Œé‡è¯•æœºåˆ¶

### 3. è¿›é˜¶æ¦‚å¿µ
- **WebSocket**: å®æ—¶åŒå‘é€šä¿¡
- **CORS**: è·¨åŸŸèµ„æºå…±äº«
- **è®¤è¯æˆæƒ**: JWTã€OAuthç­‰
- **APIç‰ˆæœ¬ç®¡ç†**: å‘åå…¼å®¹æ€§

---

**æŒæ¡è¿™äº›æ¦‚å¿µåï¼Œæ‚¨å°±èƒ½ç‹¬ç«‹è®¾è®¡å’Œå®ç°å‰åç«¯äº¤äº’ç³»ç»Ÿäº†ï¼** ğŸ‰