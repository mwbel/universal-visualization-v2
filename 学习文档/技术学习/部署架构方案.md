# ä¸‡ç‰©å¯è§†åŒ– - éƒ¨ç½²æ¶æ„æ–¹æ¡ˆ

## ğŸ³ Docker å®¹å™¨åŒ–æ–¹æ¡ˆ

### 1. åº”ç”¨å®¹å™¨åŒ–

#### åç«¯ Dockerfile
```dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Pythonä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### å‰ç«¯ Dockerfile
```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:18-alpine as build-stage

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine as production-stage

COPY --from=build-stage /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### 2. Docker Compose é…ç½®

```yaml
version: '3.8'

services:
  # å‰ç«¯æœåŠ¡
  frontend:
    build: ./frontend
    ports:
      - "3000:80"
    environment:
      - API_BASE_URL=http://backend:8000
    depends_on:
      - backend

  # åç«¯APIæœåŠ¡
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/universal_viz
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
    depends_on:
      - postgres
      - redis
      - minio
    volumes:
      - ./templates:/app/templates

  # æ•°æ®åº“
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=universal_viz
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # Celery Worker
  celery-worker:
    build: ./backend
    command: celery -A app.celery worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/universal_viz
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - postgres
      - redis

  # Celery Beat (å®šæ—¶ä»»åŠ¡)
  celery-beat:
    build: ./backend
    command: celery -A app.celery beat --loglevel=info
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/universal_viz
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - postgres
      - redis

  # MinIOå¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data

  # Nginxåå‘ä»£ç†
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend

volumes:
  postgres_data:
  redis_data:
  minio_data:
```

## â˜ï¸ äº‘éƒ¨ç½²æ–¹æ¡ˆ

### 1. AWS éƒ¨ç½²æ¶æ„

```yaml
# ECS æœåŠ¡å®šä¹‰
Resources:
  # VPCç½‘ç»œ
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true

  # RDSæ•°æ®åº“
  Database:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceClass: db.t3.micro
      Engine: postgres
      EngineVersion: "15.4"
      MasterUsername: postgres
      MasterUserPassword: !Ref DatabasePassword
      AllocatedStorage: 20
      StorageType: gp2

  # ElastiCache Redis
  RedisCluster:
    Type: AWS::ElastiCache::CacheCluster
    Properties:
      CacheNodeType: cache.t3.micro
      Engine: redis
      NumCacheNodes: 1

  # ECSé›†ç¾¤
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT

  # S3å­˜å‚¨æ¡¶
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: universal-visualization-assets
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
```

### 2. Kubernetes éƒ¨ç½²

```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: universal-viz

---
# backend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: universal-viz
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: universal-viz/backend:latest
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: database-url
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---
# backend-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: universal-viz
spec:
  selector:
    app: backend
  ports:
  - port: 8000
    targetPort: 8000
  type: ClusterIP

---
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: universal-viz-ingress
  namespace: universal-viz
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - app.universal-viz.com
    secretName: universal-viz-tls
  rules:
  - host: app.universal-viz.com
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: backend
            port:
              number: 8000
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 80
```

## ğŸš¦ CI/CD æµæ°´çº¿

### 1. GitHub Actions é…ç½®

```yaml
# .github/workflows/deploy.yml
name: Deploy Universal Visualization

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest

    - name: Run tests
      run: pytest

    - name: Run linting
      run: |
        pip install flake8 black
        flake8 .
        black --check .

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Build Docker images
      run: |
        docker build -t universal-viz/backend:${{ github.sha }} ./backend
        docker build -t universal-viz/frontend:${{ github.sha }} ./frontend

    - name: Push to registry
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker push universal-viz/backend:${{ github.sha }}
        docker push universal-viz/frontend:${{ github.sha }}

    - name: Deploy to staging
      run: |
        # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
        ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} "
          docker pull universal-viz/backend:${{ github.sha }}
          docker pull universal-viz/frontend:${{ github.sha }}
          docker-compose up -d
        "

    - name: Run integration tests
      run: |
        # è¿è¡Œé›†æˆæµ‹è¯•
        python tests/integration_test.py

    - name: Deploy to production
      if: success()
      run: |
        # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
        ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} "
          docker pull universal-viz/backend:${{ github.sha }}
          docker pull universal-viz/frontend:${{ github.sha }}
          docker-compose up -d
        "
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. Prometheus + Grafana ç›‘æ§

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'universal-viz-backend'
    static_configs:
      - targets: ['backend:8000']
    metrics_path: '/metrics'
    scrape_interval: 5s

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
```

### 2. ELK æ—¥å¿—æ”¶é›†

```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /app/logs/*.log
  fields:
    service: universal-viz-backend
    environment: production

output.elasticsearch:
  hosts: ["elasticsearch:9200"]

setup.kibana:
  host: "kibana:5601"
```

## ğŸ”’ å®‰å…¨é…ç½®

### 1. ç½‘ç»œå®‰å…¨

```yaml
# ç½‘ç»œç­–ç•¥
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: universal-viz-netpol
  namespace: universal-viz
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    ports:
    - protocol: TCP
      port: 5432
```

### 2. å¯†é’¥ç®¡ç†

```yaml
# secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: universal-viz
type: Opaque
data:
  database-url: <base64-encoded-url>
  jwt-secret: <base64-encoded-secret>
  redis-password: <base64-encoded-password>
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. è‡ªåŠ¨æ‰©ç¼©å®¹

```yaml
# hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-hpa
  namespace: universal-viz
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### 2. CDNé…ç½®

```nginx
# nginx.conf
server {
    listen 80;
    server_name app.universal-viz.com;

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # APIä»£ç†
    location /api {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # å‰ç«¯åº”ç”¨
    location / {
        proxy_pass http://frontend:80;
        proxy_set_header Host $host;
    }
}
```

---

**è¿™ä¸ªéƒ¨ç½²æ¶æ„æä¾›ï¼š**
- âœ… å®¹å™¨åŒ–éƒ¨ç½²å’Œç¼–æ’
- âœ… äº‘åŸç”Ÿè§£å†³æ–¹æ¡ˆ
- âœ… è‡ªåŠ¨åŒ–CI/CDæµæ°´çº¿
- âœ… å®Œæ•´çš„ç›‘æ§å’Œæ—¥å¿—
- âœ… ä¼ä¸šçº§å®‰å…¨é…ç½®
- âœ… é«˜å¯ç”¨å’Œè‡ªåŠ¨æ‰©ç¼©å®¹