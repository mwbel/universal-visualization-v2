# ä¸‡ç‰©å¯è§†åŒ– - æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆ

## ğŸ“Š æ•°æ®åº“æ¶æ„

### 1. ç”¨æˆ·ç³»ç»Ÿ (PostgreSQL)

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    is_active BOOLEAN DEFAULT true,
    subscription_level VARCHAR(20) DEFAULT 'free'
);

-- ç”¨æˆ·é¡¹ç›®è¡¨
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    is_public BOOLEAN DEFAULT false
);
```

### 2. å¯è§†åŒ–å†…å®¹ç®¡ç†

```sql
-- å¯è§†åŒ–è®°å½•è¡¨
CREATE TABLE visualizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    template_id VARCHAR(100),
    parameters JSONB,
    html_content TEXT,
    file_path VARCHAR(500),
    status VARCHAR(20) DEFAULT 'draft',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- å¯è§†åŒ–æ ‡ç­¾è¡¨
CREATE TABLE visualization_tags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    visualization_id UUID REFERENCES visualizations(id) ON DELETE CASCADE,
    tag VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 3. æ¨¡æ¿ç³»ç»Ÿ

```sql
-- æ¨¡æ¿è¡¨
CREATE TABLE templates (
    id VARCHAR(100) PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    subject VARCHAR(50) NOT NULL,
    category VARCHAR(50),
    difficulty VARCHAR(20),
    parameters_schema JSONB,
    html_template TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    is_active BOOLEAN DEFAULT true,
    usage_count INTEGER DEFAULT 0
);

-- æ¨¡æ¿è¯„åˆ†è¡¨
CREATE TABLE template_ratings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id VARCHAR(100) REFERENCES templates(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    review TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 4. ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†

```sql
-- å¼‚æ­¥ä»»åŠ¡è¡¨
CREATE TABLE async_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_type VARCHAR(50) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    input_data JSONB,
    result_data JSONB,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    retry_count INTEGER DEFAULT 0
);
```

### 5. ç³»ç»Ÿé…ç½®

```sql
-- ç³»ç»Ÿé…ç½®è¡¨
CREATE TABLE system_settings (
    key VARCHAR(100) PRIMARY KEY,
    value JSONB NOT NULL,
    description TEXT,
    updated_at TIMESTAMP DEFAULT NOW()
);
```

## ğŸ—„ï¸ Redis ç¼“å­˜ç­–ç•¥

### 1. ç¼“å­˜é”®å‘½åè§„èŒƒ
```
user:profile:{user_id}           # ç”¨æˆ·èµ„æ–™ç¼“å­˜
template:all                     # æ‰€æœ‰æ¨¡æ¿ç¼“å­˜
template:{template_id}           # å•ä¸ªæ¨¡æ¿ç¼“å­˜
viz:rendering:{task_id}          # æ¸²æŸ“ä»»åŠ¡çŠ¶æ€
project:list:{user_id}           # ç”¨æˆ·é¡¹ç›®åˆ—è¡¨
```

### 2. ç¼“å­˜è¿‡æœŸæ—¶é—´
```python
CACHE_EXPIRY = {
    "user_profile": 3600,        # 1å°æ—¶
    "templates": 86400,          # 24å°æ—¶
    "rendering_status": 300,     # 5åˆ†é’Ÿ
    "project_list": 1800,        # 30åˆ†é’Ÿ
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç´¢å¼•ç­–ç•¥
```sql
-- ç”¨æˆ·ç›¸å…³ç´¢å¼•
CREATE INDEX idx_visualizations_user_id ON visualizations(user_id);
CREATE INDEX idx_visualizations_project_id ON visualizations(project_id);
CREATE INDEX idx_visualizations_created_at ON visualizations(created_at DESC);

-- æ¨¡æ¿ç›¸å…³ç´¢å¼•
CREATE INDEX idx_templates_subject ON templates(subject);
CREATE INDEX idx_templates_category ON templates(category);
CREATE INDEX idx_templates_usage_count ON templates(usage_count DESC);

-- ä»»åŠ¡ç›¸å…³ç´¢å¼•
CREATE INDEX idx_async_tasks_status ON async_tasks(status);
CREATE INDEX idx_async_tasks_created_at ON async_tasks(created_at DESC);
```

### 2. åˆ†åŒºç­–ç•¥
```sql
-- æŒ‰æ—¶é—´åˆ†åŒºå¯è§†åŒ–è¡¨
CREATE TABLE visualizations_y2024m01 PARTITION OF visualizations
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

### 3. è¯»å†™åˆ†ç¦»
- **ä¸»åº“**ï¼šå¤„ç†å†™æ“ä½œå’Œå®æ—¶æŸ¥è¯¢
- **ä»åº“**ï¼šå¤„ç†æŠ¥è¡¨æŸ¥è¯¢å’Œæ•°æ®åˆ†æ
- **è¿æ¥æ± **ï¼šä½¿ç”¨PgBouncerç®¡ç†è¿æ¥

## ğŸ”’ å®‰å…¨è®¾è®¡

### 1. æ•°æ®åŠ å¯†
```python
# æ•æ„Ÿæ•°æ®åŠ å¯†
from cryptography.fernet import Fernet

def encrypt_sensitive_data(data: str) -> str:
    key = os.environ.get('ENCRYPTION_KEY')
    f = Fernet(key)
    return f.encrypt(data.encode()).decode()
```

### 2. æƒé™æ§åˆ¶
```sql
-- è¡Œçº§å®‰å…¨ç­–ç•¥
ALTER TABLE visualizations ENABLE ROW LEVEL SECURITY;

CREATE POLICY user_visualizations ON visualizations
FOR ALL TO authenticated_users
USING (project_id IN (
    SELECT id FROM projects WHERE user_id = current_user_id()
));
```

### 3. å®¡è®¡æ—¥å¿—
```sql
-- æ“ä½œå®¡è®¡è¡¨
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID,
    action VARCHAR(50) NOT NULL,
    resource_type VARCHAR(50),
    resource_id UUID,
    old_values JSONB,
    new_values JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### 1. ä¸šåŠ¡æŒ‡æ ‡
```sql
-- æ¯æ—¥æ–°å¢å¯è§†åŒ–æ•°
SELECT DATE(created_at) as date, COUNT(*) as count
FROM visualizations
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- çƒ­é—¨æ¨¡æ¿æ’è¡Œ
SELECT t.id, t.name, COUNT(v.id) as usage_count
FROM templates t
LEFT JOIN visualizations v ON v.template_id = t.id
GROUP BY t.id, t.name
ORDER BY usage_count DESC
LIMIT 10;
```

### 2. æ€§èƒ½æŒ‡æ ‡
```sql
-- æŸ¥è¯¢æ€§èƒ½ç›‘æ§
SELECT query, mean_exec_time, calls, total_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

## ğŸš€ è¿ç§»ç­–ç•¥

### 1. æ•°æ®è¿ç§»è„šæœ¬
```python
# alembicè¿ç§»ç¤ºä¾‹
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

def upgrade():
    # åˆ›å»ºæ–°è¡¨
    op.create_table('users',
        sa.Column('id', postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column('username', sa.String(length=50), nullable=False),
        # ... å…¶ä»–å­—æ®µ
    )
```

### 2. å¹³æ»‘è¿‡æ¸¡
1. **åŒå†™æ¨¡å¼**ï¼šåŒæ—¶å†™å…¥æ–°æ—§ç³»ç»Ÿ
2. **æ•°æ®åŒæ­¥**ï¼šå®šæœŸåŒæ­¥æ•°æ®
3. **é€æ­¥åˆ‡æ¢**ï¼šæŒ‰æ¨¡å—é€æ­¥è¿ç§»
4. **å›æ»šæ–¹æ¡ˆ**ï¼šåˆ¶å®šå›æ»šç­–ç•¥

---

**è¿™ä¸ªæ•°æ®åº“è®¾è®¡æ”¯æŒï¼š**
- âœ… ç”¨æˆ·ç³»ç»Ÿå’Œæƒé™ç®¡ç†
- âœ… å¯è§†åŒ–å†…å®¹å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… æ¨¡æ¿å¸‚åœºå’Œç‰ˆæœ¬æ§åˆ¶
- âœ… å¼‚æ­¥ä»»åŠ¡å’Œæ€§èƒ½ç›‘æ§
- âœ… æ•°æ®å®‰å…¨å’Œéšç§ä¿æŠ¤
- âœ… é«˜å¹¶å‘å’Œå¤§æ•°æ®é‡åœºæ™¯