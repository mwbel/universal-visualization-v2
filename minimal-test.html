<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最小化测试</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
</head>
<body>
    <h1>最小化可视化测试</h1>
    <button onclick="testDirectPlot()">测试直接绘图</button>
    <button onclick="testAPI()">测试API生成</button>
    <div id="plot" style="width:100%; height:500px; border:1px solid #ccc; margin-top:20px;"></div>

    <!-- 为API生成的HTML提供必要的容器 -->
    <div id="apiResult" style="display:none;">
        <!-- 滑动条控件 -->
        <div style="margin: 20px 0;">
            <label>均值 (μ): <input type="range" id="mu" min="-10" max="10" step="0.1" value="0"></label>
            <span id="muValue">0.0</span>
        </div>
        <div style="margin: 20px 0;">
            <label>标准差 (σ): <input type="range" id="sigma" min="0.1" max="5" step="0.1" value="1"></label>
            <span id="sigmaValue">1.0</span>
        </div>
        <!-- 统计信息 -->
        <div id="meanStat">0.00</div>
        <div id="stdStat">1.00</div>
        <div id="varStat">1.00</div>
        <div id="medianStat">0.00</div>
    </div>

    <script>
        function testDirectPlot() {
            console.log('测试直接Plotly绘图');

            const trace = {
                x: [1, 2, 3, 4],
                y: [10, 15, 13, 17],
                type: 'scatter',
                mode: 'lines+markers'
            };

            const layout = {
                title: '测试图表',
                xaxis: { title: 'X轴' },
                yaxis: { title: 'Y轴' }
            };

            Plotly.newPlot('plot', [trace], layout);
            console.log('直接绘图完成');
        }

        async function testAPI() {
            console.log('测试API生成');

            try {
                const response = await fetch('http://localhost:8000/resolve_or_generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: '正态分布 均值0 标准差1',
                        vizType: 'auto',
                        complexity: '中等',
                        params: {}
                    })
                });

                const result = await response.json();
                console.log('API响应:', result);

                if (result.success && result.htmlContent) {
                    console.log('开始解析API返回的HTML...');

                    // 显示API结果容器
                    document.getElementById('apiResult').style.display = 'block';

                    // 解析HTML并提取需要的部分
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(result.htmlContent, 'text/html');

                    // 提取脚本内容
                    const scripts = doc.querySelectorAll('script');
                    console.log(`发现 ${scripts.length} 个脚本`);

                    // 执行每个脚本
                    scripts.forEach((script, index) => {
                        console.log(`执行脚本 ${index + 1}:`);
                        try {
                            if (script.textContent) {
                                // 创建一个函数来执行脚本，避免eval的作用域问题
                                const scriptFunction = new Function(script.textContent);
                                scriptFunction();
                                console.log(`脚本 ${index + 1} 执行成功`);
                            }
                        } catch (error) {
                            console.error(`脚本 ${index + 1} 执行失败:`, error);
                        }
                    });

                    console.log('API测试完成');
                }
            } catch (error) {
                console.error('API测试失败:', error);
            }
        }

        // 页面加载时测试直接绘图
        window.addEventListener('load', function() {
            console.log('页面加载完成，Plotly版本:', Plotly.version);
        });
    </script>
</body>
</html>