<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»é¡µæŒ‰é’®å“åº”è¯Šæ–­</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .diagnostic-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }
        .status.success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .status.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: #212529; }
        .btn.danger { background: #dc3545; }
        .btn.sm { padding: 4px 8px; font-size: 12px; }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .log-output {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .test-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        .test-button:hover {
            background: #545b62;
        }

        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ä¸»é¡µæŒ‰é’®å“åº”è¯Šæ–­å·¥å…·</h1>

    <div class="diagnostic-container">
        <h2>å®æ—¶çŠ¶æ€ç›‘æ§</h2>
        <div id="status-monitor"></div>
        <button class="btn" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
        <button class="btn warning" onclick="startAutoRefresh()">â±ï¸ è‡ªåŠ¨åˆ·æ–°</button>
        <button class="btn danger" onclick="stopAutoRefresh()">â¹ï¸ åœæ­¢åˆ·æ–°</button>
    </div>

    <div class="two-column">
        <div class="diagnostic-container">
            <h2>ä¸»é¡µå®æ—¶é¢„è§ˆ</h2>
            <iframe id="mainpage-preview" src="/"></iframe>
            <div style="margin-top: 10px;">
                <button class="test-button" onclick="testInIframe('debugVerifyEvents()')">ğŸ” éªŒè¯äº‹ä»¶ç»‘å®š</button>
                <button class="test-button" onclick="testInIframe('debugManualBind()')">ğŸ”— æ‰‹åŠ¨ç»‘å®š</button>
                <button class="test-button" onclick="testInIframe('debugHelp()')">â“ è°ƒè¯•å¸®åŠ©</button>
                <button class="test-button" onclick="testInIframe('debugTestModule(\"probability-stats\")')">ğŸ“Š æµ‹è¯•æ¦‚ç‡ç»Ÿè®¡</button>
                <button class="test-button" onclick="testInIframe('debugTestModule(\"linear-algebra\")')">ğŸ”¢ æµ‹è¯•çº¿æ€§ä»£æ•°</button>
                <button class="test-button" onclick="testInIframe('debugTestModule(\"differential-geometry\")')">ğŸŒ æµ‹è¯•å¾®åˆ†å‡ ä½•</button>
            </div>
        </div>

        <div class="diagnostic-container">
            <h2>æ§åˆ¶å°æ—¥å¿—</h2>
            <div id="console-log" class="log-output">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
            <button class="btn sm" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <div class="diagnostic-container">
        <h2>ç»„ä»¶çŠ¶æ€æ£€æŸ¥</h2>
        <div id="components-status"></div>
        <button class="btn success" onclick="checkComponents()">ğŸ” æ£€æŸ¥ç»„ä»¶çŠ¶æ€</button>
        <button class="btn warning" onclick="forceReinit()">ğŸ”„ å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–</button>
    </div>

    <div class="diagnostic-container">
        <h2>æŒ‰é’®çŠ¶æ€æµ‹è¯•</h2>
        <div id="buttons-status"></div>
        <button class="btn" onclick="testAllButtons()">ğŸ§ª æµ‹è¯•æ‰€æœ‰æŒ‰é’®</button>
        <button class="btn warning" onclick="highlightUnboundButtons()">ğŸ”¦ é«˜äº®æœªç»‘å®šæŒ‰é’®</button>
    </div>

    <script>
        let autoRefreshInterval = null;
        let originalConsoleLog = null;
        let logMessages = [];

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            console.log('ğŸ”§ ä¸»é¡µè¯Šæ–­å·¥å…·å·²å¯åŠ¨');
            refreshStatus();
            checkComponents();
            setupConsoleCapture();
        });

        // è®¾ç½®æ§åˆ¶å°æ•è·
        function setupConsoleCapture() {
            const iframe = document.getElementById('mainpage-preview');
            iframe.addEventListener('load', () => {
                try {
                    const iframeWindow = iframe.contentWindow;
                    if (iframeWindow && iframeWindow.console) {
                        // æ•è·iframeçš„æ§åˆ¶å°è¾“å‡º
                        const originalLog = iframeWindow.console.log;
                        const originalError = iframeWindow.console.error;
                        const originalWarn = iframeWindow.console.warn;

                        iframeWindow.console.log = function(...args) {
                            originalLog.apply(iframeWindow.console, args);
                            addLogMessage('LOG', args.join(' '));
                        };

                        iframeWindow.console.error = function(...args) {
                            originalError.apply(iframeWindow.console, args);
                            addLogMessage('ERROR', args.join(' '));
                        };

                        iframeWindow.console.warn = function(...args) {
                            originalWarn.apply(iframeWindow.console, args);
                            addLogMessage('WARN', args.join(' '));
                        };
                    }
                } catch (e) {
                    console.warn('æ— æ³•æ•è·iframeæ§åˆ¶å°è¾“å‡º:', e);
                }
            });
        }

        function addLogMessage(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'ERROR' ? '#ff6b6b' : type === 'WARN' ? '#ffa726' : '#4fc3f7';
            logMessages.unshift(`[${timestamp}] ${type}: ${message}`);
            if (logMessages.length > 50) logMessages.pop();

            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('console-log');
            logDiv.textContent = logMessages.join('\n');
        }

        function clearLog() {
            logMessages = [];
            updateLogDisplay();
        }

        // åˆ·æ–°çŠ¶æ€
        function refreshStatus() {
            const statusDiv = document.getElementById('status-monitor');
            statusDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æ£€æŸ¥çŠ¶æ€...</div>';

            // æ£€æŸ¥ä¸»é¡µå¯è®¿é—®æ€§
            fetch('/', { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        statusDiv.innerHTML += '<div class="status success">âœ… ä¸»é¡µå¯æ­£å¸¸è®¿é—®</div>';
                    } else {
                        statusDiv.innerHTML += '<div class="status error">âŒ ä¸»é¡µè®¿é—®å¼‚å¸¸</div>';
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML += '<div class="status error">âŒ æ— æ³•è®¿é—®ä¸»é¡µ: ' + error.message + '</div>';
                });

            // æ£€æŸ¥app.jsåŠ è½½çŠ¶æ€
            setTimeout(() => {
                const iframe = document.getElementById('mainpage-preview');
                try {
                    const iframeWindow = iframe.contentWindow;
                    if (iframeWindow.global && iframeWindow.global.app) {
                        statusDiv.innerHTML += '<div class="status success">âœ… Appå¯¹è±¡å·²åˆå§‹åŒ–</div>';

                        // æ£€æŸ¥å…³é”®æ–¹æ³•
                        const methods = ['verifyEventBinding', 'bindSubcategoryEvents', 'exploreSubmodule'];
                        methods.forEach(method => {
                            if (typeof iframeWindow.global.app[method] === 'function') {
                                statusDiv.innerHTML += `<div class="status success">âœ… ${method} æ–¹æ³•å¯ç”¨</div>`;
                            } else {
                                statusDiv.innerHTML += `<div class="status error">âŒ ${method} æ–¹æ³•ä¸å¯ç”¨</div>`;
                            }
                        });
                    } else {
                        statusDiv.innerHTML += '<div class="status warning">âš ï¸ Appå¯¹è±¡æœªåˆå§‹åŒ–æˆ–æ­£åœ¨åŠ è½½ä¸­</div>';
                    }
                } catch (e) {
                    statusDiv.innerHTML += '<div class="status error">âŒ æ— æ³•æ£€æŸ¥AppçŠ¶æ€: ' + e.message + '</div>';
                }
            }, 2000);
        }

        // æ£€æŸ¥ç»„ä»¶çŠ¶æ€
        function checkComponents() {
            const componentsDiv = document.getElementById('components-status');
            componentsDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æ£€æŸ¥ç»„ä»¶...</div>';

            const iframe = document.getElementById('mainpage-preview');
            setTimeout(() => {
                try {
                    const iframeWindow = iframe.contentWindow;
                    if (iframeWindow.global && iframeWindow.global.app) {
                        const app = iframeWindow.global.app;
                        const components = ['StateManager', 'ThemeManager', 'TemplateSelector', 'Router'];

                        let componentStatus = '';
                        components.forEach(comp => {
                            if (app.components && app.components[comp]) {
                                componentStatus += `<div class="status success">âœ… ${comp} å·²åŠ è½½</div>`;
                            } else {
                                componentStatus += `<div class="status error">âŒ ${comp} æœªåŠ è½½</div>`;
                            }
                        });

                        componentsDiv.innerHTML = componentStatus;
                    } else {
                        componentsDiv.innerHTML = '<div class="status error">âŒ æ— æ³•è®¿é—®Appå¯¹è±¡</div>';
                    }
                } catch (e) {
                    componentsDiv.innerHTML = '<div class="status error">âŒ æ£€æŸ¥ç»„ä»¶æ—¶å‡ºé”™: ' + e.message + '</div>';
                }
            }, 1000);
        }

        // æµ‹è¯•æ‰€æœ‰æŒ‰é’®
        function testAllButtons() {
            const buttonsDiv = document.getElementById('buttons-status');
            buttonsDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æµ‹è¯•æŒ‰é’®...</div>';

            const iframe = document.getElementById('mainpage-preview');
            setTimeout(() => {
                try {
                    const iframeWindow = iframe.contentWindow;
                    if (iframeWindow.document) {
                        const subcategories = iframeWindow.document.querySelectorAll('.subcategory');
                        let buttonStatus = '';

                        subcategories.forEach((btn, index) => {
                            const submoduleName = btn.dataset.submodule;
                            const name = btn.querySelector('.subcategory-name')?.textContent;

                            if (submoduleName && name) {
                                // ç®€å•çš„äº‹ä»¶ç›‘å¬å™¨æ£€æŸ¥
                                const hasListeners = btn.getAttribute('data-listeners') ||
                                                  (btn.onclick || btn.addEventListener);

                                if (hasListeners) {
                                    buttonStatus += `<div class="status success">âœ… ${name} (${submoduleName}) - å·²ç»‘å®šäº‹ä»¶</div>`;
                                } else {
                                    buttonStatus += `<div class="status error">âŒ ${name} (${submoduleName}) - æœªæ£€æµ‹åˆ°äº‹ä»¶ç»‘å®š</div>`;
                                }
                            }
                        });

                        buttonsDiv.innerHTML = buttonStatus || '<div class="status warning">âš ï¸ æœªæ‰¾åˆ°å­åˆ†ç±»æŒ‰é’®</div>';
                    }
                } catch (e) {
                    buttonsDiv.innerHTML = '<div class="status error">âŒ æµ‹è¯•æŒ‰é’®æ—¶å‡ºé”™: ' + e.message + '</div>';
                }
            }, 1000);
        }

        // åœ¨iframeä¸­æ‰§è¡Œå‘½ä»¤
        function testInIframe(command) {
            const iframe = document.getElementById('mainpage-preview');
            try {
                const iframeWindow = iframe.contentWindow;
                if (iframeWindow.eval) {
                    console.log(`ğŸ§ª åœ¨iframeä¸­æ‰§è¡Œ: ${command}`);
                    const result = iframeWindow.eval(command);
                    console.log('âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œç»“æœ:', result);
                } else {
                    console.error('âŒ æ— æ³•åœ¨iframeä¸­æ‰§è¡Œå‘½ä»¤');
                }
            } catch (e) {
                console.error('âŒ æ‰§è¡Œå‘½ä»¤æ—¶å‡ºé”™:', e);
            }
        }

        // è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (autoRefreshInterval) return;
            autoRefreshInterval = setInterval(() => {
                refreshStatus();
                checkComponents();
            }, 3000);
            console.log('âœ… å·²å¼€å§‹è‡ªåŠ¨åˆ·æ–°');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('â¹ï¸ å·²åœæ­¢è‡ªåŠ¨åˆ·æ–°');
            }
        }

        // é«˜äº®æœªç»‘å®šæŒ‰é’®
        function highlightUnboundButtons() {
            testInIframe(`
                // é«˜äº®æœªç»‘å®šæŒ‰é’®
                const buttons = document.querySelectorAll('.subcategory');
                buttons.forEach(btn => {
                    if (!btn.onclick && !btn.hasAttribute('data-click-bound')) {
                        btn.style.border = '2px solid red';
                        btn.style.boxShadow = '0 0 10px rgba(255,0,0,0.5)';
                    } else {
                        btn.style.border = '2px solid green';
                        btn.style.boxShadow = '0 0 10px rgba(0,255,0,0.3)';
                    }
                });
                console.log('ğŸ”¦ å·²é«˜äº®æŒ‰é’®çŠ¶æ€ï¼ˆçº¢è‰²=æœªç»‘å®šï¼Œç»¿è‰²=å·²ç»‘å®šï¼‰');
            `);
        }

        // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–
        function forceReinit() {
            testInIframe(`
                console.log('ğŸ”„ å¼€å§‹å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–...');
                if (window.global && window.global.app) {
                    window.global.app.init().then(() => {
                        console.log('âœ… é‡æ–°åˆå§‹åŒ–å®Œæˆ');
                    }).catch(err => {
                        console.error('âŒ é‡æ–°åˆå§‹åŒ–å¤±è´¥:', err);
                    });
                } else {
                    console.error('âŒ Appå¯¹è±¡ä¸å­˜åœ¨');
                }
            `);
        }
    </script>
</body>
</html>