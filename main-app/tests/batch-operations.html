<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡æ“ä½œåŠŸèƒ½æµ‹è¯•</title>
    <link rel="stylesheet" href="../styles/design-system.css">
    <style>
        .batch-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .batch-section {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .control-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 1rem;
        }
        .control-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        .batch-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
            transition: all 0.2s ease;
        }
        .batch-button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        .batch-button:disabled {
            background: var(--muted);
            cursor: not-allowed;
            transform: none;
        }
        .batch-button.secondary {
            background: var(--secondary);
        }
        .batch-button.danger {
            background: #ef4444;
        }
        .batch-button.danger:hover {
            background: #dc2626;
        }
        .progress-container {
            margin: 1rem 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--muted);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .batch-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        .batch-table th,
        .batch-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .batch-table th {
            background: rgba(59, 130, 246, 0.1);
            font-weight: 600;
            color: var(--primary);
        }
        .batch-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .status-indicator.pending { background: #6b7280; }
        .status-indicator.processing { background: #3b82f6; }
        .status-indicator.completed { background: #22c55e; }
        .status-indicator.failed { background: #ef4444; }
        .status-indicator.cancelled { background: #f59e0b; }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .metric-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        .metric-label {
            color: var(--muted-foreground);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        .log-container {
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid var(--border);
        }
        .batch-input {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--background);
            color: var(--foreground);
            font-family: inherit;
            resize: vertical;
            margin: 1rem 0;
        }
        .export-options {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin: 1rem 0;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background: #22c55e;
        }
        .notification.error {
            background: #ef4444;
        }
        .notification.warning {
            background: #f59e0b;
        }
        .notification.info {
            background: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="batch-container">
        <header class="batch-section">
            <h1>ğŸ”„ æ‰¹é‡æ“ä½œåŠŸèƒ½æµ‹è¯•</h1>
            <p>æµ‹è¯•æ‰¹é‡ç”Ÿæˆã€å‚æ•°è°ƒæ•´ã€å¯¼å‡ºç­‰åŠŸèƒ½</p>
            <div>
                <button id="testBatchGeneration" class="batch-button">æµ‹è¯•æ‰¹é‡ç”Ÿæˆ</button>
                <button id="testBatchParams" class="batch-button">æµ‹è¯•æ‰¹é‡å‚æ•°è°ƒæ•´</button>
                <button id="testBatchExport" class="batch-button">æµ‹è¯•æ‰¹é‡å¯¼å‡º</button>
                <button id="testStress" class="batch-button secondary">å‹åŠ›æµ‹è¯•</button>
                <button id="clearAll" class="batch-button danger">æ¸…é™¤æ‰€æœ‰</button>
            </div>
        </header>

        <section class="batch-section">
            <h2>ğŸ“Š å½“å‰æ‰¹é‡æ“ä½œçŠ¶æ€</h2>
            <div id="currentBatchStatus">
                <p style="color: var(--muted-foreground);">æš‚æ— è¿è¡Œä¸­çš„æ‰¹é‡æ“ä½œ</p>
            </div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
                </div>
            </div>
        </section>

        <section class="batch-section">
            <h2>âš™ï¸ æ‰¹é‡æ“ä½œæ§åˆ¶</h2>
            <div class="controls-grid">
                <div class="control-card">
                    <div class="control-title">æ‰¹é‡ç”Ÿæˆ</div>
                    <p style="font-size: 0.9rem; color: var(--muted-foreground);">è¾“å…¥å¤šä¸ªå¯è§†åŒ–éœ€æ±‚ï¼Œæ¯è¡Œä¸€ä¸ª</p>
                    <textarea id="batchInput" class="batch-input" placeholder="ç¤ºä¾‹ï¼š
ç»˜åˆ¶ä¸€ä¸ªäºŒæ¬¡å‡½æ•°å›¾åƒ
åˆ›å»ºä¸€ä¸ª3Dåˆ†å­ç»“æ„
å±•ç¤ºé‡å­çº ç¼ åŠ¨ç”»
æ¨¡æ‹Ÿæ’æ˜Ÿæ¼”åŒ–è¿‡ç¨‹"></textarea>
                    <div>
                        <button class="batch-button" onclick="startBatchGeneration()">å¼€å§‹æ‰¹é‡ç”Ÿæˆ</button>
                        <button class="batch-button secondary" onclick="pauseCurrentBatch()">æš‚åœ</button>
                        <button class="batch-button secondary" onclick="resumeCurrentBatch()">æ¢å¤</button>
                        <button class="batch-button danger" onclick="cancelCurrentBatch()">å–æ¶ˆ</button>
                    </div>
                </div>

                <div class="control-card">
                    <div class="control-title">æ‰¹é‡å‚æ•°è°ƒæ•´</div>
                    <p style="font-size: 0.9rem; color: var(--muted-foreground);">é€‰æ‹©å‚æ•°ç±»å‹å’Œè°ƒæ•´æ–¹å¼</p>
                    <select id="paramType" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; border: 1px solid var(--border);">
                        <option value="color">é¢œè‰²æ–¹æ¡ˆ</option>
                        <option value="scale">ç¼©æ”¾æ¯”ä¾‹</option>
                        <option value="animation">åŠ¨ç”»é€Ÿåº¦</option>
                        <option value="resolution">åˆ†è¾¨ç‡</option>
                    </select>
                    <input type="range" id="paramValue" min="0" max="100" value="50" style="width: 100%; margin: 0.5rem 0;">
                    <button class="batch-button" onclick="batchAdjustParameters()">æ‰¹é‡è°ƒæ•´å‚æ•°</button>
                </div>

                <div class="control-card">
                    <div class="control-title">æ‰¹é‡å¯¼å‡º</div>
                    <p style="font-size: 0.9rem; color: var(--muted-foreground);">é€‰æ‹©å¯¼å‡ºæ ¼å¼å’Œé€‰é¡¹</p>
                    <div class="export-options">
                        <select id="exportFormat" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);">
                            <option value="png">PNGå›¾ç‰‡</option>
                            <option value="svg">SVGçŸ¢é‡å›¾</option>
                            <option value="pdf">PDFæ–‡æ¡£</option>
                            <option value="json">JSONæ•°æ®</option>
                        </select>
                        <label>
                            <input type="checkbox" id="includeData" checked>
                            åŒ…å«æ•°æ®
                        </label>
                    </div>
                    <button class="batch-button" onclick="batchExport()">æ‰¹é‡å¯¼å‡º</button>
                </div>
            </div>
        </section>

        <section class="batch-section">
            <h2>ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div id="totalBatches" class="metric-value">0</div>
                    <div class="metric-label">æ€»æ‰¹é‡æ•°</div>
                </div>
                <div class="metric-card">
                    <div id="completedBatches" class="metric-value">0</div>
                    <div class="metric-label">å·²å®Œæˆ</div>
                </div>
                <div class="metric-card">
                    <div id="successRate" class="metric-value">0%</div>
                    <div class="metric-label">æˆåŠŸç‡</div>
                </div>
                <div class="metric-card">
                    <div id="avgDuration" class="metric-value">0s</div>
                    <div class="metric-label">å¹³å‡è€—æ—¶</div>
                </div>
                <div class="metric-card">
                    <div id="concurrentOps" class="metric-value">0</div>
                    <div class="metric-label">å¹¶å‘æ“ä½œ</div>
                </div>
                <div class="metric-card">
                    <div id="queueLength" class="metric-value">0</div>
                    <div class="metric-label">é˜Ÿåˆ—é•¿åº¦</div>
                </div>
            </div>
        </section>

        <section class="batch-section">
            <h2>ğŸ“‹ æ‰¹é‡æ“ä½œå†å²</h2>
            <table class="batch-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åç§°</th>
                        <th>é¡¹ç›®æ•°</th>
                        <th>çŠ¶æ€</th>
                        <th>è¿›åº¦</th>
                        <th>è€—æ—¶</th>
                        <th>æˆåŠŸç‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="batchHistory">
                    <tr>
                        <td colspan="8" style="text-align: center; color: var(--muted-foreground);">æš‚æ— å†å²è®°å½•</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section class="batch-section">
            <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
            <div id="batchLog" class="log-container">ç­‰å¾…æ‰¹é‡æ“ä½œå¼€å§‹...</div>
        </section>
    </div>

    <div id="notification" class="notification"></div>

    <script src="../components/BatchOperations.js"></script>
    <script src="../components/ApiClient.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let batchOps;
        let batchManager;
        let currentBatch = null;
        let batchHistory = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            batchOps = new BatchOperations();
            batchManager = new BatchManager();

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            batchOps.addEventListener('batchStart', onBatchStart);
            batchOps.addEventListener('batchProgress', onBatchProgress);
            batchOps.addEventListener('batchComplete', onBatchComplete);
            batchOps.addEventListener('batchError', onBatchError);
            batchOps.addEventListener('itemComplete', onItemComplete);
            batchOps.addEventListener('itemError', onItemError);

            log('æ‰¹é‡æ“ä½œç³»ç»Ÿå·²åˆå§‹åŒ–');
            updateMetrics();
        });

        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('batchLog');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(progress) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = progress + '%';
            progressFill.textContent = progress + '%';
        }

        // æ›´æ–°å½“å‰æ‰¹é‡çŠ¶æ€
        function updateCurrentBatchStatus() {
            const statusDiv = document.getElementById('currentBatchStatus');

            if (currentBatch) {
                const stats = batchOps.getBatchStats(currentBatch);
                statusDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div><strong>æ‰¹é‡ID:</strong> ${currentBatch.id}</div>
                        <div><strong>çŠ¶æ€:</strong> ${getStatusText(currentBatch.status)}</div>
                        <div><strong>é¡¹ç›®æ•°:</strong> ${stats.total}</div>
                        <div><strong>å·²å®Œæˆ:</strong> ${stats.completed}</div>
                        <div><strong>å¤±è´¥:</strong> ${stats.failed}</div>
                        <div><strong>æˆåŠŸç‡:</strong> ${stats.successRate}%</div>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = '<p style="color: var(--muted-foreground);">æš‚æ— è¿è¡Œä¸­çš„æ‰¹é‡æ“ä½œ</p>';
            }
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'created': 'å·²åˆ›å»º',
                'running': 'è¿è¡Œä¸­',
                'paused': 'å·²æš‚åœ',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        // æ‰¹é‡ç”Ÿæˆå¯è§†åŒ–
        async function startBatchGeneration() {
            const input = document.getElementById('batchInput').value.trim();
            if (!input) {
                showNotification('è¯·è¾“å…¥æ‰¹é‡ç”Ÿæˆå†…å®¹', 'warning');
                return;
            }

            const requests = input.split('\n')
                .filter(line => line.trim())
                .map(line => ({
                    input: line.trim(),
                    type: 'auto',
                    parameters: {}
                }));

            if (requests.length === 0) {
                showNotification('æ²¡æœ‰æœ‰æ•ˆçš„ç”Ÿæˆè¯·æ±‚', 'warning');
                return;
            }

            log(`å¼€å§‹æ‰¹é‡ç”Ÿæˆï¼Œå…± ${requests.length} ä¸ªé¡¹ç›®`);
            showNotification(`å¼€å§‹æ‰¹é‡ç”Ÿæˆ ${requests.length} ä¸ªå¯è§†åŒ–`, 'info');

            try {
                currentBatch = batchOps.createBatch(requests, {
                    priority: 'normal',
                    maxConcurrent: 2,
                    timeout: 60000
                });

                updateCurrentBatchStatus();

                // æ¨¡æ‹Ÿå¤„ç†å‡½æ•°
                const mockProcessor = async (request, item, batch) => {
                    // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
                    const delay = Math.random() * 3000 + 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));

                    // æ¨¡æ‹ŸæˆåŠŸç‡ 90%
                    if (Math.random() > 0.1) {
                        return {
                            id: `viz-${item.id}`,
                            type: 'visualization',
                            content: `ç”Ÿæˆçš„å¯è§†åŒ–å†…å®¹: ${request.input}`,
                            url: `#visualization/${item.id}`,
                            metadata: {
                                generatedAt: new Date().toISOString(),
                                processingTime: delay
                            }
                        };
                    } else {
                        throw new Error('æ¨¡æ‹Ÿç”Ÿæˆå¤±è´¥');
                    }
                };

                const result = await batchOps.executeBatch(currentBatch, mockProcessor);

                log(`æ‰¹é‡ç”Ÿæˆå®Œæˆ: ${result.completedItems}/${result.totalItems} æˆåŠŸ`);
                showNotification(`æ‰¹é‡ç”Ÿæˆå®Œæˆï¼ŒæˆåŠŸç‡ ${Math.round((result.completedItems / result.totalItems) * 100)}%`, 'success');

            } catch (error) {
                log(`æ‰¹é‡ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
                showNotification(`æ‰¹é‡ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
            }

            updateHistory();
            updateMetrics();
        }

        // æ‰¹é‡å‚æ•°è°ƒæ•´
        async function batchAdjustParameters() {
            if (!currentBatch || currentBatch.status !== 'completed') {
                showNotification('è¯·å…ˆå®Œæˆä¸€ä¸ªæ‰¹é‡ç”Ÿæˆæ“ä½œ', 'warning');
                return;
            }

            const paramType = document.getElementById('paramType').value;
            const paramValue = document.getElementById('paramValue').value;

            log(`å¼€å§‹æ‰¹é‡è°ƒæ•´å‚æ•°: ${paramType} = ${paramValue}`);

            const completedItems = currentBatch.items.filter(item => item.status === 'completed');
            const adjustments = completedItems.map(item => ({
                visualizationId: item.result.id,
                parameters: item.result.parameters || {},
                adjustments: {
                    [paramType]: paramValue
                }
            }));

            try {
                const result = await batchOps.batchAdjustParameters(adjustments, {
                    priority: 'high',
                    maxConcurrent: 5
                });

                log(`æ‰¹é‡å‚æ•°è°ƒæ•´å®Œæˆ: ${result.completedItems}/${result.totalItems} æˆåŠŸ`);
                showNotification('æ‰¹é‡å‚æ•°è°ƒæ•´å®Œæˆ', 'success');

            } catch (error) {
                log(`æ‰¹é‡å‚æ•°è°ƒæ•´å¤±è´¥: ${error.message}`, 'error');
                showNotification(`æ‰¹é‡å‚æ•°è°ƒæ•´å¤±è´¥: ${error.message}`, 'error');
            }

            updateHistory();
            updateMetrics();
        }

        // æ‰¹é‡å¯¼å‡º
        async function batchExport() {
            if (!currentBatch || currentBatch.status !== 'completed') {
                showNotification('è¯·å…ˆå®Œæˆä¸€ä¸ªæ‰¹é‡ç”Ÿæˆæ“ä½œ', 'warning');
                return;
            }

            const format = document.getElementById('exportFormat').value;
            const includeData = document.getElementById('includeData').checked;

            log(`å¼€å§‹æ‰¹é‡å¯¼å‡ºï¼Œæ ¼å¼: ${format}`);

            const completedItems = currentBatch.items.filter(item => item.status === 'completed');
            const exports = completedItems.map(item => ({
                visualizationId: item.result.id,
                format,
                exportOptions: {
                    includeData,
                    quality: 'high'
                }
            }));

            try {
                const result = await batchOps.batchExport(exports, format, {
                    priority: 'normal',
                    maxConcurrent: 3
                });

                // ä¸‹è½½å¯¼å‡ºç»“æœ
                const exportBlob = await batchOps.exportBatchResults(currentBatch, 'json');
                const url = URL.createObjectURL(exportBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `batch-export-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                log(`æ‰¹é‡å¯¼å‡ºå®Œæˆ: ${result.completedItems}/${result.totalItems} æˆåŠŸ`);
                showNotification('æ‰¹é‡å¯¼å‡ºå®Œæˆï¼Œæ–‡ä»¶å·²ä¸‹è½½', 'success');

            } catch (error) {
                log(`æ‰¹é‡å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
                showNotification(`æ‰¹é‡å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }

            updateHistory();
            updateMetrics();
        }

        // æš‚åœå½“å‰æ‰¹é‡
        function pauseCurrentBatch() {
            if (currentBatch && currentBatch.status === 'running') {
                batchOps.pauseBatch();
                log('æ‰¹é‡æ“ä½œå·²æš‚åœ');
                showNotification('æ‰¹é‡æ“ä½œå·²æš‚åœ', 'info');
                updateCurrentBatchStatus();
            }
        }

        // æ¢å¤å½“å‰æ‰¹é‡
        function resumeCurrentBatch() {
            if (currentBatch && currentBatch.status === 'paused') {
                batchOps.resumeBatch();
                log('æ‰¹é‡æ“ä½œå·²æ¢å¤');
                showNotification('æ‰¹é‡æ“ä½œå·²æ¢å¤', 'info');
                updateCurrentBatchStatus();
            }
        }

        // å–æ¶ˆå½“å‰æ‰¹é‡
        function cancelCurrentBatch() {
            if (currentBatch && (currentBatch.status === 'running' || currentBatch.status === 'paused')) {
                batchOps.cancelBatch();
                log('æ‰¹é‡æ“ä½œå·²å–æ¶ˆ');
                showNotification('æ‰¹é‡æ“ä½œå·²å–æ¶ˆ', 'warning');
                currentBatch = null;
                updateCurrentBatchStatus();
                updateProgress(0);
            }
        }

        // æ›´æ–°å†å²è®°å½•
        function updateHistory() {
            const history = batchOps.getBatchHistory();
            const tbody = document.getElementById('batchHistory');

            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--muted-foreground);">æš‚æ— å†å²è®°å½•</td></tr>';
                return;
            }

            tbody.innerHTML = '';

            history.slice(0, 10).forEach(batch => {
                const row = tbody.insertRow();
                const stats = batchOps.getBatchStats(batch);

                row.innerHTML = `
                    <td><code>${batch.id.substr(-8)}</code></td>
                    <td>æ‰¹é‡ç”Ÿæˆ</td>
                    <td>${batch.totalItems}</td>
                    <td>
                        <span class="status-indicator ${batch.status}"></span>
                        ${getStatusText(batch.status)}
                    </td>
                    <td>
                        <div class="progress-bar" style="height: 8px; width: 100px;">
                            <div style="width: ${stats.progress}%; height: 100%; background: var(--primary);"></div>
                        </div>
                        ${stats.progress}%
                    </td>
                    <td>${(stats.totalDuration / 1000).toFixed(1)}s</td>
                    <td>${stats.successRate}%</td>
                    <td>
                        <button class="batch-button" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;"
                                onclick="exportBatchResult('${batch.id}')">å¯¼å‡º</button>
                        <button class="batch-button danger" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;"
                                onclick="deleteBatchHistory('${batch.id}')">åˆ é™¤</button>
                    </td>
                `;
            });
        }

        // å¯¼å‡ºæ‰¹é‡ç»“æœ
        async function exportBatchResult(batchId) {
            const batch = batchHistory.find(b => b.id === batchId);
            if (!batch) return;

            try {
                const exportBlob = await batchOps.exportBatchResults(batch, 'json');
                const url = URL.createObjectURL(exportBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `batch-result-${batchId.substr(-8)}.json`;
                a.click();
                URL.revokeObjectURL(url);

                showNotification('æ‰¹é‡ç»“æœå·²å¯¼å‡º', 'success');
            } catch (error) {
                showNotification('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤æ‰¹é‡å†å²
        function deleteBatchHistory(batchId) {
            batchHistory = batchHistory.filter(b => b.id !== batchId);
            updateHistory();
            updateMetrics();
            showNotification('å†å²è®°å½•å·²åˆ é™¤', 'info');
        }

        // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
        function updateMetrics() {
            const history = batchOps.getBatchHistory();
            const systemStatus = batchOps.getSystemStatus();

            document.getElementById('totalBatches').textContent = history.length;
            document.getElementById('completedBatches').textContent = history.filter(b => b.status === 'completed').length;

            const successRate = history.length > 0
                ? Math.round((history.filter(b => b.status === 'completed').length / history.length) * 100)
                : 0;
            document.getElementById('successRate').textContent = successRate + '%';

            const avgDuration = history.filter(b => b.endTime).length > 0
                ? history.filter(b => b.endTime).reduce((sum, b) => sum + (b.endTime - b.startTime), 0) / history.filter(b => b.endTime).length
                : 0;
            document.getElementById('avgDuration').textContent = (avgDuration / 1000).toFixed(1) + 's';

            document.getElementById('concurrentOps').textContent = systemStatus.isProcessing ? '1' : '0';
            document.getElementById('queueLength').textContent = systemStatus.queueLength;
        }

        // å‹åŠ›æµ‹è¯•
        async function runStressTest() {
            log('å¼€å§‹å‹åŠ›æµ‹è¯•...');
            showNotification('å‹åŠ›æµ‹è¯•å¼€å§‹', 'info');

            const itemCount = 50;
            const requests = Array.from({ length: itemCount }, (_, i) => ({
                input: `å‹åŠ›æµ‹è¯•é¡¹ç›® ${i + 1}`,
                type: 'test',
                parameters: { index: i + 1 }
            }));

            try {
                const batch = batchOps.createBatch(requests, {
                    priority: 'low',
                    maxConcurrent: 5,
                    timeout: 10000
                });

                const stressProcessor = async (request, item, batch) => {
                    const delay = Math.random() * 2000 + 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return { id: item.id, processed: true, delay };
                };

                const result = await batchOps.executeBatch(batch, stressProcessor);

                log(`å‹åŠ›æµ‹è¯•å®Œæˆ: ${result.completedItems}/${result.totalItems} æˆåŠŸ`);
                showNotification(`å‹åŠ›æµ‹è¯•å®Œæˆï¼ŒæˆåŠŸç‡ ${Math.round((result.completedItems / result.totalItems) * 100)}%`, 'success');

            } catch (error) {
                log(`å‹åŠ›æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showNotification(`å‹åŠ›æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }

            updateHistory();
            updateMetrics();
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                currentBatch = null;
                batchHistory = [];
                document.getElementById('batchInput').value = '';
                document.getElementById('batchLog').textContent = 'ç­‰å¾…æ‰¹é‡æ“ä½œå¼€å§‹...';
                updateProgress(0);
                updateCurrentBatchStatus();
                updateHistory();
                updateMetrics();
                showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'info');
                log('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
            }
        }

        // äº‹ä»¶å¤„ç†å™¨
        function onBatchStart(data) {
            log(`æ‰¹é‡æ“ä½œå¼€å§‹: ${data.id}`);
            updateCurrentBatchStatus();
        }

        function onBatchProgress(data) {
            updateProgress(data.progress);
            updateCurrentBatchStatus();
        }

        function onBatchComplete(data) {
            log(`æ‰¹é‡æ“ä½œå®Œæˆ: ${data.id}`);
            updateProgress(100);
            updateCurrentBatchStatus();
            batchHistory.push(data);
        }

        function onBatchError(data) {
            log(`æ‰¹é‡æ“ä½œå¤±è´¥: ${data.error.message}`, 'error');
            updateCurrentBatchStatus();
            batchHistory.push(data.batch);
        }

        function onItemComplete(data) {
            log(`é¡¹ç›®å®Œæˆ: ${data.item.id}`);
        }

        function onItemError(data) {
            log(`é¡¹ç›®å¤±è´¥: ${data.item.id} - ${data.error.message}`, 'error');
        }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('testBatchGeneration').addEventListener('click', () => {
            document.getElementById('batchInput').value = `ç»˜åˆ¶ä¸€ä¸ªäºŒæ¬¡å‡½æ•° y = xÂ²
åˆ›å»ºä¸€ä¸ª3Dåˆ†å­ç»“æ„æ¨¡å‹
å±•ç¤ºé‡å­çº ç¼ åŠ¨ç”»æ•ˆæœ
æ¨¡æ‹Ÿæ’æ˜Ÿæ¼”åŒ–è¿‡ç¨‹
ç»˜åˆ¶æ­£æ€åˆ†å¸ƒæ›²çº¿
åˆ›å»ºç”µç£åœºå¯è§†åŒ–
æ˜¾ç¤ºå®‡å®™è†¨èƒ€æ—¶é—´çº¿
åˆ¶ä½œåŒ–å­¦ååº”åŠ¨åŠ›å­¦å›¾`;
            startBatchGeneration();
        });

        document.getElementById('testBatchParams').addEventListener('click', () => {
            document.getElementById('paramType').value = 'color';
            document.getElementById('paramValue').value = 75;
            batchAdjustParameters();
        });

        document.getElementById('testBatchExport').addEventListener('click', () => {
            document.getElementById('exportFormat').value = 'json';
            batchExport();
        });

        document.getElementById('testStress').addEventListener('click', runStressTest);
        document.getElementById('clearAll').addEventListener('click', clearAll);
    </script>
</body>
</html>