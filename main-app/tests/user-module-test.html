<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·å¯è§†åŒ–æ¨¡å—æµ‹è¯•é¡µé¢</title>

    <!-- å¼•å…¥CSSæ ·å¼ -->
    <link rel="stylesheet" href="../assets/css/user-module.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .test-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .test-header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .test-header p {
            margin: 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .test-nav {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            overflow-x: auto;
        }

        .test-nav button {
            padding: 15px 25px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .test-nav button:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .test-nav button.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: white;
        }

        .test-content {
            padding: 30px;
            min-height: 500px;
        }

        .test-section {
            display: none;
        }

        .test-section.active {
            display: block;
        }

        .test-result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .test-result.success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #166534;
        }

        .test-result.error {
            background: #fef2f2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .test-result.info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .test-controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .test-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .test-btn.primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .test-btn.secondary {
            background: #64748b;
            color: white;
        }

        .test-btn.secondary:hover {
            background: #475569;
        }

        .test-btn.success {
            background: #22c55e;
            color: white;
        }

        .test-btn.danger {
            background: #ef4444;
            color: white;
        }

        .code-block {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 15px 0;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .status-indicator.loading {
            background: #fef3c7;
            color: #92400e;
        }

        .status-indicator.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-indicator.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .demo-container {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f8fafc;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #64748b;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .test-controls {
                flex-direction: column;
            }

            .test-btn {
                width: 100%;
                justify-content: center;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <header class="test-header">
            <h1><i class="fas fa-flask"></i> ç”¨æˆ·å¯è§†åŒ–æ¨¡å—æµ‹è¯•</h1>
            <p>å…¨é¢æµ‹è¯•æ•°æ®æ¨¡å‹ã€æœåŠ¡å±‚ã€ç»„ä»¶å’ŒUIåŸºç¡€è®¾æ–½</p>
        </header>

        <nav class="test-nav">
            <button class="active" onclick="showSection('overview')">
                <i class="fas fa-home"></i> æ¦‚è§ˆ
            </button>
            <button onclick="showSection('models')">
                <i class="fas fa-database"></i> æ•°æ®æ¨¡å‹
            </button>
            <button onclick="showSection('services')">
                <i class="fas fa-cogs"></i> æœåŠ¡å±‚
            </button>
            <button onclick="showSection('components')">
                <i class="fas fa-cube"></i> ç»„ä»¶
            </button>
            <button onclick="showSection('ui')">
                <i class="fas fa-palette"></i> UIä¸»é¢˜
            </button>
            <button onclick="showSection('integration')">
                <i class="fas fa-plug"></i> é›†æˆæµ‹è¯•
            </button>
        </nav>

        <div class="test-content">
            <!-- æ¦‚è§ˆéƒ¨åˆ† -->
            <section id="overview" class="test-section active">
                <h2><i class="fas fa-chart-line"></i> æµ‹è¯•æ¦‚è§ˆ</h2>

                <div class="status-indicator loading" id="overall-status">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>æ­£åœ¨åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...</span>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="overall-progress" style="width: 0%"></div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="modules-count">0</div>
                        <div class="metric-label">å·²åŠ è½½æ¨¡å—</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="tests-passed">0</div>
                        <div class="metric-label">é€šè¿‡æµ‹è¯•</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="tests-failed">0</div>
                        <div class="metric-label">å¤±è´¥æµ‹è¯•</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="performance-score">--</div>
                        <div class="metric-label">æ€§èƒ½è¯„åˆ†</div>
                    </div>
                </div>

                <div class="test-controls">
                    <button class="test-btn primary" onclick="runAllTests()">
                        <i class="fas fa-play"></i> è¿è¡Œæ‰€æœ‰æµ‹è¯•
                    </button>
                    <button class="test-btn secondary" onclick="quickCheck()">
                        <i class="fas fa-bolt"></i> å¿«é€Ÿæ£€æŸ¥
                    </button>
                    <button class="test-btn success" onclick="generateReport()">
                        <i class="fas fa-file-alt"></i> ç”ŸæˆæŠ¥å‘Š
                    </button>
                    <button class="test-btn danger" onclick="resetTests()">
                        <i class="fas fa-redo"></i> é‡ç½®æµ‹è¯•
                    </button>
                </div>

                <div id="overview-results"></div>
            </section>

            <!-- æ•°æ®æ¨¡å‹æµ‹è¯•éƒ¨åˆ† -->
            <section id="models" class="test-section">
                <h2><i class="fas fa-database"></i> æ•°æ®æ¨¡å‹æµ‹è¯•</h2>

                <h3>UserProject æ¨¡å‹æµ‹è¯•</h3>
                <div class="test-controls">
                    <button class="test-btn primary" onclick="testUserProjectCreation()">
                        <i class="fas fa-plus"></i> æµ‹è¯•é¡¹ç›®åˆ›å»º
                    </button>
                    <button class="test-btn secondary" onclick="testUserProjectValidation()">
                        <i class="fas fa-check"></i> æµ‹è¯•æ•°æ®éªŒè¯
                    </button>
                    <button class="test-btn secondary" onclick="testUserProjectPermissions()">
                        <i class="fas fa-shield-alt"></i> æµ‹è¯•æƒé™æ§åˆ¶
                    </button>
                </div>

                <h3>UserFavorite æ¨¡å‹æµ‹è¯•</h3>
                <div class="test-controls">
                    <button class="test-btn primary" onclick="testUserFavorite()">
                        <i class="fas fa-star"></i> æµ‹è¯•æ”¶è—åŠŸèƒ½
                    </button>
                </div>

                <h3>UserAnalytics æ¨¡å‹æµ‹è¯•</h3>
                <div class="test-controls">
                    <button class="test-btn primary" onclick="testUserAnalytics()">
                        <i class="fas fa-chart-bar"></i> æµ‹è¯•åˆ†æåŠŸèƒ½
                    </button>
                </div>

                <div id="models-results"></div>
            </section>

            <!-- æœåŠ¡å±‚æµ‹è¯•éƒ¨åˆ† -->
            <section id="services" class="test-section">
                <h2><i class="fas fa-cogs"></i> æœåŠ¡å±‚æµ‹è¯•</h2>

                <h3>UserDataService æµ‹è¯•</h3>
                <div class="test-controls">
                    <button class="test-btn primary" onclick="testUserDataService()">
                        <i class="fas fa-user"></i> æµ‹è¯•ç”¨æˆ·æ•°æ®æœåŠ¡
                    </button>
                </div>

                <h3>ProjectDataService æµ‹è¯•</h3>
                <div class="test-controls">
                    <button class="test-btn primary" onclick="testProjectDataService()">
                        <i class="fas fa-project-diagram"></i> æµ‹è¯•é¡¹ç›®æ•°æ®æœåŠ¡
                    </button>
                </div>

                <h3>CacheManager æµ‹è¯•</h3>
                <div class="test-controls">
                    <button class="test-btn primary" onclick="testCacheManager()">
                        <i class="fas fa-memory"></i> æµ‹è¯•ç¼“å­˜ç®¡ç†
                    </button>
                </div>

                <div id="services-results"></div>
            </section>

            <!-- ç»„ä»¶æµ‹è¯•éƒ¨åˆ† -->
            <section id="components" class="test-section">
                <h2><i class="fas fa-cube"></i> ç»„ä»¶æµ‹è¯•</h2>

                <div class="demo-container" id="component-demo">
                    <p>ç»„ä»¶æ¼”ç¤ºåŒºåŸŸå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                </div>

                <div class="test-controls">
                    <button class="test-btn primary" onclick="testUserDashboard()">
                        <i class="fas fa-tachometer-alt"></i> æµ‹è¯•å·¥ä½œå°ç»„ä»¶
                    </button>
                    <button class="test-btn secondary" onclick="testProjectManager()">
                        <i class="fas fa-folder-open"></i> æµ‹è¯•é¡¹ç›®ç®¡ç†å™¨
                    </button>
                    <button class="test-btn secondary" onclick="testUserRouter()">
                        <i class="fas fa-route"></i> æµ‹è¯•è·¯ç”±ç®¡ç†
                    </button>
                </div>

                <div id="components-results"></div>
            </section>

            <!-- UIä¸»é¢˜æµ‹è¯•éƒ¨åˆ† -->
            <section id="ui" class="test-section">
                <h2><i class="fas fa-palette"></i> UIå’Œä¸»é¢˜æµ‹è¯•</h2>

                <h3>ä¸»é¢˜åˆ‡æ¢æµ‹è¯•</h3>
                <div class="test-controls">
                    <button class="test-btn primary" onclick="setTheme('light')">
                        <i class="fas fa-sun"></i> æµ…è‰²ä¸»é¢˜
                    </button>
                    <button class="test-btn secondary" onclick="setTheme('dark')">
                        <i class="fas fa-moon"></i> æ·±è‰²ä¸»é¢˜
                    </button>
                    <button class="test-btn secondary" onclick="setTheme('auto')">
                        <i class="fas fa-adjust"></i> è‡ªåŠ¨ä¸»é¢˜
                    </button>
                </div>

                <h3>å¸ƒå±€ç»„ä»¶æµ‹è¯•</h3>
                <div class="test-controls">
                    <button class="test-btn primary" onclick="testUserLayout()">
                        <i class="fas fa-th-large"></i> æµ‹è¯•å¸ƒå±€ç»„ä»¶
                    </button>
                </div>

                <div class="demo-container" id="ui-demo">
                    <div class="user-layout-preview">
                        <p>UIä¸»é¢˜æ¼”ç¤ºåŒºåŸŸ</p>
                    </div>
                </div>

                <div id="ui-results"></div>
            </section>

            <!-- é›†æˆæµ‹è¯•éƒ¨åˆ† -->
            <section id="integration" class="test-section">
                <h2><i class="fas fa-plug"></i> é›†æˆæµ‹è¯•</h2>

                <h3>ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•</h3>
                <div class="test-controls">
                    <button class="test-btn primary" onclick="testE2EFlow()">
                        <i class="fas fa-arrow-right"></i> å®Œæ•´æµç¨‹æµ‹è¯•
                    </button>
                </div>

                <h3>æ€§èƒ½æµ‹è¯•</h3>
                <div class="test-controls">
                    <button class="test-btn primary" onclick="testPerformance()">
                        <i class="fas fa-tachometer-alt"></i> æ€§èƒ½æµ‹è¯•
                    </button>
                </div>

                <div id="integration-results"></div>
            </section>
        </div>
    </div>

    <!-- å¼•å…¥JavaScriptæ¨¡å— -->
    <script src="../models/UserProject.js"></script>
    <script src="../models/UserFavorite.js"></script>
    <script src="../models/UserAnalytics.js"></script>
    <script src="../models/DataValidator.js"></script>
    <script src="../utils/LocalStorageManager.js"></script>
    <script src="../services/UserDataService.js"></script>
    <script src="../services/ProjectDataService.js"></script>
    <script src="../utils/CacheManager.js"></script>
    <script src="../components/UserDashboard.js"></script>
    <script src="../components/ProjectManager.js"></script>
    <script src="../router/UserRouter.js"></script>
    <script src="../components/UserLayout.js"></script>
    <script src="../utils/ThemeManager.js"></script>

    <script>
        // æµ‹è¯•çŠ¶æ€ç®¡ç†
        const testState = {
            totalTests: 0,
            passedTests: 0,
            failedTests: 0,
            currentTest: null,
            results: []
        };

        // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        function initTestEnvironment() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...');

            // æ£€æŸ¥å¿…è¦çš„å…¨å±€å¯¹è±¡
            const requiredModules = [
                'UserProject', 'UserFavorite', 'UserAnalytics', 'DataValidator',
                'LocalStorageManager', 'UserDataService', 'ProjectDataService', 'CacheManager',
                'UserDashboard', 'ProjectManager', 'UserRouter', 'UserLayout', 'ThemeManager'
            ];

            let loadedCount = 0;
            const missingModules = [];

            requiredModules.forEach(moduleName => {
                if (window[moduleName]) {
                    loadedCount++;
                    console.log(`âœ… ${moduleName} å·²åŠ è½½`);
                } else {
                    missingModules.push(moduleName);
                    console.log(`âŒ ${moduleName} æœªåŠ è½½`);
                }
            });

            // æ›´æ–°UI
            document.getElementById('modules-count').textContent = loadedCount;

            const statusEl = document.getElementById('overall-status');
            if (missingModules.length === 0) {
                statusEl.className = 'status-indicator success';
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i><span>æ‰€æœ‰æ¨¡å—åŠ è½½æˆåŠŸ</span>';

                addTestResult('success', 'ç¯å¢ƒåˆå§‹åŒ–', `æˆåŠŸåŠ è½½ ${loadedCount} ä¸ªæ¨¡å—`);

                // è‡ªåŠ¨è¿è¡Œå¿«é€Ÿæ£€æŸ¥
                setTimeout(quickCheck, 1000);
            } else {
                statusEl.className = 'status-indicator error';
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>éƒ¨åˆ†æ¨¡å—åŠ è½½å¤±è´¥</span>';

                addTestResult('error', 'ç¯å¢ƒåˆå§‹åŒ–', `ç¼ºå°‘æ¨¡å—: ${missingModules.join(', ')}`);
            }
        }

        // æ˜¾ç¤ºæµ‹è¯•éƒ¨åˆ†
        function showSection(sectionId) {
            // éšè—æ‰€æœ‰éƒ¨åˆ†
            document.querySelectorAll('.test-section').forEach(section => {
                section.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­éƒ¨åˆ†
            document.getElementById(sectionId).classList.add('active');

            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.test-nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(type, title, message) {
            const resultsContainer = document.getElementById(
                document.querySelector('.test-section.active').id + '-results'
            );

            if (resultsContainer) {
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${type}`;
                resultDiv.innerHTML = `
                    <strong>${title}</strong>
                    <p>${message}</p>
                    <small>æ—¶é—´: ${new Date().toLocaleTimeString()}</small>
                `;

                resultsContainer.appendChild(resultDiv);
                resultsContainer.scrollTop = resultsContainer.scrollHeight;
            }

            // æ›´æ–°ç»Ÿè®¡
            testState.totalTests++;
            if (type === 'success') {
                testState.passedTests++;
            } else if (type === 'error') {
                testState.failedTests++;
            }

            updateTestStats();
        }

        // æ›´æ–°æµ‹è¯•ç»Ÿè®¡
        function updateTestStats() {
            document.getElementById('tests-passed').textContent = testState.passedTests;
            document.getElementById('tests-failed').textContent = testState.failedTests;

            const progress = testState.totalTests > 0 ?
                (testState.passedTests / testState.totalTests * 100) : 0;
            document.getElementById('overall-progress').style.width = `${progress}%`;
        }

        // å¿«é€Ÿæ£€æŸ¥
        async function quickCheck() {
            console.log('âš¡ å¼€å§‹å¿«é€Ÿæ£€æŸ¥...');

            try {
                // æ£€æŸ¥æ•°æ®æ¨¡å‹
                if (window.UserProject) {
                    const testProject = new UserProject({
                        userId: 'test-user',
                        title: 'æµ‹è¯•é¡¹ç›®'
                    });
                    addTestResult('success', 'UserProjectæ¨¡å‹', 'é¡¹ç›®åˆ›å»ºæˆåŠŸ');
                }

                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
                if (window.localStorageManager) {
                    localStorageManager.setItem('test-key', 'test-value');
                    const value = localStorageManager.getItem('test-key');
                    if (value === 'test-value') {
                        addTestResult('success', 'LocalStorageManager', 'å­˜å‚¨è¯»å†™æ­£å¸¸');
                    }
                }

                // æ£€æŸ¥ä¸»é¢˜ç®¡ç†å™¨
                if (window.themeManager) {
                    const currentTheme = themeManager.getCurrentTheme();
                    addTestResult('success', 'ThemeManager', `å½“å‰ä¸»é¢˜: ${currentTheme}`);
                }

                console.log('âœ… å¿«é€Ÿæ£€æŸ¥å®Œæˆ');

            } catch (error) {
                addTestResult('error', 'å¿«é€Ÿæ£€æŸ¥', `é”™è¯¯: ${error.message}`);
                console.error('å¿«é€Ÿæ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•UserProjectæ¨¡å‹
        function testUserProjectCreation() {
            try {
                console.log('ğŸ§ª æµ‹è¯•UserProjectåˆ›å»º...');

                const project = new UserProject({
                    userId: 'test-user-123',
                    title: 'æµ‹è¯•å¯è§†åŒ–é¡¹ç›®',
                    description: 'è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•çš„é¡¹ç›®',
                    category: 'mathematics',
                    tags: ['æµ‹è¯•', 'æ•°å­¦', 'å¯è§†åŒ–']
                });

                // éªŒè¯é¡¹ç›®æ•°æ®
                if (project.id && project.userId === 'test-user-123') {
                    addTestResult('success', 'é¡¹ç›®åˆ›å»º',
                        `é¡¹ç›®ID: ${project.id}, æ ‡é¢˜: ${project.title}`);

                    // æµ‹è¯•é¡¹ç›®æ›´æ–°
                    project.updateContent({
                        components: [{ type: 'test', config: {} }]
                    });

                    addTestResult('success', 'é¡¹ç›®æ›´æ–°', 'å†…å®¹æ›´æ–°æˆåŠŸ');

                    // æµ‹è¯•é¡¹ç›®çŠ¶æ€åˆ‡æ¢
                    project.publish();
                    addTestResult('success', 'é¡¹ç›®å‘å¸ƒ',
                        `çŠ¶æ€: ${project.status}`);

                } else {
                    throw new Error('é¡¹ç›®æ•°æ®ä¸å®Œæ•´');
                }

            } catch (error) {
                addTestResult('error', 'é¡¹ç›®åˆ›å»ºæµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•æ•°æ®éªŒè¯
        function testUserProjectValidation() {
            try {
                console.log('ğŸ§ª æµ‹è¯•æ•°æ®éªŒè¯...');

                // æµ‹è¯•æœ‰æ•ˆæ•°æ®
                const validProject = {
                    userId: 'test-user',
                    title: 'æœ‰æ•ˆé¡¹ç›®',
                    category: 'mathematics'
                };

                const validationResult = window.validator.validate('UserProject', validProject);

                if (validationResult.valid) {
                    addTestResult('success', 'æ•°æ®éªŒè¯', 'æœ‰æ•ˆæ•°æ®éªŒè¯é€šè¿‡');
                } else {
                    addTestResult('error', 'æ•°æ®éªŒè¯',
                        `éªŒè¯å¤±è´¥: ${validationResult.errors.join(', ')}`);
                }

                // æµ‹è¯•æ— æ•ˆæ•°æ®
                const invalidProject = {
                    userId: '', // æ— æ•ˆçš„ç”¨æˆ·ID
                    title: '',  // æ— æ•ˆçš„æ ‡é¢˜
                    category: 'invalid-category' // æ— æ•ˆçš„åˆ†ç±»
                };

                const invalidResult = window.validator.validate('UserProject', invalidProject);

                if (!invalidResult.valid) {
                    addTestResult('success', 'æ•°æ®éªŒè¯',
                        `æ— æ•ˆæ•°æ®æ­£ç¡®æ‹’ç»: ${invalidResult.errors.length} ä¸ªé”™è¯¯`);
                }

            } catch (error) {
                addTestResult('error', 'æ•°æ®éªŒè¯æµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•æƒé™æ§åˆ¶
        function testUserProjectPermissions() {
            try {
                console.log('ğŸ§ª æµ‹è¯•æƒé™æ§åˆ¶...');

                const project = new UserProject({
                    userId: 'owner-user',
                    title: 'æƒé™æµ‹è¯•é¡¹ç›®'
                });

                // æµ‹è¯•æ‰€æœ‰è€…æƒé™
                const hasOwnerPermission = project.hasPermission('owner-user', 'edit');
                if (hasOwnerPermission) {
                    addTestResult('success', 'æƒé™æ§åˆ¶', 'æ‰€æœ‰è€…æƒé™éªŒè¯é€šè¿‡');
                } else {
                    throw new Error('æ‰€æœ‰è€…æƒé™éªŒè¯å¤±è´¥');
                }

                // æµ‹è¯•éæ‰€æœ‰è€…æƒé™
                const hasOtherPermission = project.hasPermission('other-user', 'edit');
                if (!hasOtherPermission) {
                    addTestResult('success', 'æƒé™æ§åˆ¶', 'éæ‰€æœ‰è€…æƒé™æ­£ç¡®æ‹’ç»');
                } else {
                    throw new Error('éæ‰€æœ‰è€…æƒé™éªŒè¯å¤±è´¥');
                }

            } catch (error) {
                addTestResult('error', 'æƒé™æ§åˆ¶æµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•æ”¶è—åŠŸèƒ½
        function testUserFavorite() {
            try {
                console.log('ğŸ§ª æµ‹è¯•æ”¶è—åŠŸèƒ½...');

                const favorite = new UserFavorite({
                    userId: 'test-user',
                    targetType: 'project',
                    targetId: 'project-123'
                });

                if (favorite.id && favorite.userId === 'test-user') {
                    addTestResult('success', 'æ”¶è—åŠŸèƒ½',
                        `æ”¶è—åˆ›å»ºæˆåŠŸ: ${favorite.id}`);

                    // æµ‹è¯•æ”¶è—æ›´æ–°
                    favorite.setRating(5);
                    addTestResult('success', 'æ”¶è—è¯„åˆ†', `è¯„åˆ†: ${favorite.properties.rating}`);

                } else {
                    throw new Error('æ”¶è—æ•°æ®ä¸å®Œæ•´');
                }

            } catch (error) {
                addTestResult('error', 'æ”¶è—åŠŸèƒ½æµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•åˆ†æåŠŸèƒ½
        function testUserAnalytics() {
            try {
                console.log('ğŸ§ª æµ‹è¯•åˆ†æåŠŸèƒ½...');

                const analytics = new UserAnalytics({
                    userId: 'test-user'
                });

                if (analytics.userId === 'test-user') {
                    addTestResult('success', 'åˆ†æåŠŸèƒ½', 'ç”¨æˆ·åˆ†æåˆ›å»ºæˆåŠŸ');

                    // æµ‹è¯•æ—¶é—´çº¿äº‹ä»¶
                    analytics.addTimelineEvent({
                        action: 'create',
                        targetId: 'project-123'
                    });

                    addTestResult('success', 'æ—¶é—´çº¿äº‹ä»¶',
                        `äº‹ä»¶æ•°é‡: ${analytics.timeline.length}`);

                    // æµ‹è¯•ç»Ÿè®¡æ›´æ–°
                    analytics.updateProjectStats('totalProjects', 1);
                    addTestResult('success', 'ç»Ÿè®¡æ›´æ–°',
                        `é¡¹ç›®æ€»æ•°: ${analytics.statistics.totalProjects}`);

                } else {
                    throw new Error('åˆ†ææ•°æ®ä¸å®Œæ•´');
                }

            } catch (error) {
                addTestResult('error', 'åˆ†æåŠŸèƒ½æµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            console.log('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');

            // é‡ç½®æµ‹è¯•çŠ¶æ€
            testState.totalTests = 0;
            testState.passedTests = 0;
            testState.failedTests = 0;

            // æ¸…ç©ºç»“æœ
            document.querySelectorAll('.test-results').forEach(container => {
                container.innerHTML = '';
            });

            // æ›´æ–°çŠ¶æ€
            const statusEl = document.getElementById('overall-status');
            statusEl.className = 'status-indicator loading';
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>æ­£åœ¨è¿è¡Œæµ‹è¯•...</span>';

            // è¿è¡Œå„éƒ¨åˆ†æµ‹è¯•
            await runSectionTests('models');
            await runSectionTests('services');
            await runSectionTests('components');
            await runSectionTests('ui');

            // å®Œæˆæµ‹è¯•
            statusEl.className = testState.failedTests === 0 ?
                'status-indicator success' : 'status-indicator error';
            statusEl.innerHTML = `<i class="fas fa-${testState.failedTests === 0 ? 'check-circle' : 'exclamation-triangle'}"></i>
                <span>æµ‹è¯•å®Œæˆ: ${testState.passedTests}/${testState.totalTests} é€šè¿‡</span>`;

            console.log(`âœ… æµ‹è¯•å®Œæˆ: ${testState.passedTests} é€šè¿‡, ${testState.failedTests} å¤±è´¥`);
        }

        // è¿è¡Œéƒ¨åˆ†æµ‹è¯•
        async function runSectionTests(section) {
            switch(section) {
                case 'models':
                    testUserProjectCreation();
                    testUserProjectValidation();
                    testUserProjectPermissions();
                    testUserFavorite();
                    testUserAnalytics();
                    break;
                case 'services':
                    await testUserDataService();
                    await testProjectDataService();
                    testCacheManager();
                    break;
                case 'components':
                    await testUserDashboard();
                    await testProjectManager();
                    testUserRouter();
                    break;
                case 'ui':
                    testUserLayout();
                    testThemeManager();
                    break;
            }
        }

        // æµ‹è¯•UserDataService
        async function testUserDataService() {
            try {
                console.log('ğŸ§ª æµ‹è¯•UserDataService...');

                if (window.userDataService) {
                    const stats = userDataService.getServiceStats();
                    addTestResult('success', 'UserDataService',
                        `æœåŠ¡çŠ¶æ€æ­£å¸¸, ç¼“å­˜å¤§å°: ${JSON.stringify(stats.cacheSize)}`);
                } else {
                    throw new Error('UserDataServiceæœªåˆå§‹åŒ–');
                }

            } catch (error) {
                addTestResult('error', 'UserDataServiceæµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•ProjectDataService
        async function testProjectDataService() {
            try {
                console.log('ğŸ§ª æµ‹è¯•ProjectDataService...');

                if (window.projectDataService) {
                    const stats = projectDataService.getServiceStats();
                    addTestResult('success', 'ProjectDataService',
                        `æœåŠ¡çŠ¶æ€æ­£å¸¸, æœç´¢ç´¢å¼•: ${stats.searchIndexSize} é¡¹`);
                } else {
                    throw new Error('ProjectDataServiceæœªåˆå§‹åŒ–');
                }

            } catch (error) {
                addTestResult('error', 'ProjectDataServiceæµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•CacheManager
        function testCacheManager() {
            try {
                console.log('ğŸ§ª æµ‹è¯•CacheManager...');

                if (window.cacheManager) {
                    // æµ‹è¯•ç¼“å­˜è®¾ç½®
                    cacheManager.set('test-key', { data: 'test-value' });

                    // æµ‹è¯•ç¼“å­˜è·å–
                    const value = cacheManager.get('test-key');

                    if (value && value.data === 'test-value') {
                        addTestResult('success', 'CacheManager', 'ç¼“å­˜è¯»å†™æ­£å¸¸');
                    } else {
                        throw new Error('ç¼“å­˜è¯»å†™å¤±è´¥');
                    }

                    // è·å–ç¼“å­˜ç»Ÿè®¡
                    const stats = cacheManager.getStats();
                    addTestResult('success', 'ç¼“å­˜ç»Ÿè®¡',
                        `å‘½ä¸­ç‡: ${stats.hitRate}, ç¼“å­˜å¤§å°: ${stats.cacheSize.memory}`);

                } else {
                    throw new Error('CacheManageræœªåˆå§‹åŒ–');
                }

            } catch (error) {
                addTestResult('error', 'CacheManageræµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•UserDashboardç»„ä»¶
        async function testUserDashboard() {
            try {
                console.log('ğŸ§ª æµ‹è¯•UserDashboardç»„ä»¶...');

                const demoContainer = document.getElementById('component-demo');
                if (demoContainer && window.UserDashboard) {
                    // åˆ›å»ºç»„ä»¶å®ä¾‹
                    const dashboard = new UserDashboard(demoContainer, {
                        enableRealTimeUpdates: false
                    });

                    addTestResult('success', 'UserDashboard', 'ç»„ä»¶åˆ›å»ºæˆåŠŸ');

                    // æµ‹è¯•ç»„ä»¶æ–¹æ³•
                    if (typeof dashboard.getState === 'function') {
                        const state = dashboard.getState();
                        addTestResult('success', 'DashboardçŠ¶æ€',
                            `å½“å‰ç”¨æˆ·: ${state.currentUser || 'null'}`);
                    }

                } else {
                    throw new Error('UserDashboardç»„ä»¶æˆ–å®¹å™¨æœªæ‰¾åˆ°');
                }

            } catch (error) {
                addTestResult('error', 'UserDashboardæµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•ProjectManagerç»„ä»¶
        async function testProjectManager() {
            try {
                console.log('ğŸ§ª æµ‹è¯•ProjectManagerç»„ä»¶...');

                // æ¸…ç©ºæ¼”ç¤ºå®¹å™¨
                const demoContainer = document.getElementById('component-demo');
                if (demoContainer) {
                    demoContainer.innerHTML = '<div id="pm-test-container"></div>';

                    if (window.ProjectManager) {
                        const manager = new ProjectManager('#pm-test-container', {
                            enableDragDrop: false
                        });

                        addTestResult('success', 'ProjectManager', 'ç»„ä»¶åˆ›å»ºæˆåŠŸ');
                    } else {
                        throw new Error('ProjectManagerç»„ä»¶æœªæ‰¾åˆ°');
                    }
                } else {
                    throw new Error('æ¼”ç¤ºå®¹å™¨æœªæ‰¾åˆ°');
                }

            } catch (error) {
                addTestResult('error', 'ProjectManageræµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•UserRouterç»„ä»¶
        function testUserRouter() {
            try {
                console.log('ğŸ§ª æµ‹è¯•UserRouterç»„ä»¶...');

                if (window.userRouter) {
                    const stats = userRouter.getStats();
                    addTestResult('success', 'UserRouter',
                        `è·¯ç”±çŠ¶æ€æ­£å¸¸, æ€»è·¯ç”±æ•°: ${stats.totalRoutes}`);

                    // æµ‹è¯•è·¯ç”±ç”Ÿæˆ
                    const url = userRouter.generateUrl('dashboard', {}, { test: 'value' });
                    addTestResult('success', 'URLç”Ÿæˆ', `ç”Ÿæˆçš„URL: ${url}`);

                } else {
                    throw new Error('UserRouteræœªåˆå§‹åŒ–');
                }

            } catch (error) {
                addTestResult('error', 'UserRouteræµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•UserLayoutç»„ä»¶
        function testUserLayout() {
            try {
                console.log('ğŸ§ª æµ‹è¯•UserLayoutç»„ä»¶...');

                const demoContainer = document.getElementById('ui-demo');
                if (demoContainer && window.UserLayout) {
                    demoContainer.innerHTML = '<div id="layout-test-container"></div>';

                    const layout = new UserLayout('#layout-test-container', {
                        enableNotifications: false
                    });

                    addTestResult('success', 'UserLayout', 'å¸ƒå±€ç»„ä»¶åˆ›å»ºæˆåŠŸ');

                    // æµ‹è¯•å¸ƒå±€çŠ¶æ€
                    const state = layout.getState();
                    addTestResult('success', 'å¸ƒå±€çŠ¶æ€',
                        `ä¾§è¾¹æ : ${state.sidebarOpen ? 'å±•å¼€' : 'æ”¶èµ·'}`);

                } else {
                    throw new Error('UserLayoutç»„ä»¶æˆ–å®¹å™¨æœªæ‰¾åˆ°');
                }

            } catch (error) {
                addTestResult('error', 'UserLayoutæµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•ThemeManager
        function testThemeManager() {
            try {
                console.log('ğŸ§ª æµ‹è¯•ThemeManager...');

                if (window.themeManager) {
                    const stats = themeManager.getStats();
                    addTestResult('success', 'ThemeManager',
                        `å½“å‰ä¸»é¢˜: ${stats.currentTheme}, ç³»ç»Ÿä¸»é¢˜: ${stats.systemTheme}`);

                    // æµ‹è¯•å¯ç”¨ä¸»é¢˜
                    const themes = themeManager.getAvailableThemes();
                    addTestResult('success', 'å¯ç”¨ä¸»é¢˜',
                        `ä¸»é¢˜æ•°é‡: ${themes.length}, å½“å‰: ${themes.find(t => t.isCurrent)?.displayName}`);

                } else {
                    throw new Error('ThemeManageræœªåˆå§‹åŒ–');
                }

            } catch (error) {
                addTestResult('error', 'ThemeManageræµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // è®¾ç½®ä¸»é¢˜
        function setTheme(themeName) {
            try {
                if (window.themeManager) {
                    themeManager.setTheme(themeName);
                    addTestResult('info', 'ä¸»é¢˜åˆ‡æ¢', `å·²åˆ‡æ¢åˆ°: ${themeName}`);
                } else {
                    addTestResult('error', 'ä¸»é¢˜åˆ‡æ¢', 'ThemeManageræœªåˆå§‹åŒ–');
                }
            } catch (error) {
                addTestResult('error', 'ä¸»é¢˜åˆ‡æ¢', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•ç«¯åˆ°ç«¯æµç¨‹
        async function testE2EFlow() {
            try {
                console.log('ğŸ§ª æµ‹è¯•ç«¯åˆ°ç«¯æµç¨‹...');

                // æ¨¡æ‹Ÿå®Œæ•´çš„ç”¨æˆ·æ“ä½œæµç¨‹
                // 1. åˆ›å»ºé¡¹ç›®
                const project = new UserProject({
                    userId: 'e2e-user',
                    title: 'E2Eæµ‹è¯•é¡¹ç›®'
                });

                // 2. æ·»åŠ åˆ°æ”¶è—
                const favorite = new UserFavorite({
                    userId: 'e2e-user',
                    targetType: 'project',
                    targetId: project.id
                });

                // 3. æ›´æ–°åˆ†ææ•°æ®
                const analytics = new UserAnalytics({ userId: 'e2e-user' });
                analytics.addTimelineEvent({
                    action: 'create',
                    targetId: project.id
                });

                addTestResult('success', 'E2Eæµç¨‹',
                    `é¡¹ç›®: ${project.id}, æ”¶è—: ${favorite.id}, åˆ†æäº‹ä»¶: ${analytics.timeline.length}`);

            } catch (error) {
                addTestResult('error', 'E2Eæµç¨‹æµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•æ€§èƒ½
        function testPerformance() {
            try {
                console.log('ğŸ§ª æµ‹è¯•æ€§èƒ½...');

                const startTime = performance.now();

                // æ‰§è¡Œä¸€äº›æ“ä½œæ¥æµ‹è¯•æ€§èƒ½
                for (let i = 0; i < 100; i++) {
                    const project = new UserProject({
                        userId: `perf-user-${i}`,
                        title: `æ€§èƒ½æµ‹è¯•é¡¹ç›® ${i}`
                    });
                }

                const endTime = performance.now();
                const duration = endTime - startTime;

                addTestResult('success', 'æ€§èƒ½æµ‹è¯•',
                    `åˆ›å»º100ä¸ªé¡¹ç›®è€—æ—¶: ${duration.toFixed(2)}ms`);

                // æµ‹è¯•å†…å­˜ä½¿ç”¨
                if (performance.memory) {
                    const memory = performance.memory;
                    addTestResult('info', 'å†…å­˜ä½¿ç”¨',
                        `å·²ç”¨: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)}MB`);
                }

            } catch (error) {
                addTestResult('error', 'æ€§èƒ½æµ‹è¯•', `é”™è¯¯: ${error.message}`);
            }
        }

        // ç”ŸæˆæŠ¥å‘Š
        function generateReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalTests: testState.totalTests,
                    passedTests: testState.passedTests,
                    failedTests: testState.failedTests,
                    successRate: testState.totalTests > 0 ?
                        (testState.passedTests / testState.totalTests * 100).toFixed(2) + '%' : '0%'
                },
                environment: {
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    modules: Object.keys(window).filter(key =>
                        ['User', 'Cache', 'Theme', 'Data', 'Local'].some(prefix =>
                            key.startsWith(prefix)))
                }
            };

            console.log('ğŸ“Š æµ‹è¯•æŠ¥å‘Š:', report);

            // åˆ›å»ºæŠ¥å‘Šå†…å®¹
            const reportContent = `
=== ç”¨æˆ·å¯è§†åŒ–æ¨¡å—æµ‹è¯•æŠ¥å‘Š ===
ç”Ÿæˆæ—¶é—´: ${report.timestamp}

ğŸ“ˆ æµ‹è¯•æ‘˜è¦:
- æ€»æµ‹è¯•æ•°: ${report.summary.totalTests}
- é€šè¿‡æµ‹è¯•: ${report.summary.passedTests}
- å¤±è´¥æµ‹è¯•: ${report.summary.failedTests}
- æˆåŠŸç‡: ${report.summary.successRate}

ğŸŒ ç¯å¢ƒä¿¡æ¯:
- ç”¨æˆ·ä»£ç†: ${report.environment.userAgent}
- æµ‹è¯•é¡µé¢: ${report.environment.url}

ğŸ“¦ å·²åŠ è½½æ¨¡å—:
${report.environment.modules.map(module => `- ${module}`).join('\n')}

è¯¦ç»†ç»“æœè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ã€‚
            `;

            // æ˜¾ç¤ºæŠ¥å‘Š
            const reportDiv = document.createElement('div');
            reportDiv.className = 'test-result info';
            reportDiv.innerHTML = `
                <strong>æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ</strong>
                <pre style="margin-top: 10px; white-space: pre-wrap; font-size: 0.9rem;">${reportContent}</pre>
                <button class="test-btn secondary" onclick="copyReport('${btoa(reportContent)}')" style="margin-top: 10px;">
                    <i class="fas fa-copy"></i> å¤åˆ¶æŠ¥å‘Š
                </button>
            `;

            document.getElementById('overview-results').appendChild(reportDiv);
        }

        // å¤åˆ¶æŠ¥å‘Š
        function copyReport(encodedReport) {
            try {
                const reportContent = atob(encodedReport);
                navigator.clipboard.writeText(reportContent).then(() => {
                    alert('æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        }

        // é‡ç½®æµ‹è¯•
        function resetTests() {
            testState.totalTests = 0;
            testState.passedTests = 0;
            testState.failedTests = 0;

            // æ¸…ç©ºæ‰€æœ‰ç»“æœ
            document.querySelectorAll('.test-results').forEach(container => {
                container.innerHTML = '';
            });

            // é‡ç½®ç»Ÿè®¡
            updateTestStats();

            // é‡ç½®è¿›åº¦æ¡
            document.getElementById('overall-progress').style.width = '0%';

            // é‡ç½®çŠ¶æ€
            const statusEl = document.getElementById('overall-status');
            statusEl.className = 'status-indicator loading';
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>å‡†å¤‡å°±ç»ª</span>';

            console.log('ğŸ”„ æµ‹è¯•ç¯å¢ƒå·²é‡ç½®');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“± ç”¨æˆ·å¯è§†åŒ–æ¨¡å—æµ‹è¯•é¡µé¢å·²åŠ è½½');

            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿æ‰€æœ‰æ¨¡å—éƒ½å·²åŠ è½½
            setTimeout(initTestEnvironment, 500);
        });

        // ç›‘å¬é”™è¯¯
        window.addEventListener('error', function(e) {
            console.error('é¡µé¢é”™è¯¯:', e.error);
            addTestResult('error', 'é¡µé¢é”™è¯¯', e.error.message);
        });
    </script>
</body>
</html>