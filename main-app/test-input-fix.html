<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡ç‰©å¯è§†åŒ– - è¾“å…¥ä¿®å¤æµ‹è¯•</title>
    <link rel="stylesheet" href="styles/design-system.css">
    <style>
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .test-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .status-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-success { color: #059669; }
        .status-warning { color: #d97706; }
        .status-error { color: #dc2626; }
        .status-pending { color: #6b7280; }
        .test-input-section {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .diagnostic-info {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 12px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
        }
        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header class="test-header">
        <h1>ğŸ”§ ä¸‡ç‰©å¯è§†åŒ– - è¾“å…¥ä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•SmartInputç»„ä»¶åˆå§‹åŒ–ä¿®å¤æ•ˆæœ</p>
    </header>

    <div class="test-container">
        <div class="status-panel">
            <h3>ğŸ“Š ç»„ä»¶çŠ¶æ€ç›‘æ§</h3>
            <div id="statusContainer">
                <div class="status-item">
                    <span>é¡µé¢åŠ è½½çŠ¶æ€</span>
                    <span class="status-pending" id="pageStatus">ç­‰å¾…ä¸­...</span>
                </div>
                <div class="status-item">
                    <span>SmartInputç»„ä»¶</span>
                    <span class="status-pending" id="smartInputStatus">ç­‰å¾…ä¸­...</span>
                </div>
                <div class="status-item">
                    <span>DOMå…ƒç´ çŠ¶æ€</span>
                    <span class="status-pending" id="domStatus">ç­‰å¾…ä¸­...</span>
                </div>
                <div class="status-item">
                    <span>äº‹ä»¶ç»‘å®šçŠ¶æ€</span>
                    <span class="status-pending" id="eventStatus">ç­‰å¾…ä¸­...</span>
                </div>
                <div class="status-item">
                    <span>é™çº§æ¨¡å¼çŠ¶æ€</span>
                    <span class="status-pending" id="fallbackStatus">æœªæ¿€æ´»</span>
                </div>
            </div>
        </div>

        <div class="test-input-section">
            <h3>âœï¸ è¾“å…¥åŠŸèƒ½æµ‹è¯•</h3>
            <div class="smart-input-container">
                <textarea
                    id="mainInput"
                    class="smart-input"
                    placeholder="è¯·è¾“å…¥å¯è§†åŒ–éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæ­£æ€åˆ†å¸ƒ å‡å€¼0 æ ‡å‡†å·®1"
                    rows="3"
                ></textarea>
                <div class="input-footer">
                    <span class="char-count">0 / 500</span>
                    <button class="generate-btn" id="generateBtn">
                        <span class="btn-icon">âœ¨</span>
                        ç”Ÿæˆå¯è§†åŒ–
                    </button>
                </div>
            </div>

            <!-- å»ºè®®å®¹å™¨ -->
            <div class="suggestions-container" id="suggestionsContainer" style="display: none;">
                <div class="suggestions-header">
                    <span class="suggestions-title">ğŸ’¡ æ™ºèƒ½å»ºè®®</span>
                    <button class="close-suggestions" id="closeSuggestions">Ã—</button>
                </div>
                <div class="suggestions-list" id="suggestionsList">
                    <!-- åŠ¨æ€ç”Ÿæˆå»ºè®®å†…å®¹ -->
                </div>
            </div>
        </div>

        <div class="diagnostic-info" id="diagnosticInfo">
            <strong>è¯Šæ–­ä¿¡æ¯ï¼š</strong><br>
            ç­‰å¾…åº”ç”¨åŠ è½½...
        </div>
    </div>

    <!-- å¿…éœ€çš„å®¹å™¨å…ƒç´  -->
    <div id="vizContainer" style="display: none;"></div>
    <div class="router-container" data-router-container></div>

    <!-- åŠ è½½é®ç½© -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">æ­£åœ¨å¤„ç†...</div>
            <div class="loading-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span class="progress-text" id="progressText">0%</span>
            </div>
        </div>
    </div>

    <!-- JavaScript æ¨¡å— -->
    <script>
        // æµ‹è¯•è„šæœ¬
        let testResults = [];
        let diagnosticData = {};

        function updateStatus(id, status, message) {
            const element = document.getElementById(id);
            if (element) {
                element.className = `status-${status}`;
                element.textContent = message;
            }
        }

        function addDiagnosticInfo(info) {
            diagnosticData[info.key] = info.value;
            updateDiagnosticDisplay();
        }

        function updateDiagnosticDisplay() {
            const diagnosticDiv = document.getElementById('diagnosticInfo');
            const diagnosticText = Object.keys(diagnosticData)
                .map(key => `${key}: ${diagnosticData[key]}`)
                .join('\n');
            diagnosticDiv.innerHTML = `<strong>è¯Šæ–­ä¿¡æ¯ï¼š</strong><br>${diagnosticText}`;
        }

        function addTestResult(name, status, details) {
            const result = { name, status, details, timestamp: new Date().toISOString() };
            testResults.push(result);
            console.log(`[TEST ${status.toUpperCase()}] ${name}: ${details}`);
        }

        // ç›‘å¬åº”ç”¨åˆå§‹åŒ–äº‹ä»¶
        document.addEventListener('app:ready', () => {
            updateStatus('pageStatus', 'success', 'âœ… åº”ç”¨å°±ç»ª');
            addTestResult('åº”ç”¨åˆå§‹åŒ–', 'success', 'åº”ç”¨æˆåŠŸåˆå§‹åŒ–');
        });

        document.addEventListener('app:fallback-ready', () => {
            updateStatus('pageStatus', 'warning', 'âš ï¸ åº”ç”¨é™çº§æ¨¡å¼');
            addTestResult('åº”ç”¨åˆå§‹åŒ–', 'warning', 'åº”ç”¨ä»¥é™çº§æ¨¡å¼å¯åŠ¨');
        });

        // ç›‘å¬SmartInputäº‹ä»¶
        document.addEventListener('smart-input:initialization-success', (event) => {
            const details = event.detail;
            updateStatus('smartInputStatus', 'success', `âœ… æˆåŠŸ (${details.totalTime}ms)`);
            addTestResult('SmartInputåˆå§‹åŒ–', 'success', `åˆå§‹åŒ–æˆåŠŸï¼Œè€—æ—¶ ${details.totalTime}ms`);
            addDiagnosticInfo({
                key: 'SmartInputçŠ¶æ€',
                value: `æˆåŠŸ (å°è¯•æ¬¡æ•°: ${details.attempts})`
            });
        });

        document.addEventListener('smart-input:initialization-error', (event) => {
            const error = event.detail;
            updateStatus('smartInputStatus', 'error', `âŒ ${error.type}`);
            addTestResult('SmartInputåˆå§‹åŒ–', 'error', `åˆå§‹åŒ–é”™è¯¯: ${error.type}`);
            addDiagnosticInfo({
                key: 'SmartInputé”™è¯¯',
                value: `${error.type}: ${error.details}`
            });
        });

        document.addEventListener('smart-input:initialization-failed', (event) => {
            const failure = event.detail;
            updateStatus('smartInputStatus', 'error', `âŒ å¤±è´¥ (${failure.reason})`);
            addTestResult('SmartInputåˆå§‹åŒ–', 'error', `åˆå§‹åŒ–å¤±è´¥: ${failure.reason}`);
            addDiagnosticInfo({
                key: 'SmartInputå¤±è´¥',
                value: `${failure.reason} (å°è¯•æ¬¡æ•°: ${failure.attempts})`
            });
        });

        // ç›‘å¬é™çº§è¾“å…¥äº‹ä»¶
        document.addEventListener('component:fallback-input:ready', () => {
            updateStatus('fallbackStatus', 'success', 'âœ… é™çº§æ¨¡å¼å·²æ¿€æ´»');
            addTestResult('é™çº§è¾“å…¥', 'success', 'é™çº§è¾“å…¥æ¨¡å¼æˆåŠŸæ¿€æ´»');
        });

        document.addEventListener('component:smart-input:ready', () => {
            updateStatus('smartInputStatus', 'success', 'âœ… ç»„ä»¶å°±ç»ª');
            addTestResult('SmartInputç»„ä»¶', 'success', 'SmartInputç»„ä»¶å·²å°±ç»ª');
        });

        document.addEventListener('component:smart-input:error', (event) => {
            const error = event.detail;
            updateStatus('smartInputStatus', 'warning', `âš ï¸ é”™è¯¯å¤„ç†: ${error.type}`);
            addTestResult('SmartInputé”™è¯¯å¤„ç†', 'warning', `é”™è¯¯å·²å¤„ç†: ${error.type}`);
        });

        document.addEventListener('component:smart-input:failed', (event) => {
            const failure = event.detail;
            updateStatus('smartInputStatus', 'error', `âŒ ç»„ä»¶å¤±è´¥: ${failure.reason}`);
            addTestResult('SmartInputç»„ä»¶', 'error', `SmartInputç»„ä»¶å¤±è´¥: ${failure.reason}`);
        });

        // é¡µé¢åŠ è½½æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('pageStatus', 'success', 'âœ… DOMå·²åŠ è½½');
            addDiagnosticInfo({
                key: 'DOMçŠ¶æ€',
                value: document.readyState
            });

            // æ£€æŸ¥å¿…éœ€çš„DOMå…ƒç´ 
            setTimeout(() => {
                const input = document.getElementById('mainInput');
                const generateBtn = document.getElementById('generateBtn');
                const suggestionsContainer = document.getElementById('suggestionsContainer');

                let domStatus = 'âœ… æ‰€æœ‰å…ƒç´ å­˜åœ¨';
                let missingElements = [];

                if (!input) missingElements.push('mainInput');
                if (!generateBtn) missingElements.push('generateBtn');
                if (!suggestionsContainer) missingElements.push('suggestionsContainer');

                if (missingElements.length > 0) {
                    domStatus = `âŒ ç¼ºå°‘å…ƒç´ : ${missingElements.join(', ')}`;
                    updateStatus('domStatus', 'error', domStatus);
                } else {
                    updateStatus('domStatus', 'success', domStatus);
                }

                addDiagnosticInfo({
                    key: 'DOMå…ƒç´ æ£€æŸ¥',
                    value: domStatus
                });
            }, 100);
        });

        // é”™è¯¯ç›‘å¬
        window.addEventListener('error', (event) => {
            addTestResult('JavaScripté”™è¯¯', 'error', `${event.error.message} at ${event.filename}:${event.lineno}`);
            addDiagnosticInfo({
                key: 'JSé”™è¯¯',
                value: `${event.error.message}`
            });
        });

        window.addEventListener('unhandledrejection', (event) => {
            addTestResult('Promiseé”™è¯¯', 'error', `æœªå¤„ç†çš„Promise rejection: ${event.reason}`);
            addDiagnosticInfo({
                key: 'Promiseé”™è¯¯',
                value: `${event.reason}`
            });
        });

        // å®šæœŸæ£€æŸ¥åº”ç”¨çŠ¶æ€
        setInterval(() => {
            if (window.app) {
                const smartInput = window.app.components?.smartInput;
                if (smartInput) {
                    const status = smartInput.getInitializationStatus();
                    addDiagnosticInfo({
                        key: 'SmartInputçŠ¶æ€',
                        value: `${status.status} (å°è¯•: ${status.attempts})`
                    });

                    // æ£€æŸ¥äº‹ä»¶ç»‘å®š
                    if (status.eventsAttached) {
                        updateStatus('eventStatus', 'success', 'âœ… äº‹ä»¶å·²ç»‘å®š');
                    } else {
                        updateStatus('eventStatus', 'warning', 'âš ï¸ äº‹ä»¶æœªç»‘å®š');
                    }
                }
            }
        }, 2000);
    </script>

    <!-- åº”ç”¨ç»„ä»¶ -->
    <script src="components/StateManager.js"></script>
    <script src="components/ThemeManager.js"></script>
    <script src="components/MobileEnhancer.js"></script>
    <script src="components/ApiClient.js"></script>
    <script src="components/SmartInput.js"></script>
    <script src="components/TemplateSelector.js"></script>
    <script src="components/LoadingStates.js"></script>
    <script src="components/ParamSync.js"></script>
    <script src="components/Router.js"></script>
    <script src="components/VizContainer.js"></script>
    <script src="app.js"></script>
</body>
</html>