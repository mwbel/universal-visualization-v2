<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŒ…å¡é¡¿å¼€ - æ™ºèƒ½å¯è§†åŒ–è·¯ç”±ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px 15px 0 0;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 28px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status {
            width: 12px;
            height: 12px;
            background: #10B981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .main-content {
            flex: 1;
            display: flex;
            gap: 20px;
            min-height: 0;
        }

        .chat-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .visualization-panel {
            width: 400px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #7C3AED;
        }

        .message.ai .message-avatar {
            background: #10B981;
        }

        .message-content {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 70%;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #7C3AED;
            color: white;
            margin-left: auto;
        }

        .input-area {
            display: flex;
            gap: 10px;
        }

        .input-field {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            min-height: 44px;
        }

        .input-field:focus {
            outline: none;
            border-color: #7C3AED;
        }

        .send-button {
            background: linear-gradient(135deg, #7C3AED 0%, #9333EA 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .visualization-area {
            flex: 1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .control-button {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .control-button:hover {
            transform: translateY(-1px);
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .suggestion {
            background: rgba(124, 58, 237, 0.1);
            color: #7C3AED;
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            border: 1px solid rgba(124, 58, 237, 0.2);
            transition: all 0.3s;
        }

        .suggestion:hover {
            background: rgba(124, 58, 237, 0.2);
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .visualization-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>
                ğŸ’¡ èŒ…å¡é¡¿å¼€
                <div class="status"></div>
            </h1>
            <div class="current-subject">
                <span class="subject-icon">ğŸ“</span>
                <span class="subject-label">æ•°å­¦</span>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-panel">
                <div class="messages-container" id="messagesContainer">
                    <div class="message ai">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-content">
                            ä½ å¥½ï¼æˆ‘æ˜¯"èŒ…å¡é¡¿å¼€"AIåŠ©æ•™ã€‚è¯·è¾“å…¥ä½ æƒ³è¦å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œæˆ‘ä¼šè‡ªåŠ¨è¯†åˆ«å­¦ç§‘å¹¶ç”Ÿæˆç›¸åº”çš„å¯è§†åŒ–å†…å®¹ã€‚
                            <div class="suggestions" id="suggestions">
                                <div class="suggestion">äºŒæ¬¡å‡½æ•°</div>
                                <div class="suggestion">æ­£å¼¦å‡½æ•°</div>
                                <div class="suggestion">å—åŠ›åˆ†æ</div>
                                <div class="suggestion">åˆ†å­ç»“æ„</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-area">
                    <textarea
                        class="input-field"
                        id="messageInput"
                        placeholder="è¾“å…¥ä½ æƒ³è¦å­¦ä¹ çš„çŸ¥è¯†ç‚¹..."
                        rows="1"
                    ></textarea>
                    <button class="send-button" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>

            <div class="visualization-panel">
                <h3>ğŸ“Š å¯è§†åŒ–å±•ç¤º</h3>
                <div class="visualization-area" id="visualizationArea">
                    <div>
                        <p>è¾“å…¥å…³é”®è¯å¼€å§‹å­¦ä¹ </p>
                        <p style="font-size: 14px; color: #666; margin-top: 10px;">æ”¯æŒæ•°å­¦ã€ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©ç­‰å¤šå­¦ç§‘å†…å®¹</p>
                    </div>
                </div>
                <div class="controls" id="controls"></div>
            </div>
        </div>
    </div>

    <script>
        // å­¦ç§‘å…³é”®è¯è¯†åˆ«
        const subjectKeywords = {
            math: {
                name: 'æ•°å­¦',
                icon: 'ğŸ“',
                color: '#3B82F6',
                keywords: ['å‡½æ•°', 'äºŒæ¬¡å‡½æ•°', 'ä¸€æ¬¡å‡½æ•°', 'æŒ‡æ•°å‡½æ•°', 'å¯¹æ•°å‡½æ•°', 'ä¸‰è§’å‡½æ•°', 'æ­£å¼¦', 'ä½™å¼¦', 'æ­£åˆ‡', 'å‡ ä½•', 'ä¸‰è§’å½¢', 'åœ†', 'çŸ©å½¢', 'ä»£æ•°', 'æ–¹ç¨‹', 'ä¸ç­‰å¼', 'æ•°åˆ—', 'ç­‰å·®æ•°åˆ—', 'ç­‰æ¯”æ•°åˆ—', 'ç»Ÿè®¡', 'æ¦‚ç‡', 'å‘é‡', 'çŸ©é˜µ', 'å¯¼æ•°', 'ç§¯åˆ†']
            },
            physics: {
                name: 'ç‰©ç†',
                icon: 'âš¡',
                color: '#10B981',
                keywords: ['åŠ›å­¦', 'åŠ›', 'é‡åŠ›', 'æ”¯æŒåŠ›', 'æ‘©æ“¦åŠ›', 'ç”µ', 'ç”µè·¯', 'ç”µæµ', 'ç”µå‹', 'ç£åœº', 'æ³¢', 'å£°æ³¢', 'å…‰æ³¢', 'é¢‘ç‡', 'æ³¢é•¿', 'çƒ­', 'æ¸©åº¦', 'ç‰›é¡¿']
            },
            chemistry: {
                name: 'åŒ–å­¦',
                icon: 'âš—ï¸',
                color: '#F59E0B',
                keywords: ['åˆ†å­', 'åŸå­', 'åŒ–å­¦é”®', 'å…ƒç´ ', 'åŒ–å­¦ååº”', 'é…¸', 'ç¢±', 'ç›', 'æº¶æ¶²', 'åŒ–å­¦æ–¹ç¨‹', 'å‘¨æœŸè¡¨', 'æœ‰æœº', 'æ— æœº']
            },
            biology: {
                name: 'ç”Ÿç‰©',
                icon: 'ğŸ§¬',
                color: '#8B5CF6',
                keywords: ['ç»†èƒ', 'ç»†èƒè†œ', 'ç»†èƒæ ¸', 'DNA', 'RNA', 'åŸºå› ', 'é—ä¼ ', 'å…‰åˆä½œç”¨', 'å‘¼å¸ä½œç”¨', 'æ–°é™ˆä»£è°¢', 'é…¶', 'ç”Ÿæ€ç³»ç»Ÿ', 'é£Ÿç‰©é“¾', 'äººä½“']
            }
        };

        let currentSubject = 'math';
        let isLoading = false;

        // æ™ºèƒ½è¯†åˆ«å­¦ç§‘
        function recognizeSubject(message) {
            const lowerMessage = message.toLowerCase();
            let bestMatch = null;
            let maxScore = 0;

            Object.entries(subjectKeywords).forEach(([subject, config]) => {
                let score = 0;
                config.keywords.forEach(keyword => {
                    if (lowerMessage.includes(keyword)) {
                        score += keyword.length / lowerMessage.length;
                    }
                });

                if (score > maxScore) {
                    maxScore = score;
                    bestMatch = subject;
                }
            });

            return bestMatch || null;
        }

        // æ›´æ–°å­¦ç§‘æ˜¾ç¤º
        function updateSubjectDisplay(subject) {
            const config = subjectKeywords[subject];
            if (config) {
                currentSubject = subject;
                document.querySelector('.subject-icon').textContent = config.icon;
                document.querySelector('.subject-label').textContent = config.name;
            }
        }

        // æ¸²æŸ“å¯è§†åŒ–
        function renderVisualization(type, message) {
            const vizArea = document.getElementById('visualizationArea');
            const controls = document.getElementById('controls');
            controls.innerHTML = '';

            let html = '';

            switch(type) {
                case 'trigonometry':
                    html = renderTrigonometry(message);
                    break;
                case 'quadratic':
                    html = renderQuadraticFunction(message);
                    break;
                case 'linear':
                    html = renderLinearFunction(message);
                    break;
                case 'geometry':
                    html = renderGeometry(message);
                    break;
                case 'physics-force':
                    html = renderForceDiagram();
                    break;
                case 'chemistry-molecule':
                    html = renderMolecule();
                    break;
                case 'biology-cell':
                    html = renderCell();
                    break;
                default:
                    html = renderDefault(type, message);
            }

            vizArea.innerHTML = html;

            // æ·»åŠ æ§åˆ¶æŒ‰é’®
            const newPageBtn = document.createElement('button');
            newPageBtn.className = 'control-button';
            newPageBtn.textContent = 'ğŸ”— åœ¨æ–°é¡µé¢æ‰“å¼€';
            newPageBtn.onclick = () => openInNewPage(type, message);
            controls.appendChild(newPageBtn);
        }

        // ä¸‰è§’å‡½æ•°å¯è§†åŒ–
        function renderTrigonometry(message) {
            return `
                <canvas id="trigCanvas" width="350" height="250" style="border: 1px solid #e0e0e0; border-radius: 8px;"></canvas>
                <div style="margin-top: 15px;">
                    <h4 style="color: #333; margin-bottom: 10px;">ä¸‰è§’å‡½æ•°å›¾åƒ</h4>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">
                        <span style="color: #3B82F6; font-weight: bold;">è“è‰²</span>: æ­£å¼¦å‡½æ•° sin(x)
                    </p>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">
                        <span style="color: #DC2626; font-weight: bold;">çº¢è‰²</span>: ä½™å¼¦å‡½æ•° cos(x)
                    </p>
                </div>
                <script>
                    setTimeout(() => drawTrigonometricFunctions('trigCanvas'), 100);
                </script>
            `;
        }

        // äºŒæ¬¡å‡½æ•°å¯è§†åŒ–
        function renderQuadraticFunction(message) {
            return `
                <canvas id="quadCanvas" width="350" height="250" style="border: 1px solid #e0e0e0; border-radius: 8px;"></canvas>
                <div style="margin-top: 15px;">
                    <h4 style="color: #333; margin-bottom: 10px;">äºŒæ¬¡å‡½æ•°å›¾åƒ</h4>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">y = xÂ²</p>
                </div>
                <script>
                    setTimeout(() => drawQuadratic('quadCanvas'), 100);
                </script>
            `;
        }

        // ä¸€æ¬¡å‡½æ•°å¯è§†åŒ–
        function renderLinearFunction(message) {
            return `
                <canvas id="linearCanvas" width="350" height="250" style="border: 1px solid #e0e0e0; border-radius: 8px;"></canvas>
                <div style="margin-top: 15px;">
                    <h4 style="color: #333; margin-bottom: 10px;">ä¸€æ¬¡å‡½æ•°å›¾åƒ</h4>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">y = 2x + 1</p>
                </div>
                <script>
                    setTimeout(() => drawLinear('linearCanvas'), 100);
                </script>
            `;
        }

        // å‡ ä½•å›¾å½¢å¯è§†åŒ–
        function renderGeometry(message) {
            return `
                <canvas id="geometryCanvas" width="350" height="250" style="border: 1px solid #e0e0e0; border-radius: 8px;"></canvas>
                <div style="margin-top: 15px;">
                    <h4 style="color: #333; margin-bottom: 10px;">å‡ ä½•å›¾å½¢</h4>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">åŸºæœ¬å‡ ä½•å›¾å½¢å±•ç¤º</p>
                </div>
                <script>
                    setTimeout(() => drawGeometry('geometryCanvas'), 100);
                </script>
            `;
        }

        // å—åŠ›åˆ†æ
        function renderForceDiagram() {
            return `
                <canvas id="forceCanvas" width="350" height="250" style="border: 1px solid #e0e0e0; border-radius: 8px;"></canvas>
                <div style="margin-top: 15px;">
                    <h4 style="color: #333; margin-bottom: 10px;">å—åŠ›åˆ†æå›¾</h4>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">ç‰©ä½“å—åŠ›åˆ†æ</p>
                </div>
                <script>
                    setTimeout(() => drawForceDiagram('forceCanvas'), 100);
                </script>
            `;
        }

        // åˆ†å­ç»“æ„
        function renderMolecule() {
            return `
                <canvas id="moleculeCanvas" width="350" height="250" style="border: 1px solid #e0e0e0; border-radius: 8px;"></canvas>
                <div style="margin-top: 15px;">
                    <h4 style="color: #333; margin-bottom: 10px;">åˆ†å­ç»“æ„</h4>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">æ°´åˆ†å­ Hâ‚‚O</p>
                </div>
                <script>
                    setTimeout(() => drawMolecule('moleculeCanvas'), 100);
                </script>
            `;
        }

        // ç»†èƒç»“æ„
        function renderCell() {
            return `
                <canvas id="cellCanvas" width="350" height="250" style="border: 1px solid #e0e0e0; border-radius: 8px;"></canvas>
                <div style="margin-top: 15px;">
                    <h4 style="color: #333; margin-bottom: 10px;">ç»†èƒç»“æ„</h4>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">åŠ¨ç‰©ç»†èƒç»“æ„</p>
                </div>
                <script>
                    setTimeout(() => drawCell('cellCanvas'), 100);
                </script>
            `;
        }

        // é»˜è®¤æ˜¾ç¤º
        function renderDefault(type, message) {
            const config = subjectKeywords[currentSubject] || subjectKeywords.math;
            return `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">${config.icon}</div>
                    <h3 style="color: #333; margin-bottom: 10px;">${config.name}å¯è§†åŒ–</h3>
                    <p style="color: #666; margin: 10px 0;">å…³é”®è¯: ${message}</p>
                    <p style="font-size: 14px; color: #888;">è¯¥å…·ä½“å¯è§†åŒ–æ­£åœ¨å¼€å‘ä¸­...</p>
                </div>
            `;
        }

        // ç»˜åˆ¶å‡½æ•° - ç®€åŒ–ç‰ˆæœ¬
        function drawTrigonometricFunctions(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 50;

            ctx.clearRect(0, 0, width, height);

            // åæ ‡è½´
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();

            // æ­£å¼¦å‡½æ•°
            ctx.strokeStyle = '#3B82F6';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                const angle = (x - centerX) / scale;
                const y = centerY - Math.sin(angle) * scale;
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // ä½™å¼¦å‡½æ•°
            ctx.strokeStyle = '#DC2626';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                const angle = (x - centerX) / scale;
                const y = centerY - Math.cos(angle) * scale;
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        function drawQuadratic(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 40;

            ctx.clearRect(0, 0, width, height);

            // åæ ‡è½´
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();

            // äºŒæ¬¡å‡½æ•°
            ctx.strokeStyle = '#3B82F6';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                const xVal = (x - centerX) / scale;
                const y = centerY - (xVal * xVal) * scale;
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        function drawLinear(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 40;

            ctx.clearRect(0, 0, width, height);

            // åæ ‡è½´
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();

            // ä¸€æ¬¡å‡½æ•°
            ctx.strokeStyle = '#DC2626';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                const xVal = (x - centerX) / scale;
                const y = centerY - (2 * xVal + 1) * scale;
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        function drawGeometry(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            // ä¸‰è§’å½¢
            ctx.fillStyle = '#3B82F6';
            ctx.beginPath();
            ctx.moveTo(width/2, 50);
            ctx.lineTo(width/2 - 40, 150);
            ctx.lineTo(width/2 + 40, 150);
            ctx.closePath();
            ctx.fill();

            // åœ†å½¢
            ctx.fillStyle = '#10B981';
            ctx.beginPath();
            ctx.arc(width * 0.7, 100, 30, 0, 2 * Math.PI);
            ctx.fill();

            // çŸ©å½¢
            ctx.fillStyle = '#F59E0B';
            ctx.fillRect(width * 0.2, 120, 80, 60);

            // æ­£æ–¹å½¢
            ctx.fillStyle = '#8B5CF6';
            ctx.fillRect(width * 0.1, 130, 60, 60);
        }

        function drawForceDiagram(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            // ç‰©ä½“
            ctx.fillStyle = '#F59E0B';
            ctx.fillRect(width/2 - 30, height/2 - 30, 60, 60);

            // é‡åŠ›
            ctx.strokeStyle = '#DC2626';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(width/2, height/2 + 30);
            ctx.lineTo(width/2, height/2 + 80);
            ctx.stroke();

            // æ”¯æŒåŠ›
            ctx.strokeStyle = '#10B981';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(width/2, height/2 - 30);
            ctx.lineTo(width/2, height/2 - 80);
            ctx.stroke();

            // æ‘©æ“¦åŠ›
            ctx.strokeStyle = '#3B82F6';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(width/2 - 30, height/2);
            ctx.lineTo(width/2 - 80, height/2);
            ctx.stroke();
        }

        function drawMolecule(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            // æ°§åŸå­
            ctx.fillStyle = '#EF4444';
            ctx.beginPath();
            ctx.arc(width/2, height/2, 30, 0, 2 * Math.PI);
            ctx.fill();

            // æ°¢åŸå­1
            ctx.fillStyle = '#F59E0B';
            ctx.beginPath();
            ctx.arc(width/2 - 40, height/2 - 30, 15, 0, 2 * Math.PI);
            ctx.fill();

            // æ°¢åŸå­2
            ctx.fillStyle = '#F59E0B';
            ctx.beginPath();
            ctx.arc(width/2 + 40, height/2 - 30, 15, 0, 2 * Math.PI);
            ctx.fill();

            // åŒ–å­¦é”®
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(width/2 - 30, height/2);
            ctx.lineTo(width/2, height/2 - 30);
            ctx.moveTo(width/2, height/2);
            ctx.lineTo(width/2 + 40, height/2 - 30);
            ctx.stroke();
        }

        function drawCell(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            // ç»†èƒè†œ
            ctx.strokeStyle = '#8B5CF6';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.ellipse(width/2, height/2, 120, 80, 0, 2 * Math.PI);
            ctx.stroke();

            // ç»†èƒæ ¸
            ctx.fillStyle = '#DDD6FE';
            ctx.beginPath();
            ctx.ellipse(width/2, height/2, 50, 40, 0, 2 * Math.PI);
            ctx.fill();

            // çº¿ç²’ä½“
            ctx.fillStyle = '#FCA5A5';
            ctx.beginPath();
            ctx.ellipse(width/2 + 40, height/2 - 20, 30, 15, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(width/2 - 40, height/2 + 20, 25, 12, 0, 2 * Math.PI);
            ctx.fill();

            // æ ¸ç³–ä½“
            ctx.fillStyle = '#3B82F6';
            ctx.beginPath();
            ctx.arc(width/2 - 30, height/2 - 10, 3, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(width/2 + 30, height/2 + 10, 3, 0, 2 * Math.PI);
            ctx.fill();
        }

        // åœ¨æ–°é¡µé¢æ‰“å¼€
        function openInNewPage(type, message) {
            const newWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
            if (!newWindow) return;

            let content = '';

            switch(type) {
                case 'trigonometry':
                    content = generateTrigonometryPage();
                    break;
                default:
                    content = generateDefaultPage(type, message);
            }

            newWindow.document.write(content);
            newWindow.document.close();
        }

        function generateTrigonometryPage() {
            return `
                <!DOCTYPE html>
                <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>ä¸‰è§’å‡½æ•°å¯è§†åŒ–</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                        canvas { border: 1px solid #ddd; margin: 20px auto; display: block; }
                        .info { text-align: center; margin: 20px; }
                    </style>
                </head>
                <body>
                    <h1>ä¸‰è§’å‡½æ•°äº¤äº’å¼å¯è§†åŒ–</h1>
                    <canvas id="canvas" width="600" height="400"></canvas>
                    <div class="info">
                        <p>è¿™æ˜¯ä¸‰è§’å‡½æ•°çš„è¯¦ç»†å¯è§†åŒ–é¡µé¢</p>
                    </div>
                    <script>
                        const canvas = document.getElementById('canvas');
                        const ctx = canvas.getContext('2d');
                        drawTrigonometricFunctions('canvas');
                    </script>
                </body>
                </html>
            `;
        }

        function generateDefaultPage(type, message) {
            return `
                <!DOCTYPE html>
                <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${type} å¯è§†åŒ–</title>
                </head>
                <body>
                    <h1>${type} å¯è§†åŒ–</h1>
                    <p>è¾“å…¥å†…å®¹: ${message}</p>
                    <p>è¯¥å¯è§†åŒ–é¡µé¢æ­£åœ¨å¼€å‘ä¸­...</p>
                </body>
                </html>
            `;
        }

        // æ·»åŠ æ¶ˆæ¯
        function addMessage(content, sender) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content}</div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (isLoading) return;

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            input.style.height = 'auto';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');

            // æ™ºèƒ½è¯†åˆ«å­¦ç§‘
            const recognizedSubject = recognizeSubject(message);

            if (recognizedSubject && recognizedSubject !== currentSubject) {
                updateSubjectDisplay(recognizedSubject);
                addMessage(`å·²åˆ‡æ¢åˆ°${subjectKeywords[recognizedSubject].name}å­¦ç§‘æ¨¡å¼`, 'ai');
                currentSubject = recognizedSubject;
            }

            // æ¨¡æ‹ŸAIå›å¤
            setTimeout(() => {
                const type = determineVisualizationType(message, currentSubject);
                addMessage(`æˆ‘ç†è§£äº†ä½ æƒ³äº†è§£çš„å†…å®¹ã€‚è®©æˆ‘ä¸ºä½ ç”Ÿæˆç›¸åº”çš„å¯è§†åŒ–ã€‚`, 'ai');
                renderVisualization(type, message);
            }, 500);
        }

        // ç¡®å®šå¯è§†åŒ–ç±»å‹
        function determineVisualizationType(message, subject) {
            const lowerMessage = message.toLowerCase();

            if (subject === 'math') {
                if (['æ­£å¼¦', 'ä½™å¼¦', 'ä¸‰è§’å‡½æ•°', 'sin', 'cos', 'tan'].some(kw => lowerMessage.includes(kw))) {
                    return 'trigonometry';
                }
                if (['äºŒæ¬¡å‡½æ•°', 'æŠ›ç‰©çº¿'].some(kw => lowerMessage.includes(kw))) {
                    return 'quadratic';
                }
                if (['ä¸€æ¬¡å‡½æ•°', 'çº¿æ€§å‡½æ•°'].some(kw => lowerMessage.includes(kw))) {
                    return 'linear';
                }
                if (['å‡ ä½•', 'ä¸‰è§’å½¢', 'åœ†', 'çŸ©å½¢'].some(kw => lowerMessage.includes(kw))) {
                    return 'geometry';
                }
            } else if (subject === 'physics') {
                if (['åŠ›', 'é‡åŠ›', 'å—åŠ›'].some(kw => lowerMessage.includes(kw))) {
                    return 'physics-force';
                }
            } else if (subject === 'chemistry') {
                if (['åˆ†å­', 'åŸå­', 'åŒ–å­¦'].some(kw => lowerMessage.includes(kw))) {
                    return 'chemistry-molecule';
                }
            } else if (subject === 'biology') {
                if (['ç»†èƒ', 'DNA', 'é—ä¼ '].some(kw => lowerMessage.includes(kw))) {
                    return 'biology-cell';
                }
            }

            return 'default';
        }

        // åˆå§‹åŒ–å»ºè®®æ ‡ç­¾
        function initSuggestions() {
            const container = document.getElementById('suggestions');
            const suggestions = ['äºŒæ¬¡å‡½æ•°', 'æ­£å¼¦å‡½æ•°', 'å—åŠ›åˆ†æ', 'åˆ†å­ç»“æ„', 'DNAç»“æ„', 'ç”Ÿæ€ç³»ç»Ÿ'];

            container.innerHTML = suggestions.map(suggestion =>
                `<div class="suggestion" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
            ).join('');
        }

        function selectSuggestion(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // é¡µé¢åˆå§‹åŒ–
        window.addEventListener('load', function() {
            document.getElementById('messageInput').focus();
            initSuggestions();
        });
    </script>
</body>
</html>