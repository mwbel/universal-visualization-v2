<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŒ…å¡é¡¿å¼€ - æ™ºèƒ½å¯è§†åŒ–è·¯ç”±ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #7C3AED 0%, #9333EA 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10B981;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .status-indicator.processing {
            background: #F59E0B;
            animation: pulse 1s infinite;
        }

        .current-subject {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 2px solid transparent;
        }

        .current-subject:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.25);
        }

        .subject-icon {
            font-size: 20px;
        }

        .subject-label {
            font-weight: 500;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .chat-panel {
            flex: 1;
            border-right: 1px solid #e8e8e8;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e8e8e8;
            background: white;
            font-weight: 600;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            animation: messageSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #7C3AED;
        }

        .message.ai .message-avatar {
            background: #10B981;
        }

        .message-content {
            background: white;
            padding: 14px 18px;
            border-radius: 16px;
            max-width: 70%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            line-height: 1.5;
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
        }

        .message-content:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #7C3AED 0%, #9333EA 100%);
            color: white;
            margin-left: auto;
            border: none;
        }

        .message.user .message-content:hover {
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        .quick-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .suggestion-tag {
            padding: 6px 14px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08) 0%, rgba(147, 51, 234, 0.12) 100%);
            color: #7C3AED;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(124, 58, 237, 0.15);
            position: relative;
            overflow: hidden;
        }

        .suggestion-tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .suggestion-tag:hover {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15) 0%, rgba(147, 51, 234, 0.2) 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.2);
            border-color: rgba(124, 58, 237, 0.3);
        }

        .suggestion-tag:hover::before {
            left: 100%;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #e8e8e8;
            background: white;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #7C3AED;
        }

        .send-button {
            background: linear-gradient(135deg, #7C3AED 0%, #9333EA 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
            position: relative;
            overflow: hidden;
        }

        .send-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
            background: linear-gradient(135deg, #6d28d9 0%, #7C3AED 100%);
        }

        .send-button:hover::before {
            left: 100%;
        }

        .send-button:active {
            transform: translateY(0);
        }

        .send-button:disabled {
            background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .send-button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .send-button:disabled::before {
            display: none;
        }

        .visualization-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .viz-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e8e8e8;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .viz-content {
            flex: 1;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .viz-placeholder {
            text-align: center;
            color: #8c8c8c;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loading-indicator {
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: center;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #7C3AED;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .viz-controls {
            padding: 16px 20px;
            border-top: 1px solid #e8e8e8;
            background: #fafafa;
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .control-label {
            font-size: 14px;
            color: #666;
        }

        .toggle-switch {
            width: 44px;
            height: 24px;
            background: #d1d5db;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #7C3AED;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        .slider-control {
            width: 100px;
            margin-left: 10px;
        }

        /* å­¦ç§‘ç‰¹å®šé¢œè‰² */
        .math-theme { color: #3B82F6; border-color: #3B82F6; }
        .physics-theme { color: #10B981; border-color: #10B981; }
        .chemistry-theme { color: #F59E0B; border-color: #F59E0B; }
        .biology-theme { color: #8B5CF6; border-color: #8B5CF6; }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .app-container {
                width: 95%;
                height: 90vh;
            }

            .visualization-panel {
                width: 350px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                box-shadow: none;
            }

            .header {
                padding: 15px 20px;
                background: linear-gradient(135deg, #7C3AED 0%, #9333EA 100%);
            }

            .header h1 {
                font-size: 18px;
                gap: 8px;
            }

            .current-subject {
                padding: 6px 12px;
                font-size: 12px;
                background: rgba(255, 255, 255, 0.15);
            }

            .subject-icon {
                font-size: 14px;
            }

            .main-content {
                flex-direction: column;
                height: calc(100vh - 60px);
            }

            .chat-panel {
                border-right: none;
                border-bottom: 1px solid #e8e8e8;
                flex: 1;
                min-height: 0;
            }

            .visualization-panel {
                width: 100%;
                height: 40vh;
                min-height: 300px;
            }

            .chat-header {
                padding: 12px 15px;
                font-size: 14px;
            }

            .messages-container {
                padding: 15px;
            }

            .message-content {
                max-width: 85%;
                padding: 10px 14px;
                font-size: 14px;
            }

            .quick-suggestions {
                gap: 6px;
            }

            .suggestion-tag {
                padding: 5px 10px;
                font-size: 11px;
            }

            .input-area {
                padding: 15px;
            }

            .input-field {
                font-size: 14px;
                padding: 10px;
            }

            .send-button {
                padding: 10px 16px;
                font-size: 14px;
            }

            .viz-content {
                padding: 15px;
            }

            .viz-controls {
                padding: 12px 15px;
            }

            .control-item {
                margin-bottom: 6px;
            }

            .control-label {
                font-size: 13px;
            }

            .toggle-switch {
                width: 40px;
                height: 22px;
            }

            .toggle-switch::after {
                width: 18px;
                height: 18px;
                top: 2px;
                left: 2px;
            }

            .toggle-switch.active::after {
                left: 20px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 12px 15px;
            }

            .header h1 {
                font-size: 16px;
            }

            .current-subject {
                display: none;
            }

            .status-indicator {
                width: 6px;
                height: 6px;
            }

            .messages-container {
                padding: 10px;
            }

            .message {
                margin-bottom: 12px;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .message-content {
                max-width: 80%;
                padding: 8px 12px;
                font-size: 13px;
            }

            .quick-suggestions {
                gap: 4px;
            }

            .suggestion-tag {
                padding: 4px 8px;
                font-size: 10px;
            }

            .input-area {
                padding: 10px;
            }

            .input-field {
                padding: 8px;
                font-size: 13px;
            }

            .send-button {
                padding: 8px 12px;
                font-size: 13px;
            }

            .visualization-panel {
                height: 35vh;
                min-height: 250px;
            }

            .viz-header {
                padding: 10px 15px;
                font-size: 14px;
            }

            .viz-content {
                padding: 10px;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        .touch-device .suggestion-tag,
        .touch-device .send-button,
        .touch-device .toggle-switch {
            cursor: pointer;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            user-select: none;
            -webkit-user-select: none;
        }

        .touch-device .suggestion-tag:active {
            transform: scale(0.95);
        }

        .touch-device .send-button:active {
            transform: scale(0.98);
        }

        .touch-device .toggle-switch:active {
            transform: scale(0.9);
        }

        /* iOS Safari ä¼˜åŒ– */
        @supports (-webkit-touch-callout: none) {
            .app-container {
                -webkit-overflow-scrolling: touch;
            }

            .messages-container {
                -webkit-overflow-scrolling: touch;
            }

            .input-field {
                -webkit-appearance: none;
                border-radius: 0;
            }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 8px 15px;
            }

            .header h1 {
                font-size: 16px;
            }

            .current-subject {
                padding: 4px 8px;
                font-size: 11px;
            }

            .main-content {
                height: calc(100vh - 40px);
            }

            .visualization-panel {
                height: 45vh;
                min-height: 200px;
            }

            .messages-container {
                padding: 8px;
            }

            .message {
                margin-bottom: 8px;
            }

            .input-area {
                padding: 8px 15px;
            }

            .input-field {
                font-size: 13px;
                padding: 6px;
            }

            .send-button {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>
                <span>ğŸ’¡</span>
                <span>èŒ…å¡é¡¿å¼€</span>
                <div class="status-indicator" id="statusIndicator"></div>
            </h1>
            <div class="current-subject" id="currentSubject">
                <span class="subject-icon" id="subjectIcon">ğŸ“</span>
                <span class="subject-label" id="subjectLabel">æ•°å­¦</span>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-panel">
                <div class="chat-header">
                    ğŸ’¬ æ™ºèƒ½å¯¹è¯
                </div>
                <div class="messages-container" id="messagesContainer">
                    <div class="message ai">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-content">
                            ä½ å¥½ï¼æˆ‘æ˜¯"èŒ…å¡é¡¿å¼€"AIåŠ©æ•™ã€‚è¯·è¾“å…¥ä½ æƒ³è¦å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œæˆ‘ä¼šè‡ªåŠ¨è¯†åˆ«å­¦ç§‘å¹¶ä¸ºä½ ç”Ÿæˆç›¸åº”çš„å¯è§†åŒ–å†…å®¹ã€‚
                            <div class="quick-suggestions" id="quickSuggestions">
                                <div class="suggestion-tag">äºŒæ¬¡å‡½æ•°</div>
                                <div class="suggestion-tag">å—åŠ›åˆ†æ</div>
                                <div class="suggestion-tag">åˆ†å­ç»“æ„</div>
                                <div class="suggestion-tag">ç»†èƒç»“æ„</div>
                                <div class="suggestion-tag">åŒ–å­¦ååº”</div>
                                <div class="suggestion-tag">é£Ÿç‰©é“¾</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="input-area">
                    <div class="input-container">
                        <textarea
                            class="input-field"
                            id="messageInput"
                            placeholder="è¾“å…¥ä½ æƒ³è¦å­¦ä¹ çš„çŸ¥è¯†ç‚¹..."
                            rows="1"
                        ></textarea>
                        <button class="send-button" id="sendButton" onclick="sendMessage()">å‘é€</button>
                    </div>
                </div>
            </div>

            <div class="visualization-panel">
                <div class="viz-header">
                    ğŸ“Š å¯è§†åŒ–å±•ç¤º
                    <span id="vizTitle" style="font-size: 12px; color: #8c8c8c;">ç­‰å¾…å†…å®¹...</span>
                </div>
                <div class="viz-content">
                    <div class="viz-placeholder" id="vizPlaceholder">
                        <div class="loading-indicator">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                        <p>è¾“å…¥å…³é”®è¯å¼€å§‹å­¦ä¹ </p>
                    </div>
                </div>
                <div class="viz-controls">
                    <div class="control-item">
                        <span class="control-label">æ˜¾ç¤ºç½‘æ ¼</span>
                        <div class="toggle-switch active" id="gridToggle" onclick="toggleControl('grid')"></div>
                    </div>
                    <div class="control-item">
                        <span class="control-label">åŠ¨ç”»æ•ˆæœ</span>
                        <div class="toggle-switch active" id="animationToggle" onclick="toggleControl('animation')"></div>
                    </div>
                    <div class="control-item">
                        <span class="control-label">äº¤äº’æ¨¡å¼</span>
                        <div class="toggle-switch active" id="interactiveToggle" onclick="toggleControl('interactive')"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å­¦ç§‘å…³é”®è¯è¯†åˆ«é…ç½®
        const subjectKeywords = {
            math: {
                name: 'æ•°å­¦',
                icon: 'ğŸ“',
                color: '#3B82F6',
                keywords: [
                    // å‡½æ•°ç›¸å…³
                    'å‡½æ•°', 'ä¸€æ¬¡å‡½æ•°', 'äºŒæ¬¡å‡½æ•°', 'ä¸‰æ¬¡å‡½æ•°', 'æŒ‡æ•°å‡½æ•°', 'å¯¹æ•°å‡½æ•°', 'ä¸‰è§’å‡½æ•°', 'æ­£å¼¦', 'ä½™å¼¦', 'æ­£åˆ‡',
                    // å‡ ä½•ç›¸å…³
                    'å‡ ä½•', 'ä¸‰è§’å½¢', 'åœ†å½¢', 'çŸ©å½¢', 'æ­£æ–¹å½¢', 'å¤šè¾¹å½¢', 'è§’åº¦', 'é¢ç§¯', 'ä½“ç§¯', 'å‘¨é•¿',
                    // ä»£æ•°ç›¸å…³
                    'ä»£æ•°', 'æ–¹ç¨‹', 'ä¸ç­‰å¼', 'å› å¼åˆ†è§£', 'å¤šé¡¹å¼', 'å˜é‡', 'ç³»æ•°', 'å¸¸æ•°',
                    // æ•°åˆ—ç›¸å…³
                    'æ•°åˆ—', 'ç­‰å·®æ•°åˆ—', 'ç­‰æ¯”æ•°åˆ—', 'é€šé¡¹', 'æ±‚å’Œ', 'é€’æ¨',
                    // ç»Ÿè®¡ç›¸å…³
                    'ç»Ÿè®¡', 'æ¦‚ç‡', 'å¹³å‡æ•°', 'ä¸­ä½æ•°', 'ä¼—æ•°', 'æ–¹å·®', 'æ ‡å‡†å·®',
                    // å…¶ä»–
                    'å‘é‡', 'çŸ©é˜µ', 'å¯¼æ•°', 'ç§¯åˆ†', 'æé™', 'é›†åˆ'
                ],
                templates: {
                    'å‡½æ•°': 'function_graph',
                    'å‡ ä½•': 'geometry_shapes',
                    'æ•°åˆ—': 'sequence_animation',
                    'ä¸‰è§’': 'trigonometry',
                    'ç»Ÿè®¡': 'statistics_chart'
                }
            },
            physics: {
                name: 'ç‰©ç†',
                icon: 'âš¡',
                color: '#10B981',
                keywords: [
                    // åŠ›å­¦ç›¸å…³
                    'åŠ›å­¦', 'åŠ›', 'é‡åŠ›', 'æ”¯æŒåŠ›', 'æ‘©æ“¦åŠ›', 'å¼ åŠ›', 'å¼¹åŠ›', 'åˆåŠ›', 'å¹³è¡¡', 'åŠ é€Ÿåº¦', 'é€Ÿåº¦',
                    'ç‰›é¡¿', 'è¿åŠ¨å­¦', 'åŠ¨èƒ½', 'åŠ¿èƒ½', 'æœºæ¢°èƒ½', 'åŠ¨é‡', 'å†²é‡', 'åŠŸ', 'åŠŸç‡',
                    // ç”µç£å­¦ç›¸å…³
                    'ç”µ', 'ç”µè·¯', 'ç”µæµ', 'ç”µå‹', 'ç”µé˜»', 'ç”µå®¹', 'ç”µæ„Ÿ', 'ç£åœº', 'ç£æ„Ÿ', 'ç”µåŠ¨åŠ¿',
                    'æ¬§å§†', 'æ³•æ‹‰ç¬¬', 'åº“ä»‘', 'ç‰¹æ–¯æ‹‰', 'ä¼ç‰¹', 'å®‰åŸ¹', 'ç“¦ç‰¹', 'ç„¦è€³',
                    // æ³¢åŠ¨ç›¸å…³
                    'æ³¢', 'å£°æ³¢', 'å…‰æ³¢', 'ç”µç£æ³¢', 'é¢‘ç‡', 'æ³¢é•¿', 'æŒ¯å¹…', 'ç›¸ä½', 'åå°„', 'æŠ˜å°„', 'è¡å°„',
                    // çƒ­å­¦ç›¸å…³
                    'çƒ­', 'æ¸©åº¦', 'çƒ­é‡', 'æ¯”çƒ­å®¹', 'çƒ­ä¼ å¯¼', 'å¯¹æµ', 'è¾å°„', 'æ°”ä½“', 'ç†æƒ³æ°”ä½“',
                    'ç‰©æ€å˜åŒ–', 'ç†”ç‚¹', 'æ²¸ç‚¹', 'å‹å¼º', 'å¤§æ°”å‹'
                ],
                templates: {
                    'åŠ›': 'force_diagram',
                    'ç”µè·¯': 'circuit_diagram',
                    'æ³¢': 'wave_animation',
                    'è¿åŠ¨': 'motion_trajectory',
                    'ç”µ': 'electromagnetic'
                }
            },
            chemistry: {
                name: 'åŒ–å­¦',
                icon: 'âš—ï¸',
                color: '#F59E0B',
                keywords: [
                    // åŒ–å­¦é”®ç›¸å…³
                    'åŒ–å­¦é”®', 'å…±ä»·é”®', 'ç¦»å­é”®', 'æ°¢é”®', 'é‡‘å±é”®', 'åˆ†å­', 'åŸå­', 'ç”µå­', 'è´¨å­', 'ä¸­å­',
                    'åŒ–å­¦å¼', 'åˆ†å­å¼', 'ç”µå­å¼', 'ç»“æ„å¼', 'åŒ–å­¦æ–¹ç¨‹', 'ååº”', 'ç”Ÿæˆç‰©', 'ååº”ç‰©',
                    // åŒ–å­¦å…ƒç´ 
                    'å…ƒç´ ', 'å‘¨æœŸè¡¨', 'åŸå­åºæ•°', 'åŒä½ç´ ', 'ç¦»å­', 'åŒ–åˆä»·', 'æ°§åŒ–è¿˜åŸ',
                    // æœ‰æœºåŒ–å­¦
                    'æœ‰æœº', 'çƒ·', 'çƒ¯', 'ç‚”', 'é†‡', 'é†›', 'é…®', 'é…¸', 'é…¯', 'èƒº', 'èŠ³é¦™æ—',
                    // åŒ–å­¦ååº”
                    'é…¸ç¢±', 'ä¸­å’Œ', 'ç½®æ¢', 'å¤åˆ†è§£', 'æ°§åŒ–è¿˜åŸ', 'ç‡ƒçƒ§', 'åˆ†è§£', 'åŒ–åˆ', 'æ°´è§£',
                    // æº¶æ¶²ç›¸å…³
                    'æº¶æ¶²', 'æº¶å‰‚', 'æº¶è´¨', 'æº¶è§£åº¦', 'æµ“åº¦', 'æ‘©å°”', 'å½“é‡', 'pHå€¼'
                ],
                templates: {
                    'åˆ†å­': 'molecule_structure',
                    'ååº”': 'chemical_reaction',
                    'å…ƒç´ ': 'periodic_table',
                    'åŒ–å­¦é”®': 'chemical_bonds',
                    'é…¸ç¢±': 'acid_base'
                }
            },
            biology: {
                name: 'ç”Ÿç‰©',
                icon: 'ğŸ§¬',
                color: '#8B5CF6',
                keywords: [
                    // ç»†èƒç›¸å…³
                    'ç»†èƒ', 'ç»†èƒè†œ', 'ç»†èƒæ ¸', 'ç»†èƒè´¨', 'ç»†èƒå£', 'çº¿ç²’ä½“', 'å¶ç»¿ä½“', 'å†…è´¨ç½‘', 'é«˜å°”åŸºä½“',
                    'æ ¸ç³–ä½“', 'æº¶é…¶ä½“', 'æ¶²æ³¡', 'ä¸­å¿ƒä½“',
                    // é—ä¼ ç›¸å…³
                    'é—ä¼ ', 'DNA', 'RNA', 'åŸºå› ', 'æŸ“è‰²ä½“', 'é—ä¼ ä¿¡æ¯', 'çªå˜', 'å˜å¼‚', 'é—ä¼ ç—…',
                    'å­Ÿå¾·å°”', 'æ˜¾æ€§', 'éšæ€§', 'ç­‰ä½åŸºå› ', 'åŸºå› å‹', 'è¡¨ç°å‹',
                    // ç”Ÿå‘½æ´»åŠ¨
                    'å…‰åˆä½œç”¨', 'å‘¼å¸ä½œç”¨', 'æ–°é™ˆä»£è°¢', 'é…¶', 'ATP', 'èƒ½é‡è½¬æ¢',
                    'æ¶ˆåŒ–', 'å¸æ”¶', 'å¾ªç¯', 'å‘¼å¸', 'æ’æ³„', 'ç¥ç»', 'æ¿€ç´ ', 'å…ç–«',
                    // ç”Ÿç‰©å¤šæ ·æ€§
                    'ç‰©ç§', 'è¿›åŒ–', 'è‡ªç„¶é€‰æ‹©', 'é€‚åº”', 'ç”Ÿæ€ç³»ç»Ÿ', 'é£Ÿç‰©é“¾', 'é£Ÿç‰©ç½‘',
                    'ç”Ÿäº§è€…', 'æ¶ˆè´¹è€…', 'åˆ†è§£è€…', 'èƒ½é‡æµåŠ¨', 'ç‰©è´¨å¾ªç¯',
                    // äººä½“ç›¸å…³
                    'äººä½“', 'å™¨å®˜', 'ç³»ç»Ÿ', 'éª¨éª¼', 'è‚Œè‚‰', 'ç¥ç»', 'å¾ªç¯', 'å‘¼å¸', 'æ¶ˆåŒ–', 'æ³Œå°¿', 'å†…åˆ†æ³Œ'
                ],
                templates: {
                    'ç»†èƒ': 'cell_structure',
                    'DNA': 'dna_structure',
                    'å…‰åˆ': 'photosynthesis',
                    'é—ä¼ ': 'genetics',
                    'é£Ÿç‰©é“¾': 'food_chain',
                    'ç”Ÿæ€': 'ecosystem'
                }
            }
        };

        // å½“å‰çŠ¶æ€
        let currentSubject = 'math';
        let isLoading = false;
        let messageCount = 0;
        let sessionStartTime = Date.now();

        // æ™ºèƒ½è¯†åˆ«å­¦ç§‘
        function recognizeSubject(message) {
            const lowerMessage = message.toLowerCase();
            let bestMatch = null;
            let maxScore = 0;

            Object.entries(subjectKeywords).forEach(([subject, config]) => {
                let score = 0;
                config.keywords.forEach(keyword => {
                    if (lowerMessage.includes(keyword)) {
                        score += keyword.length / lowerMessage.length;
                    }
                });

                if (score > maxScore) {
                    maxScore = score;
                    bestMatch = subject;
                }
            });

            return bestMatch || null;
        }

        // æ›´æ–°å­¦ç§‘æ˜¾ç¤º
        function updateSubjectDisplay(subject) {
            const config = subjectKeywords[subject];
            if (config) {
                currentSubject = subject;
                const subjectIcon = document.getElementById('subjectIcon');
                const subjectLabel = document.getElementById('subjectLabel');
                const currentSubjectEl = document.getElementById('currentSubject');

                // æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
                currentSubjectEl.style.transform = 'scale(0.9)';
                currentSubjectEl.style.opacity = '0.5';

                setTimeout(() => {
                    subjectIcon.textContent = config.icon;
                    subjectLabel.textContent = config.name;
                    currentSubjectEl.className = `current-subject ${subject}-theme`;
                    currentSubjectEl.style.transform = 'scale(1)';
                    currentSubjectEl.style.opacity = '1';
                }, 200);
            }
        }

        // æ›´æ–°å¿«é€Ÿå»ºè®®
        function updateQuickSuggestions(subject) {
            const container = document.getElementById('quickSuggestions');
            const config = subjectKeywords[subject];
            if (config) {
                const suggestions = Object.keys(config.templates).slice(0, 4);
                container.innerHTML = suggestions.map(suggestion =>
                    `<div class="suggestion-tag">${suggestion}</div>`
                ).join('');

                // æ·»åŠ ç‚¹å‡»å’Œè§¦æ‘¸äº‹ä»¶
                container.querySelectorAll('.suggestion-tag').forEach(tag => {
                    // ç‚¹å‡»äº‹ä»¶
                    tag.addEventListener('click', function() {
                        document.getElementById('messageInput').value = this.textContent;
                        sendMessage();
                    });

                    // è§¦æ‘¸ä¼˜åŒ–
                    if ('ontouchstart' in window) {
                        tag.addEventListener('touchstart', function() {
                            this.style.transform = 'scale(0.95)';
                        });
                        tag.addEventListener('touchend', function() {
                            this.style.transform = 'scale(1)';
                        });
                    }
                });
            }
        }

        // æ¸²æŸ“å¯è§†åŒ–
        function renderVisualization(templateType, subject, originalMessage = '') {
            const placeholder = document.getElementById('vizPlaceholder');
            const showGrid = document.getElementById('gridToggle').classList.contains('active');
            const config = subjectKeywords[subject];

            if (!config) return;

            // ç›´æ¥æ ¹æ®æ¨¡æ¿ç±»å‹æ¸²æŸ“ï¼Œä¸ä½¿ç”¨config.templatesæ˜ å°„
            switch(templateType) {
                case 'function_graph':
                    renderFunctionGraph(placeholder, showGrid, originalMessage);
                    break;
                case 'trigonometry':
                    renderTrigonometry(placeholder, showGrid);
                    break;
                case 'geometry_shapes':
                    renderGeometryShapes(placeholder, showGrid);
                    break;
                case 'sequence_animation':
                    renderSequenceAnimation(placeholder, showGrid);
                    break;
                case 'statistics_chart':
                    renderStatisticsChart(placeholder, showGrid);
                    break;
                case 'force_diagram':
                    renderForceDiagram(placeholder, showGrid);
                    break;
                case 'circuit_diagram':
                    renderCircuitDiagram(placeholder, showGrid);
                    break;
                case 'wave_animation':
                    renderWaveAnimation(placeholder, showGrid);
                    break;
                case 'molecule_structure':
                    renderMoleculeStructure(placeholder, showGrid);
                    break;
                case 'chemical_reaction':
                    renderChemicalReaction(placeholder, showGrid);
                    break;
                case 'cell_structure':
                    renderCellStructure(placeholder, showGrid);
                    break;
                case 'dna_structure':
                    renderDNAStructure(placeholder, showGrid);
                    break;
                case 'photosynthesis':
                    renderPhotosynthesis(placeholder);
                    break;
                case 'food_chain':
                    renderFoodChain(placeholder, showGrid);
                    break;
                default:
                    renderGeneric(placeholder, subject, templateType);
            }
        }

        // å…·ä½“çš„å¯è§†åŒ–æ¸²æŸ“å‡½æ•°
        function renderFunctionGraph(placeholder, showGrid, originalMessage = '') {
            // æ£€æµ‹æ˜¯å¦åŒ…å«ä¸‰è§’å‡½æ•°å…³é”®è¯
            const hasTrigonometric = ['æ­£å¼¦', 'ä½™å¼¦', 'æ­£åˆ‡', 'ä¸‰è§’å‡½æ•°', 'sin', 'cos', 'tan'].some(keyword =>
                originalMessage.toLowerCase().includes(keyword)
            );

            if (hasTrigonometric) {
                return renderTrigonometry(placeholder, showGrid);
            }

            // æ£€æµ‹æ˜¯å¦åŒ…å«äºŒæ¬¡å‡½æ•°å…³é”®è¯
            const hasQuadratic = ['äºŒæ¬¡å‡½æ•°', 'æŠ›ç‰©çº¿', 'ä¸€å…ƒäºŒæ¬¡'].some(keyword =>
                originalMessage.toLowerCase().includes(keyword)
            );

            const container = document.createElement('div');
            container.style.textAlign = 'center';

            const svg = `
                <svg viewBox="0 0 400 300" style="width: 100%; max-width: 350px;">
                    ${showGrid ? '<defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f0f0f0" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(#grid)" />' : ''}
                    <line x1="40" y1="260" x2="360" y2="260" stroke="#666" stroke-width="2"/>
                    <line x1="40" y1="260" x2="40" y2="40" stroke="#666" stroke-width="2"/>
                    ${hasQuadratic ? `
                        <path d="M 40 260 Q 200 40, 360 260" stroke="#3B82F6" stroke-width="3" fill="none"/>
                        <text x="300" y="30" font-size="12" fill="#3B82F6">y = xÂ²</text>
                        <text x="200" y="280" font-size="11" fill="#666">é¡¶ç‚¹ï¼š(0,0)</text>
                        <circle cx="200" cy="260" r="3" fill="#3B82F6"/>
                    ` : `
                        <path d="M 40 260 Q 200 40, 360 260" stroke="#3B82F6" stroke-width="3" fill="none"/>
                        <line x1="40" y1="200" x2="360" y2="80" stroke="#DC2626" stroke-width="3"/>
                        <text x="300" y="30" font-size="12" fill="#3B82F6">y = xÂ²</text>
                        <text x="280" y="70" font-size="12" fill="#DC2626">y = 2x + 1</text>
                    `}
                    <text x="370" y="265" font-size="12" fill="#666">x</text>
                    <text x="25" y="35" font-size="12" fill="#666">y</text>
                </svg>
            `;

            const svgDiv = document.createElement('div');
            svgDiv.innerHTML = svg;
            container.appendChild(svgDiv);

            // æ·»åŠ åŠŸèƒ½æŒ‰é’®
            const controls = document.createElement('div');
            controls.style.marginTop = '10px';
            controls.style.display = 'flex';
            controls.style.gap = '10px';
            controls.style.justifyContent = 'center';

            const openInNewPageBtn = document.createElement('button');
            openInNewPageBtn.textContent = 'åœ¨æ–°é¡µé¢æ‰“å¼€';
            openInNewPageBtn.style.cssText = `
                background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s ease;
            `;
            openInNewPageBtn.onmouseover = () => openInNewPageBtn.style.transform = 'translateY(-1px)';
            openInNewPageBtn.onmouseout = () => openInNewPageBtn.style.transform = 'translateY(0)';
            openInNewPageBtn.onclick = () => openFunctionGraphInNewPage(hasQuadratic, originalMessage);

            const resetBtn = document.createElement('button');
            resetBtn.textContent = 'é‡ç½®è§†å›¾';
            resetBtn.style.cssText = `
                background: #f3f4f6;
                color: #374151;
                border: 1px solid #d1d5db;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s ease;
            `;
            resetBtn.onmouseover = () => resetBtn.style.background = '#e5e7eb';
            resetBtn.onmouseout = () => resetBtn.style.background = '#f3f4f6';
            resetBtn.onclick = () => {
                renderFunctionGraph(placeholder, showGrid, originalMessage);
            };

            controls.appendChild(openInNewPageBtn);
            controls.appendChild(resetBtn);
            container.appendChild(controls);

            // æ·»åŠ è¯´æ˜
            const description = document.createElement('div');
            description.style.marginTop = '12px';
            description.innerHTML = `
                <p style="margin: 8px 0; color: #333; font-weight: bold;">${hasQuadratic ? 'äºŒæ¬¡å‡½æ•°å›¾åƒ' : 'å‡½æ•°å›¾åƒå¯¹æ¯”'}</p>
                <p style="margin: 4px 0; font-size: 12px; color: #666;">${hasQuadratic ? 'è“è‰²ï¼šäºŒæ¬¡å‡½æ•° y = xÂ²ï¼Œå¼€å£å‘ä¸Šï¼Œå¯¹ç§°è½´ä¸ºyè½´' : 'è“è‰²ï¼šäºŒæ¬¡å‡½æ•° | çº¢è‰²ï¼šä¸€æ¬¡å‡½æ•°'}</p>
            `;
            container.appendChild(description);

            placeholder.innerHTML = '';
            placeholder.appendChild(container);
        }

        function renderTrigonometry(placeholder, showGrid) {
            // ä½¿ç”¨Canvasç”Ÿæˆæ­£ç¡®çš„ä¸‰è§’å‡½æ•°å›¾åƒ
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 300;
            canvas.style.width = '100%';
            canvas.style.maxWidth = '350px';
            canvas.style.border = '1px solid #e0e0e0';
            canvas.style.borderRadius = '8px';

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 60; // ç¼©æ”¾å› å­

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);

            // ç»˜åˆ¶ç½‘æ ¼
            if (showGrid) {
                ctx.strokeStyle = '#f0f0f0';
                ctx.lineWidth = 1;
                for (let i = 0; i < width; i += 20) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, height);
                    ctx.stroke();
                }
                for (let i = 0; i < height; i += 20) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(width, i);
                    ctx.stroke();
                }
            }

            // ç»˜åˆ¶åæ ‡è½´
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            // Xè½´
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            // Yè½´
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();

            // ç»˜åˆ¶åˆ»åº¦å’Œæ ‡ç­¾
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';

            // Xè½´åˆ»åº¦ (Ï€çš„å€æ•°)
            const piSteps = [0, Math.PI/2, Math.PI, 3*Math.PI/2, 2*Math.PI];
            const piLabels = ['0', 'Ï€/2', 'Ï€', '3Ï€/2', '2Ï€'];
            piSteps.forEach((pi, i) => {
                const x = centerX + pi * scale;
                if (x >= 0 && x <= width) {
                    ctx.fillText(piLabels[i], x, centerY + 15);
                }
            });

            // Yè½´åˆ»åº¦
            ctx.textAlign = 'right';
            ctx.fillText('1', centerX - 5, centerY - scale + 3);
            ctx.fillText('-1', centerX - 5, centerY + scale + 3);

            // ç”Ÿæˆæ­£å¼¦å‡½æ•°è·¯å¾„
            ctx.strokeStyle = '#3B82F6';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                const angle = (x - centerX) / scale;
                const y = centerY - Math.sin(angle) * scale;
                if (x === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

            // ç”Ÿæˆä½™å¼¦å‡½æ•°è·¯å¾„
            ctx.strokeStyle = '#DC2626';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                const angle = (x - centerX) / scale;
                const y = centerY - Math.cos(angle) * scale;
                if (x === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

            // æ·»åŠ æ ‡ç­¾å’Œè¯´æ˜
            const container = document.createElement('div');
            container.style.textAlign = 'center';
            container.appendChild(canvas);

            // æ·»åŠ åŠŸèƒ½æŒ‰é’®
            const controls = document.createElement('div');
            controls.style.marginTop = '10px';
            controls.style.display = 'flex';
            controls.style.gap = '10px';
            controls.style.justifyContent = 'center';

            const openInNewPageBtn = document.createElement('button');
            openInNewPageBtn.textContent = 'åœ¨æ–°é¡µé¢æ‰“å¼€';
            openInNewPageBtn.style.cssText = `
                background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s ease;
            `;
            openInNewPageBtn.onmouseover = () => openInNewPageBtn.style.transform = 'translateY(-1px)';
            openInNewPageBtn.onmouseout = () => openInNewPageBtn.style.transform = 'translateY(0)';
            openInNewPageBtn.onclick = () => openTrigonometryInNewPage();

            const resetBtn = document.createElement('button');
            resetBtn.textContent = 'é‡ç½®è§†å›¾';
            resetBtn.style.cssText = `
                background: #f3f4f6;
                color: #374151;
                border: 1px solid #d1d5db;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s ease;
            `;
            resetBtn.onmouseover = () => resetBtn.style.background = '#e5e7eb';
            resetBtn.onmouseout = () => resetBtn.style.background = '#f3f4f6';
            resetBtn.onclick = () => {
                renderTrigonometry(placeholder, showGrid);
            };

            controls.appendChild(openInNewPageBtn);
            controls.appendChild(resetBtn);

            // è¯´æ˜æ–‡å­—
            const description = document.createElement('div');
            description.style.marginTop = '12px';
            description.innerHTML = `
                <p style="margin: 8px 0; color: #333; font-weight: bold;">ä¸‰è§’å‡½æ•°å›¾åƒ</p>
                <p style="margin: 4px 0; font-size: 12px; color: #666;">
                    <span style="color: #3B82F6; font-weight: bold;">è“è‰²</span>: æ­£å¼¦å‡½æ•° y = sin(x)
                </p>
                <p style="margin: 4px 0; font-size: 12px; color: #666;">
                    <span style="color: #DC2626; font-weight: bold;">çº¢è‰²</span>: ä½™å¼¦å‡½æ•° y = cos(x)
                </p>
                <p style="margin: 8px 0 0 0; font-size: 11px; color: #888;">
                    ç‰¹ç‚¹ï¼šå‘¨æœŸä¸º2Ï€ï¼ŒæŒ¯å¹…ä¸º1ï¼Œç›¸ä½å·®Ï€/2
                </p>
            `;

            container.appendChild(controls);
            container.appendChild(description);
            placeholder.innerHTML = '';
            placeholder.appendChild(container);
        }

        function openFunctionGraphInNewPage(isQuadratic, originalMessage) {
            const newWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
            const title = isQuadratic ? 'äºŒæ¬¡å‡½æ•°äº¤äº’å¼å¯è§†åŒ–' : 'å‡½æ•°å›¾åƒäº¤äº’å¼å¯è§†åŒ–';
            const focusFunction = isQuadratic ? 'quadratic' : 'linear';

            newWindow.document.write(`
                <!DOCTYPE html>
                <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${title}</title>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            min-height: 100vh;
                        }
                        .container {
                            max-width: 1200px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 12px;
                            padding: 30px;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                        }
                        h1 {
                            text-align: center;
                            color: #333;
                            margin-bottom: 30px;
                        }
                        .canvas-container {
                            text-align: center;
                            margin: 20px 0;
                        }
                        canvas {
                            border: 1px solid #e0e0e0;
                            border-radius: 8px;
                            max-width: 100%;
                        }
                        .controls {
                            text-align: center;
                            margin: 20px 0;
                            display: flex;
                            gap: 15px;
                            justify-content: center;
                            flex-wrap: wrap;
                        }
                        .control-group {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .control-group label {
                            font-weight: 500;
                            color: #555;
                        }
                        input[type="range"] {
                            width: 150px;
                        }
                        button {
                            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: all 0.3s ease;
                        }
                        button:hover {
                            transform: translateY(-1px);
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                        }
                        .info {
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 8px;
                            margin-top: 20px;
                        }
                        .info h3 {
                            color: #333;
                            margin-top: 0;
                        }
                        .formula {
                            background: #f1f5f9;
                            padding: 10px;
                            border-radius: 4px;
                            font-family: 'Courier New', monospace;
                            margin: 10px 0;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>ğŸ“ˆ ${title}</h1>

                        <div class="canvas-container">
                            <canvas id="functionCanvas" width="800" height="400"></canvas>
                        </div>

                        <div class="controls">
                            ${isQuadratic ? `
                                <div class="control-group">
                                    <label>ç³»æ•° a:</label>
                                    <input type="range" id="coeffA" min="-3" max="3" step="0.1" value="1">
                                    <span id="coeffAValue">1.0</span>
                                </div>
                                <div class="control-group">
                                    <label>ç³»æ•° b:</label>
                                    <input type="range" id="coeffB" min="-5" max="5" step="0.1" value="0">
                                    <span id="coeffBValue">0.0</span>
                                </div>
                                <div class="control-group">
                                    <label>ç³»æ•° c:</label>
                                    <input type="range" id="coeffC" min="-5" max="5" step="0.1" value="0">
                                    <span id="coeffCValue">0.0</span>
                                </div>
                            ` : `
                                <div class="control-group">
                                    <label>æ–œç‡ k:</label>
                                    <input type="range" id="slope" min="-5" max="5" step="0.1" value="2">
                                    <span id="slopeValue">2.0</span>
                                </div>
                                <div class="control-group">
                                    <label>æˆªè· b:</label>
                                    <input type="range" id="intercept" min="-5" max="5" step="0.1" value="1">
                                    <span id="interceptValue">1.0</span>
                                </div>
                            `}
                            <button onclick="toggleGrid()">åˆ‡æ¢ç½‘æ ¼</button>
                            <button onclick="toggleDerivative()">æ˜¾ç¤ºå¯¼æ•°</button>
                            <button onclick="resetView()">é‡ç½®è§†å›¾</button>
                        </div>

                        <div class="info">
                            <h3>æ•°å­¦å…¬å¼</h3>
                            <div class="formula" id="formulaDisplay">
                                ${isQuadratic ? 'y = axÂ² + bx + c' : 'y = kx + b'}
                            </div>
                            <p><strong>å½“å‰å‚æ•°ï¼š</strong></p>
                            <p id="currentFormula">${isQuadratic ? 'y = 1.0xÂ² + 0.0x + 0.0' : 'y = 2.0x + 1.0'}</p>
                            ${isQuadratic ? `
                                <p><strong>å…³é”®ç‰¹å¾ï¼š</strong></p>
                                <p>é¡¶ç‚¹: <span id="vertex">(0.0, 0.0)</span></p>
                                <p>å¯¹ç§°è½´: <span id="symmetry">x = 0.0</span></p>
                                <p>å¼€å£æ–¹å‘: <span id="direction">å‘ä¸Š</span></p>
                            ` : `
                                <p><strong>å…³é”®ç‰¹å¾ï¼š</strong></p>
                                <p>æ–œç‡: <span id="slopeInfo">2.0</span></p>
                                <p>yè½´æˆªè·: <span id="interceptInfo">1.0</span></p>
                                <p>xè½´æˆªè·: <span id="xIntercept">-0.5</span></p>
                            `}
                        </div>
                    </div>

                    <script>
                        let canvas, ctx, showGrid = true, showDerivative = false;

                        function init() {
                            canvas = document.getElementById('functionCanvas');
                            ctx = canvas.getContext('2d');

                            ${isQuadratic ? `
                                document.getElementById('coeffA').addEventListener('input', updateGraph);
                                document.getElementById('coeffB').addEventListener('input', updateGraph);
                                document.getElementById('coeffC').addEventListener('input', updateGraph);
                            ` : `
                                document.getElementById('slope').addEventListener('input', updateGraph);
                                document.getElementById('intercept').addEventListener('input', updateGraph);
                            `}

                            updateGraph();
                        }

                        function updateGraph() {
                            ${isQuadratic ? `
                                const a = parseFloat(document.getElementById('coeffA').value);
                                const b = parseFloat(document.getElementById('coeffB').value);
                                const c = parseFloat(document.getElementById('coeffC').value);

                                document.getElementById('coeffAValue').textContent = a.toFixed(1);
                                document.getElementById('coeffBValue').textContent = b.toFixed(1);
                                document.getElementById('coeffCValue').textContent = c.toFixed(1);
                                document.getElementById('currentFormula').textContent =
                                    \`y = \${a.toFixed(1)}xÂ² + \${b.toFixed(1)}x + \${c.toFixed(1)}\`;

                                // è®¡ç®—é¡¶ç‚¹
                                const vertexX = -b / (2 * a);
                                const vertexY = a * vertexX * vertexX + b * vertexX + c;
                                document.getElementById('vertex').textContent = \`(\${vertexX.toFixed(2)}, \${vertexY.toFixed(2)})\`;
                                document.getElementById('symmetry').textContent = \`x = \${vertexX.toFixed(2)}\`;
                                document.getElementById('direction').textContent = a > 0 ? 'å‘ä¸Š' : 'å‘ä¸‹';

                                drawQuadratic(a, b, c);
                            ` : `
                                const k = parseFloat(document.getElementById('slope').value);
                                const b = parseFloat(document.getElementById('intercept').value);

                                document.getElementById('slopeValue').textContent = k.toFixed(1);
                                document.getElementById('interceptValue').textContent = b.toFixed(1);
                                document.getElementById('currentFormula').textContent = \`y = \${k.toFixed(1)}x + \${b.toFixed(1)}\`;

                                document.getElementById('slopeInfo').textContent = k.toFixed(1);
                                document.getElementById('interceptInfo').textContent = b.toFixed(1);
                                const xIntercept = k !== 0 ? (-b / k).toFixed(2) : 'æ— ';
                                document.getElementById('xIntercept').textContent = xIntercept;

                                drawLinear(k, b);
                            `}
                        }

                        function drawQuadratic(a, b, c) {
                            const width = canvas.width;
                            const height = canvas.height;
                            const centerX = width / 2;
                            const centerY = height / 2;
                            const scale = 30;

                            ctx.clearRect(0, 0, width, height);

                            // ç»˜åˆ¶ç½‘æ ¼
                            if (showGrid) {
                                ctx.strokeStyle = '#f0f0f0';
                                ctx.lineWidth = 1;
                                for (let i = 0; i < width; i += 20) {
                                    ctx.beginPath();
                                    ctx.moveTo(i, 0);
                                    ctx.lineTo(i, height);
                                    ctx.stroke();
                                }
                                for (let i = 0; i < height; i += 20) {
                                    ctx.beginPath();
                                    ctx.moveTo(0, i);
                                    ctx.lineTo(width, i);
                                    ctx.stroke();
                                }
                            }

                            // ç»˜åˆ¶åæ ‡è½´
                            ctx.strokeStyle = '#666';
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.moveTo(0, centerY);
                            ctx.lineTo(width, centerY);
                            ctx.moveTo(centerX, 0);
                            ctx.lineTo(centerX, height);
                            ctx.stroke();

                            // ç»˜åˆ¶äºŒæ¬¡å‡½æ•°
                            ctx.strokeStyle = '#3B82F6';
                            ctx.lineWidth = 3;
                            ctx.beginPath();
                            for (let x = 0; x < width; x++) {
                                const xVal = (x - centerX) / scale;
                                const yVal = a * xVal * xVal + b * xVal + c;
                                const y = centerY - yVal * scale;
                                if (x === 0) ctx.moveTo(x, y);
                                else ctx.lineTo(x, y);
                            }
                            ctx.stroke();

                            // ç»˜åˆ¶å¯¼æ•°
                            if (showDerivative) {
                                ctx.strokeStyle = '#DC2626';
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                for (let x = 0; x < width; x++) {
                                    const xVal = (x - centerX) / scale;
                                    const yVal = 2 * a * xVal + b;
                                    const y = centerY - yVal * scale;
                                    if (x === 0) ctx.moveTo(x, y);
                                    else ctx.lineTo(x, y);
                                }
                                ctx.stroke();
                            }
                        }

                        function drawLinear(k, b) {
                            const width = canvas.width;
                            const height = canvas.height;
                            const centerX = width / 2;
                            const centerY = height / 2;
                            const scale = 30;

                            ctx.clearRect(0, 0, width, height);

                            // ç»˜åˆ¶ç½‘æ ¼
                            if (showGrid) {
                                ctx.strokeStyle = '#f0f0f0';
                                ctx.lineWidth = 1;
                                for (let i = 0; i < width; i += 20) {
                                    ctx.beginPath();
                                    ctx.moveTo(i, 0);
                                            ctx.lineTo(i, height);
                                    ctx.stroke();
                                }
                                for (let i = 0; i < height; i += 20) {
                                    ctx.beginPath();
                                    ctx.moveTo(0, i);
                                    ctx.lineTo(width, i);
                                    ctx.stroke();
                                }
                            }

                            // ç»˜åˆ¶åæ ‡è½´
                            ctx.strokeStyle = '#666';
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.moveTo(0, centerY);
                            ctx.lineTo(width, centerY);
                            ctx.moveTo(centerX, 0);
                            ctx.lineTo(centerX, height);
                            ctx.stroke();

                            // ç»˜åˆ¶çº¿æ€§å‡½æ•°
                            ctx.strokeStyle = '#3B82F6';
                            ctx.lineWidth = 3;
                            ctx.beginPath();
                            for (let x = 0; x < width; x++) {
                                const xVal = (x - centerX) / scale;
                                const yVal = k * xVal + b;
                                const y = centerY - yVal * scale;
                                if (x === 0) ctx.moveTo(x, y);
                                else ctx.lineTo(x, y);
                            }
                            ctx.stroke();
                        }

                        function toggleGrid() {
                            showGrid = !showGrid;
                            updateGraph();
                        }

                        function toggleDerivative() {
                            showDerivative = !showDerivative;
                            updateGraph();
                        }

                        function resetView() {
                            ${isQuadratic ? `
                                document.getElementById('coeffA').value = 1;
                                document.getElementById('coeffB').value = 0;
                                document.getElementById('coeffC').value = 0;
                            ` : `
                                document.getElementById('slope').value = 2;
                                document.getElementById('intercept').value = 1;
                            `}
                            showDerivative = false;
                            updateGraph();
                        }

                        window.onload = init;
                    </script>
                </body>
                </html>
            `);
            newWindow.document.close();
        }

        function openTrigonometryInNewPage() {
            const newWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
            newWindow.document.write(`
                <!DOCTYPE html>
                <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>ä¸‰è§’å‡½æ•°å¯è§†åŒ– - äº¤äº’å¼å›¾è¡¨</title>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            min-height: 100vh;
                        }
                        .container {
                            max-width: 1200px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 12px;
                            padding: 30px;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                        }
                        h1 {
                            text-align: center;
                            color: #333;
                            margin-bottom: 30px;
                        }
                        .canvas-container {
                            text-align: center;
                            margin: 20px 0;
                        }
                        canvas {
                            border: 1px solid #e0e0e0;
                            border-radius: 8px;
                            max-width: 100%;
                        }
                        .controls {
                            text-align: center;
                            margin: 20px 0;
                            display: flex;
                            gap: 15px;
                            justify-content: center;
                            flex-wrap: wrap;
                        }
                        .control-group {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .control-group label {
                            font-weight: 500;
                            color: #555;
                        }
                        input[type="range"] {
                            width: 150px;
                        }
                        button {
                            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: all 0.3s ease;
                        }
                        button:hover {
                            transform: translateY(-1px);
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                        }
                        .info {
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 8px;
                            margin-top: 20px;
                        }
                        .info h3 {
                            color: #333;
                            margin-top: 0;
                        }
                        .formula {
                            background: #f1f5f9;
                            padding: 10px;
                            border-radius: 4px;
                            font-family: 'Courier New', monospace;
                            margin: 10px 0;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>ğŸ”º ä¸‰è§’å‡½æ•°äº¤äº’å¼å¯è§†åŒ–</h1>

                        <div class="canvas-container">
                            <canvas id="trigCanvas" width="800" height="400"></canvas>
                        </div>

                        <div class="controls">
                            <div class="control-group">
                                <label>æŒ¯å¹… (A):</label>
                                <input type="range" id="amplitude" min="0.1" max="2" step="0.1" value="1">
                                <span id="ampValue">1.0</span>
                            </div>
                            <div class="control-group">
                                <label>é¢‘ç‡ (Ï‰):</label>
                                <input type="range" id="frequency" min="0.5" max="3" step="0.1" value="1">
                                <span id="freqValue">1.0</span>
                            </div>
                            <div class="control-group">
                                <label>ç›¸ä½ (Ï†):</label>
                                <input type="range" id="phase" min="0" max="6.28" step="0.1" value="0">
                                <span id="phaseValue">0.0</span>
                            </div>
                            <button onclick="toggleGrid()">åˆ‡æ¢ç½‘æ ¼</button>
                            <button onclick="toggleAnimation()">åŠ¨ç”»æ¼”ç¤º</button>
                        </div>

                        <div class="info">
                            <h3>æ•°å­¦å…¬å¼</h3>
                            <div class="formula">
                                y = AÂ·sin(Ï‰x + Ï†)  <br>
                                y = AÂ·cos(Ï‰x + Ï†)
                            </div>
                            <p><strong>å½“å‰å‚æ•°ï¼š</strong></p>
                            <p id="currentFormula">y = 1Â·sin(1Â·x + 0)</p>
                            <p><strong>ç‰¹å¾å€¼ï¼š</strong></p>
                            <p>å‘¨æœŸ: T = 2Ï€/Ï‰ = <span id="period">6.28</span></p>
                            <p>é¢‘ç‡: f = Ï‰/2Ï€ = <span id="freq">0.16</span></p>
                        </div>
                    </div>

                    <script>
                        let canvas, ctx, showGrid = true, animationId = null, time = 0;

                        function init() {
                            canvas = document.getElementById('trigCanvas');
                            ctx = canvas.getContext('2d');

                            // ç»‘å®šæ§åˆ¶å™¨
                            document.getElementById('amplitude').addEventListener('input', updateGraph);
                            document.getElementById('frequency').addEventListener('input', updateGraph);
                            document.getElementById('phase').addEventListener('input', updateGraph);

                            updateGraph();
                        }

                        function updateGraph() {
                            const A = parseFloat(document.getElementById('amplitude').value);
                            const omega = parseFloat(document.getElementById('frequency').value);
                            const phi = parseFloat(document.getElementById('phase').value);

                            document.getElementById('ampValue').textContent = A.toFixed(1);
                            document.getElementById('freqValue').textContent = omega.toFixed(1);
                            document.getElementById('phaseValue').textContent = phi.toFixed(1);
                            document.getElementById('currentFormula').textContent =
                                \`y = \${A.toFixed(1)}Â·sin(\${omega.toFixed(1)}Â·x + \${phi.toFixed(1)})\`;
                            document.getElementById('period').textContent = (2 * Math.PI / omega).toFixed(2);
                            document.getElementById('freq').textContent = (omega / (2 * Math.PI)).toFixed(2);

                            drawGraph(A, omega, phi);
                        }

                        function drawGraph(A, omega, phi, t = 0) {
                            const width = canvas.width;
                            const height = canvas.height;
                            const centerX = width / 2;
                            const centerY = height / 2;
                            const scale = 50;

                            ctx.clearRect(0, 0, width, height);

                            // ç»˜åˆ¶ç½‘æ ¼
                            if (showGrid) {
                                ctx.strokeStyle = '#f0f0f0';
                                ctx.lineWidth = 1;
                                for (let i = 0; i < width; i += 20) {
                                    ctx.beginPath();
                                    ctx.moveTo(i, 0);
                                    ctx.lineTo(i, height);
                                    ctx.stroke();
                                }
                                for (let i = 0; i < height; i += 20) {
                                    ctx.beginPath();
                                    ctx.moveTo(0, i);
                                    ctx.lineTo(width, i);
                                    ctx.stroke();
                                }
                            }

                            // ç»˜åˆ¶åæ ‡è½´
                            ctx.strokeStyle = '#666';
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.moveTo(0, centerY);
                            ctx.lineTo(width, centerY);
                            ctx.moveTo(centerX, 0);
                            ctx.lineTo(centerX, height);
                            ctx.stroke();

                            // ç»˜åˆ¶å‡½æ•°
                            ctx.lineWidth = 3;

                            // æ­£å¼¦å‡½æ•°
                            ctx.strokeStyle = '#3B82F6';
                            ctx.beginPath();
                            for (let x = 0; x < width; x++) {
                                const angle = (x - centerX) / scale;
                                const y = centerY - A * Math.sin(omega * angle + phi + t) * scale;
                                if (x === 0) ctx.moveTo(x, y);
                                else ctx.lineTo(x, y);
                            }
                            ctx.stroke();

                            // ä½™å¼¦å‡½æ•°
                            ctx.strokeStyle = '#DC2626';
                            ctx.beginPath();
                            for (let x = 0; x < width; x++) {
                                const angle = (x - centerX) / scale;
                                const y = centerY - A * Math.cos(omega * angle + phi + t) * scale;
                                if (x === 0) ctx.moveTo(x, y);
                                else ctx.lineTo(x, y);
                            }
                            ctx.stroke();
                        }

                        function toggleGrid() {
                            showGrid = !showGrid;
                            updateGraph();
                        }

                        function toggleAnimation() {
                            if (animationId) {
                                cancelAnimationFrame(animationId);
                                animationId = null;
                            } else {
                                function animate() {
                                    time += 0.05;
                                    const A = parseFloat(document.getElementById('amplitude').value);
                                    const omega = parseFloat(document.getElementById('frequency').value);
                                    const phi = parseFloat(document.getElementById('phase').value);
                                    drawGraph(A, omega, phi, time);
                                    animationId = requestAnimationFrame(animate);
                                }
                                animate();
                            }
                        }

                        window.onload = init;
                    </script>
                </body>
                </html>
            `);
            newWindow.document.close();
        }

        function renderForceDiagram(placeholder, showGrid) {
            const svg = `
                <svg viewBox="0 0 400 300" style="width: 100%; max-width: 350px;">
                    <rect x="180" y="140" width="40" height="40" fill="#F59E0B" stroke="#D97706" stroke-width="2"/>
                    <line x1="200" y1="180" x2="200" y2="230" stroke="#DC2626" stroke-width="3" marker-end="url(#arrow-red)"/>
                    <line x1="200" y1="140" x2="200" y2="90" stroke="#10B981" stroke-width="3" marker-end="url(#arrow-green)"/>
                    <line x1="180" y1="160" x2="130" y2="160" stroke="#3B82F6" stroke-width="3" marker-end="url(#arrow-blue)"/>
                    <line x1="40" y1="230" x2="360" y2="230" stroke="#666" stroke-width="2"/>
                    <defs>
                        <marker id="arrow-red" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill="#DC2626"/></marker>
                        <marker id="arrow-green" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill="#10B981"/></marker>
                        <marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill="#3B82F6"/></marker>
                    </defs>
                </svg>
                <p style="margin-top: 16px; color: #333;">ç‰©ä½“å—åŠ›åˆ†æå›¾</p>
                <p style="font-size: 12px; color: #666">çº¢è‰²ï¼šé‡åŠ› | ç»¿è‰²ï¼šæ”¯æŒåŠ› | è“è‰²ï¼šæ‘©æ“¦åŠ›</p>
            `;
            placeholder.innerHTML = svg;
        }

        function renderMoleculeStructure(placeholder, showGrid) {
            const html = `
                <svg viewBox="0 0 400 300" style="width: 100%; max-width: 350px;">
                    <g transform="translate(200, 150)">
                        <circle cx="0" cy="0" r="30" fill="#EF4444" stroke="#DC2626" stroke-width="2"/>
                        <text x="0" y="5" text-anchor="middle" font-size="16" fill="white" font-weight="bold">O</text>
                        <circle cx="-40" cy="-30" r="20" fill="#F59E0B" stroke="#D97706" stroke-width="2"/>
                        <text x="-40" y="-25" text-anchor="middle" font-size="14" fill="white" font-weight="bold">H</text>
                        <circle cx="40" cy="-30" r="20" fill="#F59E0B" stroke="#D97706" stroke-width="2"/>
                        <text x="40" y="-25" text-anchor="middle" font-size="14" fill="white" font-weight="bold">H</text>
                        <line x1="-20" y1="-15" x2="-25" y2="-10" stroke="#666" stroke-width="3"/>
                        <line x1="20" y1="-15" x2="25" y2="-10" stroke="#666" stroke-width="3"/>
                        <text x="0" y="60" text-anchor="middle" font-size="14" fill="#666">Hâ‚‚O (æ°´åˆ†å­)</text>
                    </g>
                </svg>
                <p style="margin-top: 16px; color: #333;">æ°´åˆ†å­ç»“æ„</p>
                <p style="font-size: 12px; color: #666">çº¢è‰²ï¼šæ°§åŸå­ | æ©™è‰²ï¼šæ°¢åŸå­ | ç°è‰²ï¼šå…±ä»·é”®</p>
            `;
            placeholder.innerHTML = html;
        }

        function renderCellStructure(placeholder, showGrid) {
            const svg = `
                <svg viewBox="0 0 400 300" style="width: 100%; max-width: 350px;">
                    <ellipse cx="200" cy="150" rx="160" ry="120" fill="#EDE9FE" stroke="#8B5CF6" stroke-width="3"/>
                    <ellipse cx="200" cy="150" rx="60" ry="50" fill="#DDD6FE" stroke="#8B5CF6" stroke-width="2"/>
                    <text x="200" y="155" text-anchor="middle" font-size="12" fill="#8B5CF6">ç»†èƒæ ¸</text>
                    <ellipse cx="120" cy="100" rx="30" ry="15" fill="#FCA5A5" stroke="#EF4444" stroke-width="2" transform="rotate(-30 120 100)"/>
                    <ellipse cx="280" cy="100" rx="30" ry="15" fill="#FCA5A5" stroke="#EF4444" stroke-width="2" transform="rotate(30 280 100)"/>
                    <text x="120" y="85" font-size="10" fill="#EF4444">çº¿ç²’ä½“</text>
                    <path d="M 140 180 Q 200 170, 260 180" stroke="#10B981" stroke-width="2" fill="none"/>
                    <path d="M 130 190 Q 200 180, 270 190" stroke="#10B981" stroke-width="2" fill="none"/>
                    <text x="200" y="195" text-anchor="middle" font-size="10" fill="#10B981">å†…è´¨ç½‘</text>
                    <circle cx="150" cy="130" r="4" fill="#3B82F6"/>
                    <circle cx="160" cy="125" r="4" fill="#3B82F6"/>
                    <circle cx="250" cy="130" r="4" fill="#3B82F6"/>
                    <circle cx="240" cy="125" r="4" fill="#3B82F6"/>
                    <text x="200" y="145" text-anchor="middle" font-size="10" fill="#3B82F6">æ ¸ç³–ä½“</text>
                </svg>
                <p style="margin-top: 16px; color: #333;">åŠ¨ç‰©ç»†èƒç»“æ„</p>
                <p style="font-size: 12px; color: #666">ç´«è‰²ï¼šç»†èƒæ ¸å’Œç»†èƒè†œ | çº¢è‰²ï¼šçº¿ç²’ä½“ | ç»¿è‰²ï¼šå†…è´¨ç½‘ | è“è‰²ï¼šæ ¸ç³–ä½“</p>
            `;
            placeholder.innerHTML = svg;
        }

        // æ·»åŠ ç¼ºå¤±çš„å¯è§†åŒ–å‡½æ•°
        function renderGeometryShapes(placeholder, showGrid) {
            const svg = `
                <svg viewBox="0 0 400 300" style="width: 100%; max-width: 350px;">
                    ${showGrid ? '<defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f0f0f0" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(#grid)" />' : ''}
                    <!-- ä¸‰è§’å½¢ -->
                    <path d="M 100 80 L 60 140 L 140 140 Z" fill="#3B82F6" stroke="#1E40AF" stroke-width="2"/>
                    <text x="100" y="160" text-anchor="middle" font-size="12" fill="#666">ä¸‰è§’å½¢</text>

                    <!-- åœ†å½¢ -->
                    <circle cx="250" cy="110" r="40" fill="#10B981" stroke="#047857" stroke-width="2"/>
                    <text x="250" y="160" text-anchor="middle" font-size="12" fill="#666">åœ†å½¢</text>

                    <!-- çŸ©å½¢ -->
                    <rect x="60" y="200" width="80" height="50" fill="#F59E0B" stroke="#D97706" stroke-width="2"/>
                    <text x="100" y="270" text-anchor="middle" font-size="12" fill="#666">çŸ©å½¢</text>

                    <!-- æ­£æ–¹å½¢ -->
                    <rect x="200" y="200" width="50" height="50" fill="#8B5CF6" stroke="#6D28D9" stroke-width="2"/>
                    <text x="225" y="270" text-anchor="middle" font-size="12" fill="#666">æ­£æ–¹å½¢</text>
                </svg>
                <p style="margin-top: 16px; color: #333; font-weight: bold;">å‡ ä½•å›¾å½¢å±•ç¤º</p>
                <p style="font-size: 12px; color: #666;">å¸¸è§å‡ ä½•å›¾å½¢ï¼šä¸‰è§’å½¢ã€åœ†å½¢ã€çŸ©å½¢ã€æ­£æ–¹å½¢</p>
            `;
            placeholder.innerHTML = svg;
        }

        function renderSequenceAnimation(placeholder, showGrid) {
            const svg = `
                <svg viewBox="0 0 400 300" style="width: 100%; max-width: 350px;">
                    ${showGrid ? '<defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f0f0f0" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(#grid)" />' : ''}
                    <!-- ç­‰å·®æ•°åˆ— -->
                    <text x="40" y="80" font-size="12" fill="#666">ç­‰å·®æ•°åˆ—: 2, 4, 6, 8, 10...</text>
                    <circle cx="60" cy="120" r="8" fill="#3B82F6"/>
                    <text x="60" y="125" text-anchor="middle" font-size="10" fill="white">2</text>
                    <circle cx="100" cy="120" r="8" fill="#3B82F6"/>
                    <text x="100" y="125" text-anchor="middle" font-size="10" fill="white">4</text>
                    <circle cx="140" cy="120" r="8" fill="#3B82F6"/>
                    <text x="140" y="125" text-anchor="middle" font-size="10" fill="white">6</text>
                    <circle cx="180" cy="120" r="8" fill="#3B82F6"/>
                    <text x="180" y="125" text-anchor="middle" font-size="10" fill="white">8</text>
                    <circle cx="220" cy="120" r="8" fill="#3B82F6"/>
                    <text x="220" y="125" text-anchor="middle" font-size="10" fill="white">10</text>

                    <!-- ç­‰æ¯”æ•°åˆ— -->
                    <text x="40" y="180" font-size="12" fill="#666">ç­‰æ¯”æ•°åˆ—: 2, 4, 8, 16, 32...</text>
                    <rect x="60" y="200" width="16" height="16" fill="#10B981"/>
                    <text x="68" y="211" text-anchor="middle" font-size="8" fill="white">2</text>
                    <rect x="90" y="196" width="24" height="24" fill="#10B981"/>
                    <text x="102" y="211" text-anchor="middle" font-size="8" fill="white">4</text>
                    <rect x="125" y="192" width="32" height="32" fill="#10B981"/>
                    <text x="141" y="211" text-anchor="middle" font-size="8" fill="white">8</text>
                    <rect x="168" y="188" width="40" height="40" fill="#10B981"/>
                    <text x="188" y="211" text-anchor="middle" font-size="8" fill="white">16</text>
                    <rect x="215" y="184" width="48" height="48" fill="#10B981"/>
                    <text x="239" y="211" text-anchor="middle" font-size="8" fill="white">32</text>
                </svg>
                <p style="margin-top: 16px; color: #333; font-weight: bold;">æ•°åˆ—å¯è§†åŒ–</p>
                <p style="font-size: 12px; color: #666;">è“è‰²ï¼šç­‰å·®æ•°åˆ—(å…¬å·®+2) | ç»¿è‰²ï¼šç­‰æ¯”æ•°åˆ—(å…¬æ¯”Ã—2)</p>
            `;
            placeholder.innerHTML = svg;
        }

        function renderStatisticsChart(placeholder, showGrid) {
            const svg = `
                <svg viewBox="0 0 400 300" style="width: 100%; max-width: 350px;">
                    ${showGrid ? '<defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f0f0f0" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(#grid)" />' : ''}
                    <!-- åæ ‡è½´ -->
                    <line x1="60" y1="240" x2="360" y2="240" stroke="#666" stroke-width="2"/>
                    <line x1="60" y1="240" x2="60" y2="40" stroke="#666" stroke-width="2"/>

                    <!-- æŸ±çŠ¶å›¾ -->
                    <rect x="80" y="180" width="40" height="60" fill="#3B82F6"/>
                    <text x="100" y="175" text-anchor="middle" font-size="10" fill="#3B82F6">75</text>
                    <text x="100" y="255" text-anchor="middle" font-size="10" fill="#666">A</text>

                    <rect x="140" y="140" width="40" height="100" fill="#10B981"/>
                    <text x="160" y="135" text-anchor="middle" font-size="10" fill="#10B981">85</text>
                    <text x="160" y="255" text-anchor="middle" font-size="10" fill="#666">B</text>

                    <rect x="200" y="120" width="40" height="120" fill="#F59E0B"/>
                    <text x="220" y="115" text-anchor="middle" font-size="10" fill="#F59E0B">90</text>
                    <text x="220" y="255" text-anchor="middle" font-size="10" fill="#666">C</text>

                    <rect x="260" y="160" width="40" height="80" fill="#8B5CF6"/>
                    <text x="280" y="155" text-anchor="middle" font-size="10" fill="#8B5CF6">80</text>
                    <text x="280" y="255" text-anchor="middle" font-size="10" fill="#666">D</text>

                    <!-- å¹³å‡çº¿ -->
                    <line x1="60" y1="150" x2="320" y2="150" stroke="#DC2626" stroke-width="2" stroke-dasharray="5,5"/>
                    <text x="325" y="153" font-size="10" fill="#DC2626">å¹³å‡: 82.5</text>
                </svg>
                <p style="margin-top: 16px; color: #333; font-weight: bold;">ç»Ÿè®¡å›¾è¡¨</p>
                <p style="font-size: 12px; color: #666;">å„ç§‘ç›®æˆç»©åˆ†å¸ƒï¼Œçº¢è‰²è™šçº¿è¡¨ç¤ºå¹³å‡åˆ†</p>
            `;
            placeholder.innerHTML = svg;
        }

        // é€šç”¨æ¸²æŸ“å‡½æ•°ï¼ˆå…¶ä»–å¯è§†åŒ–å¯ä»¥ç±»ä¼¼å®ç°ï¼‰
        function renderGeneric(placeholder, subject, templateType) {
            placeholder.innerHTML = `
                <div style="text-align: center; color: #666; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">
                        ${subjectKeywords[subject].icon}
                    </div>
                    <h3 style="color: #333; margin-bottom: 10px;">${subjectKeywords[subject].name}å¯è§†åŒ–</h3>
                    <p>æ¨¡æ¿ç±»å‹: ${templateType}</p>
                    <p style="font-size: 14px; margin-top: 20px;">è¯¥æ¨¡æ¿çš„å…·ä½“å¯è§†åŒ–æ­£åœ¨å¼€å‘ä¸­...</p>
                </div>
            `;
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (isLoading) return;

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            input.style.height = 'auto';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();

            // æ¨¡æ‹ŸAIå“åº”
            setTimeout(() => {
                hideLoading();

                // æ™ºèƒ½è¯†åˆ«å­¦ç§‘
                const recognizedSubject = recognizeSubject(message);

                if (recognizedSubject && recognizedSubject !== currentSubject) {
                    // å­¦ç§‘æ”¹å˜ï¼Œæ›´æ–°æ˜¾ç¤º
                    updateSubjectDisplay(recognizedSubject);
                    updateQuickSuggestions(recognizedSubject);

                    // å‘é€å­¦ç§‘åˆ‡æ¢é€šçŸ¥
                    addMessage(`æˆ‘å·²ç»è¯†åˆ«åˆ°ä½ åœ¨è¯¢é—®${subjectKeywords[recognizedSubject].name}ç›¸å…³çš„å†…å®¹ï¼Œç°åœ¨ä¸ºä½ åˆ‡æ¢åˆ°${subjectKeywords[recognizedSubject].name}å­¦ç§‘æ¨¡å¼ã€‚`, 'ai');
                }

                // ç”ŸæˆAIå›å¤
                const response = generateAIResponse(message, currentSubject);
                addMessage(response.message, 'ai');

                // æ¸²æŸ“å¯è§†åŒ–
                renderVisualization(response.templateType, currentSubject, response.originalMessage);
                document.getElementById('vizTitle').textContent = response.title;

                messageCount++;
            }, 1000);
        }

        // ç”ŸæˆAIå›å¤
        function generateAIResponse(message, subject) {
            const config = subjectKeywords[subject];
            const lowerMessage = message.toLowerCase();

            // æ™ºèƒ½åŒ¹é…æ¨¡æ¿ç±»å‹
            let templateType = 'function_graph'; // é»˜è®¤ä¸ºå‡½æ•°å›¾åƒ
            let specificTopic = '';

            // é’ˆå¯¹æ•°å­¦å­¦ç§‘çš„è¯¦ç»†åŒ¹é…
            if (subject === 'math') {
                if (['æ­£å¼¦', 'ä½™å¼¦', 'æ­£åˆ‡', 'ä¸‰è§’å‡½æ•°', 'sin', 'cos', 'tan'].some(keyword => lowerMessage.includes(keyword))) {
                    templateType = 'trigonometry';
                    specificTopic = 'ä¸‰è§’å‡½æ•°';
                } else if (['äºŒæ¬¡å‡½æ•°', 'æŠ›ç‰©çº¿', 'ä¸€å…ƒäºŒæ¬¡'].some(keyword => lowerMessage.includes(keyword))) {
                    templateType = 'function_graph';
                    specificTopic = 'äºŒæ¬¡å‡½æ•°';
                } else if (['ä¸€æ¬¡å‡½æ•°', 'çº¿æ€§å‡½æ•°', 'ç›´çº¿'].some(keyword => lowerMessage.includes(keyword))) {
                    templateType = 'function_graph';
                    specificTopic = 'ä¸€æ¬¡å‡½æ•°';
                } else if (['å‡ ä½•', 'ä¸‰è§’å½¢', 'åœ†', 'çŸ©å½¢', 'é¢ç§¯', 'ä½“ç§¯'].some(keyword => lowerMessage.includes(keyword))) {
                    templateType = 'geometry_shapes';
                    specificTopic = 'å‡ ä½•å›¾å½¢';
                } else if (['æ•°åˆ—', 'ç­‰å·®', 'ç­‰æ¯”', 'é€’æ¨', 'é€šé¡¹'].some(keyword => lowerMessage.includes(keyword))) {
                    templateType = 'sequence_animation';
                    specificTopic = 'æ•°åˆ—';
                } else if (['ç»Ÿè®¡', 'æ¦‚ç‡', 'å¹³å‡æ•°', 'æ–¹å·®', 'æ ‡å‡†å·®'].some(keyword => lowerMessage.includes(keyword))) {
                    templateType = 'statistics_chart';
                    specificTopic = 'ç»Ÿè®¡æ¦‚ç‡';
                }
            }

            // ç”Ÿæˆæ›´æœ‰é’ˆå¯¹æ€§çš„å›å¤
            let aiMessage = '';
            if (specificTopic) {
                aiMessage = `æˆ‘ç†è§£äº†ä½ æƒ³äº†è§£${specificTopic}ç›¸å…³çš„çŸ¥è¯†ã€‚${specificTopic}æ˜¯${config.name}å­¦ç§‘ä¸­çš„é‡è¦æ¦‚å¿µã€‚è®©æˆ‘ä¸ºä½ ç”Ÿæˆç›¸åº”çš„å¯è§†åŒ–å†…å®¹æ¥å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ã€‚`;
            } else {
                aiMessage = `æˆ‘ç†è§£äº†ä½ çš„é—®é¢˜ã€‚åœ¨${config.name}å­¦ç§‘ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µã€‚è®©æˆ‘ä¸ºä½ ç”Ÿæˆç›¸åº”çš„å¯è§†åŒ–å†…å®¹ã€‚`;
            }

            return {
                message: aiMessage,
                templateType: templateType,
                title: `${config.name} - ${specificTopic || 'å‡½æ•°'}å¯è§†åŒ–`,
                originalMessage: message // ä¿ç•™åŸå§‹æ¶ˆæ¯ç”¨äºæ¨¡æ¿åŒ¹é…
            };
        }

        // æ·»åŠ æ¶ˆæ¯
        function addMessage(content, sender) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content}</div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            isLoading = true;

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.classList.add('processing');

            const container = document.getElementById('messagesContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message ai loading-message';
            loadingDiv.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div style="margin-bottom: 8px;">æ­£åœ¨åˆ†æå†…å®¹å¹¶ç”Ÿæˆå¯è§†åŒ–...</div>
                    <div class="loading-indicator">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>
            `;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;

            // æ·»åŠ è§†è§‰åé¦ˆ
            document.getElementById('vizPlaceholder').innerHTML = `
                <div style="text-align: center; color: #666;">
                    <div class="loading-indicator" style="margin-bottom: 16px;">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                    <p>æ­£åœ¨ç”Ÿæˆå¯è§†åŒ–å†…å®¹...</p>
                </div>
            `;
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            isLoading = false;

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.classList.remove('processing');

            const loadingMessage = document.querySelector('.loading-message');
            if (loadingMessage) {
                // æ·»åŠ æ·¡å‡ºæ•ˆæœ
                loadingMessage.style.opacity = '0';
                loadingMessage.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    if (loadingMessage.parentNode) {
                        loadingMessage.remove();
                    }
                }, 300);
            }
        }

        // æ§åˆ¶å¼€å…³
        function toggleControl(controlName) {
            const toggle = document.getElementById(controlName + 'Toggle');
            toggle.classList.toggle('active');

            // æ·»åŠ è§¦è§‰åé¦ˆæ•ˆæœ
            toggle.style.transform = 'scale(0.9)';
            setTimeout(() => {
                toggle.style.transform = 'scale(1)';
            }, 100);

            // é‡æ–°æ¸²æŸ“å½“å‰å¯è§†åŒ–
            if (document.getElementById('vizTitle').textContent !== 'ç­‰å¾…å†…å®¹...') {
                const currentTitle = document.getElementById('vizTitle').textContent;
                // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦é‡æ–°æ¸²æŸ“å½“å‰çš„å¯è§†åŒ–
                showNotification(`${controlName} ${toggle.classList.contains('active') ? 'å·²å¼€å¯' : 'å·²å…³é—­'}`);
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: rgba(16, 185, 129, 0.9);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                font-size: 14px;
                animation: slideInUp 0.3s ease-out;
                backdrop-filter: blur(10px);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInUp {
                    from {
                        opacity: 0;
                        transform: translateY(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                    if (style.parentNode) {
                        style.remove();
                    }
                }, 300);
            }, 2000);
        }

        // ç§»åŠ¨ç«¯ä¼˜åŒ–
        function addMobileOptimizations() {
            const messageInput = document.getElementById('messageInput');
            const messagesContainer = document.getElementById('messagesContainer');

            // è§¦æ‘¸ä¼˜åŒ–ï¼šå¢åŠ å¯ç‚¹å‡»åŒºåŸŸ
            if ('ontouchstart' in window) {
                document.body.classList.add('touch-device');

                // ä¸ºå¿«é€Ÿå»ºè®®æ ‡ç­¾å¢åŠ è§¦æ‘¸åé¦ˆ
                document.querySelectorAll('.suggestion-tag').forEach(tag => {
                    tag.addEventListener('touchstart', function() {
                        this.style.transform = 'scale(0.95)';
                    });
                    tag.addEventListener('touchend', function() {
                        this.style.transform = 'scale(1)';
                    });
                });

                // é˜²æ­¢åŒå‡»ç¼©æ”¾
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(e) {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }

            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            messageInput.addEventListener('focus', function() {
                // ç§»åŠ¨ç«¯å»¶è¿Ÿæ»šåŠ¨ä»¥ç¡®ä¿é”®ç›˜ä¸é®æŒ¡è¾“å…¥æ¡†
                setTimeout(() => {
                    this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            });

            // é”®ç›˜é«˜åº¦é€‚é…
            const initialViewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            window.addEventListener('resize', function() {
                const currentHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
                const keyboardHeight = initialViewportHeight - currentHeight;

                if (keyboardHeight > 150) {
                    // é”®ç›˜å¼¹èµ·æ—¶çš„è°ƒæ•´
                    document.querySelector('.chat-panel').style.height = `calc(100vh - ${keyboardHeight}px - 120px)`;
                } else {
                    // é”®ç›˜æ”¶èµ·æ—¶æ¢å¤
                    document.querySelector('.chat-panel').style.height = '';
                }
            });
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', function() {
            document.getElementById('messageInput').focus();
            updateQuickSuggestions('math');
            addMobileOptimizations();
        });
    </script>
</body>
</html>