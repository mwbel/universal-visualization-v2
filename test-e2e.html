<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡ç‰©å¯è§†åŒ– - ç«¯åˆ°ç«¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .prompt-input {
            width: 100%;
            height: 60px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            margin: 10px 0;
        }
        .examples {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .example-btn {
            background: #f3f4f6;
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
        }
        .example-btn:hover {
            background: #e5e7eb;
        }
    </style>
</head>
<body>
    <h1>ğŸŒŸ ä¸‡ç‰©å¯è§†åŒ– - ç«¯åˆ°ç«¯æµ‹è¯•</h1>
    <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•ä»å‰ç«¯è¾“å…¥åˆ°åç«¯ç”Ÿæˆå¯è§†åŒ–çš„å®Œæ•´å·¥ä½œæµ</p>

    <!-- 1. åç«¯è¿æ¥æµ‹è¯• -->
    <div class="test-container">
        <h2>ğŸ”§ 1. åç«¯è¿æ¥æµ‹è¯•</h2>
        <button class="test-button" onclick="testBackendConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
        <div id="connection-result"></div>
    </div>

    <!-- 2. APIæµ‹è¯• -->
    <div class="test-container">
        <h2>ğŸ“¡ 2. APIæ¥å£æµ‹è¯•</h2>
        <button class="test-button" onclick="testAPICall()">æµ‹è¯•APIè°ƒç”¨</button>
        <div id="api-result"></div>
    </div>

    <!-- 3. ç«¯åˆ°ç«¯å·¥ä½œæµæµ‹è¯• -->
    <div class="test-container">
        <h2>ğŸ¯ 3. ç«¯åˆ°ç«¯å·¥ä½œæµæµ‹è¯•</h2>

        <h3>è¾“å…¥å¯è§†åŒ–éœ€æ±‚:</h3>
        <textarea id="promptInput" class="prompt-input" placeholder="è¯·è¾“å…¥å¯è§†åŒ–éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæ­£æ€åˆ†å¸ƒ å‡å€¼0 æ ‡å‡†å·®1">æ­£æ€åˆ†å¸ƒ å‡å€¼0 æ ‡å‡†å·®1</textarea>

        <h3>å¿«é€Ÿé€‰æ‹©ç¤ºä¾‹:</h3>
        <div class="examples">
            <button class="example-btn" onclick="setPrompt('æ­£æ€åˆ†å¸ƒ å‡å€¼0 æ ‡å‡†å·®1')">
                ğŸ“Š æ­£æ€åˆ†å¸ƒ å‡å€¼0 æ ‡å‡†å·®1
            </button>
            <button class="example-btn" onclick="setPrompt('äºŒé¡¹åˆ†å¸ƒ n=20 p=0.3')">
                ğŸ“ˆ äºŒé¡¹åˆ†å¸ƒ n=20 p=0.3
            </button>
            <button class="example-btn" onclick="setPrompt('å‘é‡æŠ•å½± ä¸‰ç»´ç©ºé—´')">
                ğŸ”¢ å‘é‡æŠ•å½± ä¸‰ç»´ç©ºé—´
            </button>
            <button class="example-btn" onclick="setPrompt('å‡½æ•°å›¾åƒ y = x^2 + 2x + 1')">
                ğŸ“ å‡½æ•°å›¾åƒ y = x^2 + 2x + 1
            </button>
            <button class="example-btn" onclick="setPrompt('å¤ªé˜³ç³»è¡Œæ˜Ÿè¿åŠ¨ åœ°çƒ ç«æ˜Ÿ')">
                ğŸª å¤ªé˜³ç³»è¡Œæ˜Ÿè¿åŠ¨ åœ°çƒ ç«æ˜Ÿ
            </button>
            <button class="example-btn" onclick="setPrompt('ç®€è°æŒ¯åŠ¨ æŒ¯å¹…2 é¢‘ç‡1Hz')">
                ğŸŒŠ ç®€è°æŒ¯åŠ¨ æŒ¯å¹…2 é¢‘ç‡1Hz
            </button>
        </div>

        <button class="test-button" onclick="testE2EWorkflow()">ğŸš€ å¼€å§‹ç”Ÿæˆå¯è§†åŒ–</button>
        <div id="e2e-result"></div>
    </div>

    <!-- 4. æ–°çª—å£æ‰“å¼€æµ‹è¯• -->
    <div class="test-container">
        <h2>ğŸªŸ 4. æ–°çª—å£æ‰“å¼€æµ‹è¯•</h2>
        <p>æµ‹è¯•ç”Ÿæˆçš„å¯è§†åŒ–æ˜¯å¦èƒ½åœ¨æ–°çª—å£ä¸­æ­£å¸¸æ˜¾ç¤º</p>
        <div id="window-result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9999/api/v2';
        let currentGenerationId = null;

        // æµ‹è¯•åç«¯è¿æ¥
        async function testBackendConnection() {
            const resultDiv = document.getElementById('connection-result');

            try {
                resultDiv.innerHTML = '<div class="test-result info">ğŸ”„ æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...</div>';

                const response = await fetch('http://localhost:9999/');
                const data = await response.json();

                resultDiv.innerHTML = `
                    <div class="test-result success">
âœ… åç«¯è¿æ¥æˆåŠŸï¼
ğŸ“Š æœåŠ¡ä¿¡æ¯:
   åç§°: ${data.name}
   ç‰ˆæœ¬: ${data.version}
   æè¿°: ${data.description}
   ç«¯ç‚¹æ•°é‡: ${Object.keys(data.endpoints || {}).length}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result error">
âŒ åç«¯è¿æ¥å¤±è´¥ï¼
é”™è¯¯ä¿¡æ¯: ${error.message}
è¯·ç¡®ä¿åç«¯æœåŠ¡åœ¨ http://localhost:9999 è¿è¡Œ
                    </div>
                `;
            }
        }

        // æµ‹è¯•APIè°ƒç”¨
        async function testAPICall() {
            const resultDiv = document.getElementById('api-result');

            try {
                resultDiv.innerHTML = '<div class="test-result info">ğŸ”„ æ­£åœ¨æµ‹è¯•APIè°ƒç”¨...</div>';

                const response = await fetch(`${API_BASE}/templates`);
                const data = await response.json();

                resultDiv.innerHTML = `
                    <div class="test-result success">
âœ… APIè°ƒç”¨æˆåŠŸï¼
ğŸ“‹ æ¨¡æ¿ä¿¡æ¯:
   æ€»æ¨¡æ¿æ•°: ${data.total}
   æ”¯æŒå­¦ç§‘: ${data.subjects ? data.subjects.join(', ') : 'N/A'}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result error">
âŒ APIè°ƒç”¨å¤±è´¥ï¼
é”™è¯¯ä¿¡æ¯: ${error.message}
                    </div>
                `;
            }
        }

        // è®¾ç½®æç¤ºè¯
        function setPrompt(prompt) {
            document.getElementById('promptInput').value = prompt;
        }

        // æµ‹è¯•ç«¯åˆ°ç«¯å·¥ä½œæµ
        async function testE2EWorkflow() {
            const resultDiv = document.getElementById('e2e-result');
            const windowResultDiv = document.getElementById('window-result');
            const prompt = document.getElementById('promptInput').value.trim();

            if (!prompt) {
                alert('è¯·è¾“å…¥å¯è§†åŒ–éœ€æ±‚ï¼');
                return;
            }

            try {
                resultDiv.innerHTML = '<div class="test-result info">ğŸ”„ æ­£åœ¨ç”Ÿæˆå¯è§†åŒ–ï¼Œè¯·ç¨å€™...</div>';
                windowResultDiv.innerHTML = '';

                const response = await fetch(`${API_BASE}/highschool/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        grade_level: 'high_school',
                        interaction_mode: 'visualization',
                        user_preferences: {
                            interactive: true,
                            export_enabled: true
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentGenerationId = data.generation_id;

                    resultDiv.innerHTML = `
                        <div class="test-result success">
âœ… å¯è§†åŒ–ç”ŸæˆæˆåŠŸï¼
ğŸ“Š ç”Ÿæˆä¿¡æ¯:
   ç”ŸæˆID: ${data.generation_id}
   å­¦ç§‘: ${data.subject}
   æ¶ˆæ¯: ${data.message}
   å¯è§†åŒ–æ ‡é¢˜: ${data.visualization?.title || 'N/A'}
   å¹´çº§: ${data.visualization?.grade_level || 'N/A'}
   ç½®ä¿¡åº¦: ${data.metadata?.confidence || 'N/A'}
                        </div>
                    `;

                    // æ˜¾ç¤ºæ–°çª—å£æ‰“å¼€é€‰é¡¹
                    windowResultDiv.innerHTML = `
                        <div class="test-result info">
ğŸªŸ å¯è§†åŒ–å·²å‡†å¤‡å°±ç»ªï¼
<br>
<button class="test-button" onclick="openVisualization('${data.generation_id}', '${data.visualization?.html_content ? 'direct' : 'url'}')">
   ğŸš€ åœ¨æ–°çª—å£ä¸­æ‰“å¼€å¯è§†åŒ–
</button>
<br>
<small>æç¤ºï¼šå¦‚æœå¼¹çª—è¢«é˜»æ­¢ï¼Œè¯·å…è®¸æ­¤ç½‘ç«™çš„å¼¹çª—</small>
                        </div>
                    `;

                } else {
                    resultDiv.innerHTML = `
                        <div class="test-result error">
âŒ å¯è§†åŒ–ç”Ÿæˆå¤±è´¥ï¼
é”™è¯¯ä¿¡æ¯: ${data.error || data.message || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result error">
âŒ å·¥ä½œæµæµ‹è¯•å¤±è´¥ï¼
é”™è¯¯ä¿¡æ¯: ${error.message}
                    </div>
                `;
            }
        }

        // æ‰“å¼€å¯è§†åŒ–
        function openVisualization(generationId, method) {
            try {
                let newWindow;

                if (method === 'direct') {
                    // å¦‚æœæœ‰ç›´æ¥HTMLå†…å®¹ï¼Œåœ¨æ–°çª—å£ä¸­æ‰“å¼€
                    // æ³¨æ„ï¼šç”±äºè·¨åŸŸé™åˆ¶ï¼Œè¿™ç§æ–¹æ³•å¯èƒ½ä¸ä¼šå·¥ä½œ
                    alert('ç›´æ¥HTMLæ–¹æ³•åœ¨æ­¤æµ‹è¯•é¡µé¢ä¸­ä¸å¯ç”¨ï¼Œè¯·åœ¨å®é™…åº”ç”¨ä¸­ä½¿ç”¨');
                } else {
                    // é€šè¿‡URLæ‰“å¼€
                    const url = `${API_BASE}/visualizations/viz_${generationId.replace('viz_', '')}`;
                    newWindow = window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');

                    if (newWindow) {
                        newWindow.focus();
                        document.getElementById('window-result').innerHTML = `
                            <div class="test-result success">
âœ… æ–°çª—å£å·²æ‰“å¼€ï¼
URL: ${url}
å¦‚æœçœ‹åˆ°å¯è§†åŒ–é¡µé¢ï¼Œè¯´æ˜ç«¯åˆ°ç«¯å·¥ä½œæµå®Œå…¨æˆåŠŸï¼
                            </div>
                        `;
                    } else {
                        alert('å¼¹çª—è¢«é˜»æ­¢ï¼Œè¯·å…è®¸æ­¤ç½‘ç«™çš„å¼¹çª—');
                    }
                }
            } catch (error) {
                alert(`æ‰“å¼€æ–°çª—å£å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•åç«¯è¿æ¥
        window.onload = function() {
            testBackendConnection();
        };
    </script>
</body>
</html>