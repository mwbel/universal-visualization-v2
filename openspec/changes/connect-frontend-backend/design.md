# 前后端数据流打通 - 架构设计

## 当前架构分析

### 现有系统架构
```
┌─────────────────────────────────────────────────────────────┐
│                        前端层                                │
├─────────────────┬─────────────────┬─────────────────────────┤
│  数学可视化模块    │  天文学可视化模块  │    物理学可视化模块        │
│  (静态页面)       │  (静态页面)       │    (静态页面)           │
└─────────────────┴─────────────────┴─────────────────────────┘
                                │
                       ❌ 数据流断链
                                │
┌─────────────────────────────────────────────────────────────┐
│                        后端层                                │
├─────────────────┬─────────────────┬─────────────────────────┤
│  FastAPI服务     │  可视化生成器     │    注册表管理            │
│  /api/resolve_   │  generate_       │    registry.json        │
│  generate        │  visualization   │                         │
└─────────────────┴─────────────────┴─────────────────────────┘
```

### 问题识别
1. **前端入口缺失**: 没有统一的用户输入界面
2. **API集成不完整**: 前端无法调用后端生成API
3. **页面渲染断链**: 生成的HTML无法在前端动态展示
4. **状态管理缺失**: 缺乏加载状态、错误处理机制

## 目标架构设计

### 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    前端应用层                                │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   主输入界面      │  │   可视化容器      │  │   状态管理    │ │
│  │  (SmartInput)   │  │ (VizContainer)  │  │ (StateManager)│ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                           HTTP/JSON API
                                │
┌─────────────────────────────────────────────────────────────┐
│                    后端服务层                                │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │  API路由层       │  │  业务逻辑层       │  │  数据持久层    │ │
│  │  /api/resolve_  │  │  智能理解引擎     │  │  注册表/文件   │ │
│  │  generate       │  │  生成器          │  │  存储         │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 数据流设计
```
用户输入需求
    ↓
前端输入界面 (SmartInput)
    ↓
API客户端 (ApiClient) → 状态管理 (加载中)
    ↓
后端API (/api/resolve_or_generate)
    ↓
智能理解引擎 → 可视化生成器
    ↓
HTML页面生成 → 文件存储
    ↓
API响应 → 前端接收URL
    ↓
可视化容器 (VizContainer) → 动态加载页面
    ↓
用户交互体验
```

## 核心组件设计

### 1. 前端API客户端 (ApiClient)

**职责**: 统一管理后端API调用

**接口设计**:
```javascript
class ApiClient {
  async resolveOrGenerate(prompt, options = {}) {
    // 调用 /api/resolve_or_generate
    // 处理响应格式和错误
    // 支持请求取消和重试
  }

  async getVisualizationList() {
    // 获取可用可视化列表
  }

  async healthCheck() {
    // 服务健康检查
  }
}
```

**错误处理策略**:
- 网络错误: 重试机制 + 用户提示
- API错误: 分类处理 + 友好提示
- 超时处理: 取消请求 + 降级方案

### 2. 状态管理器 (StateManager)

**职责**: 管理应用状态和用户交互

**状态结构**:
```javascript
const state = {
  // UI状态
  ui: {
    isLoading: false,
    error: null,
    currentView: 'input' | 'visualization'
  },

  // 用户输入
  input: {
    prompt: '',
    template: null,
    parameters: {}
  },

  // 可视化结果
  visualization: {
    url: null,
    title: null,
    type: 'existing' | 'generated'
  },

  // 历史记录
  history: []
}
```

### 3. 可视化容器 (VizContainer)

**职责**: 动态加载和展示可视化页面

**功能特性**:
- 支持多种加载方式 (iframe, embed, fetch)
- 参数同步和URL管理
- 错误边界和降级处理
- 全屏模式和响应式布局

**实现方案**:
```javascript
class VizContainer {
  async loadVisualization(url, options = {}) {
    // 动态加载HTML内容
    // 注入通用样式和脚本
    // 设置参数和事件监听
  }

  unload() {
    // 清理资源和事件监听
  }

  syncParameters(params) {
    // 同步参数到可视化页面
  }
}
```

### 4. 主输入界面 (SmartInput)

**职责**: 提供用户友好的输入体验

**核心功能**:
- 自然语言输入框
- 模板选择器
- 智能提示和自动补全
- 输入验证和建议

**交互设计**:
```javascript
class SmartInput {
  constructor(options) {
    this.templates = options.templates;
    this.validator = options.validator;
    this.autoComplete = options.autoComplete;
  }

  async submitInput() {
    // 验证输入
    // 显示加载状态
    // 调用API生成可视化
    // 处理响应和错误
  }
}
```

## API规范设计

### 1. 主要API端点

#### POST /api/resolve_or_generate
**请求格式**:
```json
{
  "prompt": "正态分布 均值0 标准差1",
  "vizType": "自动",
  "complexity": "中等",
  "parameters": {
    "mu": 0,
    "sigma": 1
  }
}
```

**响应格式**:
```json
{
  "kind": "generated", // "existing" | "generated"
  "url": "/app/modules/ai_visualizer/generated/viz_normal_distribution_20251028_143022.html",
  "title": "标准正态分布",
  "metadata": {
    "concept": "normal_distribution",
    "parameters": {"mu": 0, "sigma": 1},
    "generationTime": "2025-10-28T14:30:22Z"
  }
}
```

#### GET /api/templates
**响应格式**:
```json
{
  "categories": [
    {
      "id": "mathematics",
      "name": "数学可视化",
      "templates": [
        {
          "id": "normal_distribution",
          "name": "正态分布",
          "description": "标准正态分布概率密度函数",
          "parameters": [
            {"name": "mu", "type": "number", "default": 0, "label": "均值"},
            {"name": "sigma", "type": "number", "default": 1, "label": "标准差"}
          ]
        }
      ]
    }
  ]
}
```

### 2. 错误处理规范

**错误响应格式**:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "输入参数无效",
    "details": {
      "field": "prompt",
      "issue": "不能为空"
    },
    "timestamp": "2025-10-28T14:30:22Z"
  }
}
```

**错误代码定义**:
- `VALIDATION_ERROR`: 输入验证失败
- `GENERATION_ERROR`: 可视化生成失败
- `NETWORK_ERROR`: 网络连接问题
- `TIMEOUT_ERROR`: 请求超时
- `INTERNAL_ERROR`: 服务器内部错误

## 性能优化策略

### 1. 前端优化
- **代码分割**: 按需加载可视化组件
- **缓存策略**: 缓存API响应和生成结果
- **预加载**: 预加载常用模板和资源
- **懒加载**: 延迟加载非关键资源

### 2. 后端优化
- **响应缓存**: 缓存常见可视化生成结果
- **异步处理**: 长时间生成任务异步化
- **资源优化**: CDN加速静态资源
- **并发控制**: 限制并发生成任务数

### 3. 网络优化
- **压缩传输**: Gzip压缩API响应
- **HTTP/2**: 支持多路复用
- **缓存头**: 合理设置缓存策略
- **CDN集成**: 静态资源CDN分发

## 安全考虑

### 1. 输入安全
- **参数验证**: 严格验证用户输入
- **XSS防护**: 输出内容转义
- **长度限制**: 限制输入长度
- **内容过滤**: 过滤恶意内容

### 2. API安全
- **CORS配置**: 合理配置跨域策略
- **速率限制**: 防止API滥用
- **认证授权**: 可选的用户认证
- **日志审计**: 记录API访问日志

### 3. 文件安全
- **路径验证**: 防止路径遍历攻击
- **文件类型**: 限制生成文件类型
- **存储隔离**: 隔离用户生成文件
- **定期清理**: 定期清理临时文件

## 监控和日志

### 1. 前端监控
- **性能监控**: 页面加载时间、API响应时间
- **错误监控**: JavaScript错误、网络错误
- **用户行为**: 输入统计、功能使用情况
- **用户体验**: 页面跳出率、交互完成率

### 2. 后端监控
- **API监控**: 请求量、响应时间、错误率
- **系统监控**: CPU、内存、磁盘使用情况
- **业务监控**: 生成成功率、模板使用统计
- **安全监控**: 异常访问、攻击检测

## 部署策略

### 1. 开发环境
- **本地开发**: 热重载、调试工具
- **代理配置**: 解决跨域问题
- **模拟数据**: 支持离线开发
- **测试数据**: 预置测试用例

### 2. 生产环境
- **静态部署**: 前端静态文件部署
- **API服务**: 后端服务容器化部署
- **负载均衡**: 支持水平扩展
- **监控告警**: 完整的监控体系

### 3. 灰度发布
- **A/B测试**: 新功能灰度验证
- **回滚机制**: 快速回滚能力
- **数据监控**: 实时监控关键指标
- **用户反馈**: 收集用户使用反馈

这个架构设计确保了前后端数据流的完整打通，同时保持了系统的可扩展性和可维护性，为后续的功能增强和性能优化奠定了坚实的基础。