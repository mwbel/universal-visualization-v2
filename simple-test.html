<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•å¯è§†åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .status.success {
            background: #d1edff;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .result-section {
            margin-top: 30px;
            display: none;
        }

        .result-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .preview-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .preview-section h4 {
            margin-top: 0;
            color: #333;
        }

        .preview-frame {
            width: 100%;
            height: 400px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .debug-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ç®€å•å¯è§†åŒ–æµ‹è¯•</h1>

        <div class="input-group">
            <label for="prompt">è¾“å…¥å¯è§†åŒ–éœ€æ±‚ï¼š</label>
            <input type="text" id="prompt" value="æ­£æ€åˆ†å¸ƒ å‡å€¼0 æ ‡å‡†å·®1" placeholder="ä¾‹å¦‚ï¼šæ­£æ€åˆ†å¸ƒ å‡å€¼0 æ ‡å‡†å·®1">
        </div>

        <button class="btn" id="generateBtn" onclick="testGeneration()">
            <span id="btnText">ğŸš€ ç”Ÿæˆå¯è§†åŒ–</span>
        </button>

        <div id="status" class="status"></div>

        <div id="resultSection" class="result-section">
            <h3>ğŸ“Š ç”Ÿæˆç»“æœï¼š</h3>
            <div id="resultInfo" class="result-info"></div>

            <div class="preview-section">
                <h4>ğŸ‘ï¸ å¯è§†åŒ–é¢„è§ˆï¼š</h4>
                <iframe id="previewFrame" class="preview-frame"></iframe>
            </div>

            <button class="btn" onclick="openInNewWindow()">
                ğŸ”— åœ¨æ–°çª—å£æ‰“å¼€
            </button>

            <div id="debugInfo" class="debug-info"></div>
        </div>
    </div>

    <script>
        let currentResult = null;

        async function testGeneration() {
            const prompt = document.getElementById('prompt').value.trim();
            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            const status = document.getElementById('status');

            if (!prompt) {
                showStatus('è¯·è¾“å…¥å¯è§†åŒ–éœ€æ±‚', 'error');
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            btnText.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
            showStatus('ğŸ”„ æ­£åœ¨ç”Ÿæˆå¯è§†åŒ–ï¼Œè¯·ç¨å€™...', 'loading');

            try {
                console.log('å‘é€è¯·æ±‚åˆ°åç«¯:', prompt);

                const response = await fetch('http://localhost:8000/resolve_or_generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        vizType: 'auto',
                        complexity: 'ä¸­ç­‰',
                        params: {}
                    })
                });

                console.log('æ”¶åˆ°å“åº”:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                currentResult = await response.json();
                console.log('å“åº”æ•°æ®:', currentResult);

                if (currentResult.success) {
                    showStatus('âœ… å¯è§†åŒ–ç”ŸæˆæˆåŠŸï¼', 'success');
                    displayResult(currentResult);
                } else {
                    showStatus(`âŒ ç”Ÿæˆå¤±è´¥: ${currentResult.message}`, 'error');
                }
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                showStatus(`âŒ é”™è¯¯: ${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                btnText.innerHTML = 'ğŸš€ ç”Ÿæˆå¯è§†åŒ–';
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function displayResult(result) {
            const resultSection = document.getElementById('resultSection');
            const resultInfo = document.getElementById('resultInfo');
            const debugInfo = document.getElementById('debugInfo');

            // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
            resultInfo.innerHTML = `
                <p><strong>å¯è§†åŒ–ID:</strong> ${result.visualizationId}</p>
                <p><strong>æ¶ˆæ¯:</strong> ${result.message}</p>
                <p><strong>æœ‰HTMLå†…å®¹:</strong> ${result.htmlContent ? 'æ˜¯' : 'å¦'}</p>
                <p><strong>HTMLå†…å®¹é•¿åº¦:</strong> ${result.htmlContent ? result.htmlContent.length : 0} å­—ç¬¦</p>
                ${result.config ? `<p><strong>é…ç½®:</strong> <pre>${JSON.stringify(result.config, null, 2)}</pre></p>` : ''}
            `;

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            debugInfo.textContent = JSON.stringify({
                success: result.success,
                hasHtmlContent: !!result.htmlContent,
                htmlLength: result.htmlContent ? result.htmlContent.length : 0,
                config: result.config,
                relatedTemplatesCount: result.relatedTemplates ? result.relatedTemplates.length : 0
            }, null, 2);

            // åœ¨iframeä¸­é¢„è§ˆå¯è§†åŒ–
            if (result.htmlContent) {
                const previewFrame = document.getElementById('previewFrame');
                previewFrame.srcdoc = result.htmlContent;
            }

            resultSection.style.display = 'block';
        }

        function openInNewWindow() {
            if (!currentResult || !currentResult.htmlContent) {
                showStatus('æ²¡æœ‰å¯ç”¨çš„å¯è§†åŒ–å†…å®¹', 'error');
                return;
            }

            try {
                const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');

                if (newWindow) {
                    newWindow.document.write(currentResult.htmlContent);
                    newWindow.document.close();
                    newWindow.focus();
                } else {
                    showStatus('âŒ æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·å…è®¸å¼¹çª—', 'error');
                }
            } catch (error) {
                console.error('æ‰“å¼€æ–°çª—å£å¤±è´¥:', error);
                showStatus('âŒ æ‰“å¼€æ–°çª—å£å¤±è´¥', 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥åç«¯è¿æ¥
            fetch('http://localhost:8000/health')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'healthy') {
                        console.log('âœ… åç«¯æœåŠ¡è¿æ¥æ­£å¸¸');
                    }
                })
                .catch(error => {
                    console.error('åç«¯è¿æ¥å¤±è´¥:', error);
                    showStatus('âš ï¸ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼Œè¯·ç¡®ä¿åç«¯æ­£åœ¨è¿è¡Œ', 'error');
                });
        });
    </script>
</body>
</html>